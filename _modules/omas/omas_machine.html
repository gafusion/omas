
<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>omas.omas_machine &#8212; OMAS</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sphinx.css?v=49fa7461" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          <!-- OMAS-->
        </a>
        <!-- <span class="navbar-text navbar-version pull-left"><b></b></span> -->
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../how.html">Concept</a></li>
                <li><a href="../../auto_examples/index.html">Examples</a></li>
                <li><a href="../../install.html">Installation</a></li>
                <li><a href="../../iter.html">ITER</a></li>
                <li><a href="../../omfit.html">OMFIT</a></li>
                <li><a href="../../schema.html">Data schema</a></li>
                <li><a href="../../code.html">API</a></li>
            
            
              
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">In this page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>
           <!-- 
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
           -->
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for omas.omas_machine</h1><div class="highlight"><pre>
<span></span><span class="c1"># https://confluence.iter.org/display/IMP/UDA+data+mapping+tutorial</span>

<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">omas.omas_utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">omas.omas_core</span> <span class="kn">import</span> <span class="n">ODS</span><span class="p">,</span> <span class="n">dynamic_ODS</span><span class="p">,</span> <span class="n">omas_environment</span><span class="p">,</span> <span class="n">omas_info_node</span><span class="p">,</span> <span class="n">imas_json_dir</span><span class="p">,</span> <span class="n">omas_rcparams</span>
<span class="kn">from</span> <span class="nn">omas.omas_physics</span> <span class="kn">import</span> <span class="n">cocos_signals</span>
<span class="kn">from</span> <span class="nn">omas.machine_mappings</span> <span class="kn">import</span> <span class="n">d3d</span><span class="p">,</span> <span class="n">nstx</span><span class="p">,</span> <span class="n">nstxu</span><span class="p">,</span> <span class="n">east</span>
<span class="kn">from</span> <span class="nn">omas.machine_mappings.d3d</span> <span class="kn">import</span> <span class="n">__regression_arguments__</span>
<span class="kn">from</span> <span class="nn">omas.utilities.machine_mapping_decorator</span> <span class="kn">import</span> <span class="n">machine_mapping_function</span>
<span class="kn">from</span> <span class="nn">omas.utilities.omas_mds</span> <span class="kn">import</span> <span class="n">mdsvalue</span><span class="p">,</span> <span class="n">check_for_pulse_id</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">MDSplus.connection</span> <span class="kn">import</span> <span class="n">MdsIpException</span>
    <span class="kn">from</span> <span class="nn">MDSplus.mdsExceptions</span> <span class="kn">import</span> <span class="n">TreeNODATA</span><span class="p">,</span> <span class="n">TreeNNF</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">omas.machine_mappings</span> <span class="kn">import</span> <span class="n">mast</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;machine_expression_types&#39;</span><span class="p">,</span>
    <span class="s1">&#39;machines&#39;</span><span class="p">,</span>
    <span class="s1">&#39;machine_mappings&#39;</span><span class="p">,</span>
    <span class="s1">&#39;load_omas_machine&#39;</span><span class="p">,</span>
    <span class="s1">&#39;test_machine_mapping_functions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;reload_machine_mappings&#39;</span>
<span class="p">]</span>

<span class="n">machine_expression_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;VALUE&#39;</span><span class="p">,</span> <span class="s1">&#39;EVAL&#39;</span><span class="p">,</span> <span class="s1">&#39;ENVIRON&#39;</span><span class="p">,</span> <span class="s1">&#39;PYTHON&#39;</span><span class="p">,</span> <span class="s1">&#39;TDI&#39;</span><span class="p">,</span> <span class="s1">&#39;eval2TDI&#39;</span><span class="p">]</span>

<span class="n">_url_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">omas_rcparams</span><span class="p">[</span><span class="s1">&#39;tmp_omas_dir&#39;</span><span class="p">],</span> <span class="s1">&#39;machine_mappings&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{branch}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;omas_machine_mappings_url_</span><span class="si">{branch}</span><span class="s1">&#39;</span><span class="p">])</span>


<span class="c1"># ===================</span>
<span class="c1"># mapping engine</span>
<span class="c1"># ===================</span>


<span class="k">def</span> <span class="nf">python_tdi_namespace</span><span class="p">(</span><span class="n">branch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the namespace of the python_tdi.py file</span>

<span class="sd">    :param branch: remote branch to load</span>

<span class="sd">    :return: namespace</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># return cached python tdi function namespace</span>
    <span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">_python_tdi_namespace</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_python_tdi_namespace</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
    <span class="n">_python_tdi_namespace</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># get local mapping functions</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">branch</span><span class="p">:</span>
        <span class="n">exec</span><span class="p">(</span><span class="s1">&#39;from omas.machine_mappings.python_tdi import *&#39;</span><span class="p">,</span> <span class="n">_python_tdi_namespace</span><span class="p">[</span><span class="n">branch</span><span class="p">])</span>

    <span class="c1"># get mapping functions from GitHub</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">printd</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;omas python tdi mappings from branch: `</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s1">`&#39;</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;machine&#39;</span><span class="p">)</span>

        <span class="c1"># make sure remote branch is transfered</span>
        <span class="n">machines</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>

        <span class="c1"># import from temporary directory</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="n">_url_dir</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">dir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;..&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">dir</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;..&#39;</span><span class="p">)</span>

        <span class="n">exec</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;from omas_machine_mappings_url_</span><span class="si">{</span><span class="n">branch</span><span class="si">}</span><span class="s1">.python_tdi import *&#39;</span><span class="p">,</span> <span class="n">_python_tdi_namespace</span><span class="p">[</span><span class="n">branch</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">_python_tdi_namespace</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">remove_nans</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Behavior of Nan filter undefined for scalar nan values&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">machine_to_omas</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">pulse</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{},</span> <span class="n">branch</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">user_machine_mappings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Routine to convert machine data to ODS</span>

<span class="sd">    :param ods: input ODS to populate</span>

<span class="sd">    :param machine: machine name</span>

<span class="sd">    :param pulse: pulse number</span>

<span class="sd">    :param location: ODS location to be populated</span>

<span class="sd">    :param options: dictionary with options to use when loading the data</span>

<span class="sd">    :param branch: load machine mappings and mapping functions from a specific GitHub branch</span>

<span class="sd">    :param user_mappings: allow specification of external mappings</span>

<span class="sd">    :param cache: if cache is a dictionary, this will be used to establish a cash</span>

<span class="sd">    :return: updated ODS and data before being assigned to the ODS</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pulse</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pulse</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">user_machine_mappings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_machine_mappings</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">location</span> <span class="o">=</span> <span class="n">l2o</span><span class="p">(</span><span class="n">p2l</span><span class="p">(</span><span class="n">location</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">branch</span> <span class="ow">in</span> <span class="p">[</span><span class="n">branch</span><span class="p">,</span> <span class="s1">&#39;master&#39;</span><span class="p">]:</span>
        <span class="n">mappings</span> <span class="o">=</span> <span class="n">machine_mappings</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">user_machine_mappings</span><span class="p">)</span>
        <span class="n">options_with_defaults</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__options__&#39;</span><span class="p">])</span>
        <span class="n">options_with_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="n">options_with_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;machine&#39;</span><span class="p">:</span> <span class="n">machine</span><span class="p">,</span> <span class="s1">&#39;pulse&#39;</span><span class="p">:</span> <span class="n">pulse</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">location</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">location</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.*&quot;</span><span class="p">):</span> <span class="c1"># location = &quot;core_profiles.*&quot;</span>
                <span class="n">mapped</span> <span class="o">=</span> <span class="n">mappings</span><span class="p">[</span><span class="n">location</span><span class="p">]</span>
            <span class="k">break</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">branch</span> <span class="o">==</span> <span class="s1">&#39;master&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load </span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2"> from head. Attempting to resolve using the master branch.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error was:&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="n">idm</span> <span class="o">=</span> <span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
    <span class="n">failed_locations</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">location</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.*&quot;</span><span class="p">):</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.*&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resolve_mapped</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">pulse</span><span class="p">,</span> <span class="n">mappings</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">idm</span><span class="p">,</span> <span class="n">options_with_defaults</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">TreeNODATA</span><span class="p">,</span> <span class="n">MdsIpException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;eval2TDI&quot;</span><span class="p">):</span>
                        <span class="n">failed_locations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">eval2TDI</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">failed_locations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">TDI</span>
                <span class="k">except</span> <span class="n">TreeNNF</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">failed_locations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">TDI</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;equilibrium.time_slice.:.constraints.j_tor.:.measured&#39;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_locations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">yaml</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to load the following keys: &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">failed_locations</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;failed_locs&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">failed_locs_file</span><span class="p">:</span>
                <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">failed_locations</span><span class="p">,</span> <span class="n">failed_locs_file</span><span class="p">,</span> <span class="n">yaml</span><span class="o">.</span><span class="n">CDumper</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ods</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">resolve_mapped</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">pulse</span><span class="p">,</span>  <span class="n">mappings</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">idm</span><span class="p">,</span> <span class="n">options_with_defaults</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">resolve_mapped</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">pulse</span><span class="p">,</span>  <span class="n">mappings</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">idm</span><span class="p">,</span> <span class="n">options_with_defaults</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Routine to resolve a mapping</span>

<span class="sd">    :param ods: input ODS to populate</span>

<span class="sd">    :param machine: machine name</span>

<span class="sd">    :param pulse: pulse number</span>

<span class="sd">    :param mappings: Dictionary of available mappings</span>

<span class="sd">    :param location: ODS location to be resolved</span>

<span class="sd">    :param idm: Tuple with machine and branch</span>

<span class="sd">    :param options_with_defaults: dictionary with options to use when loading the data including default settings</span>

<span class="sd">    :param branch: load machine mappings and mapping functions from a specific GitHub branch</span>

<span class="sd">    :param cache: if cache is a dictionary, this will be used to establish a cash</span>

<span class="sd">    :return: updated ODS and data before being assigned to the ODS</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mapped</span> <span class="o">=</span> <span class="n">mappings</span><span class="p">[</span><span class="n">location</span><span class="p">]</span>
    <span class="c1"># cocosio</span>
    <span class="n">cocosio</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;COCOSIO&#39;</span> <span class="ow">in</span> <span class="n">mapped</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;COCOSIO&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">cocosio</span> <span class="o">=</span> <span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;COCOSIO&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;COCOSIO_PYTHON&#39;</span> <span class="ow">in</span> <span class="n">mapped</span><span class="p">:</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;COCOSIO_PYTHON&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">options_with_defaults</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
            <span class="n">cocosio</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">call</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">namespace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_namespace_mappings</span><span class="p">[</span><span class="n">idm</span><span class="p">])</span>
            <span class="n">namespace</span><span class="p">[</span><span class="s1">&#39;__file__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">machines</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">branch</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">machines</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">branch</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">)</span>
            <span class="n">cocosio</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">cache</span><span class="p">[</span><span class="n">call</span><span class="p">]</span> <span class="o">=</span> <span class="n">cocosio</span>
    <span class="k">elif</span> <span class="s1">&#39;COCOSIO_TDI&#39;</span> <span class="ow">in</span> <span class="n">mapped</span><span class="p">:</span>
        <span class="n">TDI</span> <span class="o">=</span> <span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;COCOSIO_TDI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">options_with_defaults</span><span class="p">)</span>
        <span class="n">treename</span> <span class="o">=</span> <span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;treename&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">options_with_defaults</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;treename&#39;</span> <span class="ow">in</span> <span class="n">mapped</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">cocosio</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mdsvalue</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">treename</span><span class="p">,</span> <span class="n">pulse</span><span class="p">,</span> <span class="n">TDI</span><span class="p">)</span><span class="o">.</span><span class="n">raw</span><span class="p">())</span>

    <span class="c1"># CONSTANT VALUE</span>
    <span class="k">if</span> <span class="s1">&#39;VALUE&#39;</span> <span class="ow">in</span> <span class="n">mapped</span><span class="p">:</span>
        <span class="n">data0</span> <span class="o">=</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;VALUE&#39;</span><span class="p">]</span>

    <span class="c1"># EVAL</span>
    <span class="k">elif</span> <span class="s1">&#39;EVAL&#39;</span> <span class="ow">in</span> <span class="n">mapped</span><span class="p">:</span>
        <span class="n">data0</span> <span class="o">=</span> <span class="n">data</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;EVAL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">options_with_defaults</span><span class="p">),</span> <span class="n">_namespace_mappings</span><span class="p">[</span><span class="n">idm</span><span class="p">])</span>

    <span class="c1"># ENVIRONMENTAL VARIABLE</span>
    <span class="k">elif</span> <span class="s1">&#39;ENVIRON&#39;</span> <span class="ow">in</span> <span class="n">mapped</span><span class="p">:</span>
        <span class="n">data0</span> <span class="o">=</span> <span class="n">data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;ENVIRON&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">options_with_defaults</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Environmental variable </span><span class="si">{</span><span class="n">mapped</span><span class="p">[</span><span class="s2">&quot;ENVIRON&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">options_with_defaults</span><span class="p">)</span><span class="si">}</span><span class="s1"> is not defined&#39;</span>
            <span class="p">)</span>

    <span class="c1"># PYTHON</span>
    <span class="k">elif</span> <span class="s1">&#39;PYTHON&#39;</span> <span class="ow">in</span> <span class="n">mapped</span><span class="p">:</span>
        <span class="n">call</span> <span class="o">=</span> <span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;PYTHON&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">options_with_defaults</span><span class="p">)</span>
        <span class="c1"># python functions tend to set multiple locations at once</span>
        <span class="c1"># it is thus very beneficial to cache that</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="n">call</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
            <span class="n">ods</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">call</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">namespace</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">namespace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_namespace_mappings</span><span class="p">[</span><span class="n">idm</span><span class="p">])</span>
            <span class="n">namespace</span><span class="p">[</span><span class="s1">&#39;ods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span>
            <span class="n">namespace</span><span class="p">[</span><span class="s1">&#39;__file__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">machines</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">branch</span><span class="p">)[:</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span>
            <span class="n">printd</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calling `</span><span class="si">{</span><span class="n">call</span><span class="si">}</span><span class="s2">` in </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">namespace</span><span class="p">[</span><span class="s1">&#39;__file__&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;machine&#39;</span><span class="p">)</span>
            <span class="c1"># Add the callback for mapping updates</span>
            <span class="c1"># By supplyinh the function to the decorator we avoid a ringinclusion</span>
            <span class="n">call_w_update_mapping</span> <span class="o">=</span> <span class="n">call</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;, update_callback=update_mapping)&quot;</span>
            <span class="n">exec</span><span class="p">(</span> <span class="n">machine</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">call_w_update_mapping</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">cache</span><span class="p">[</span><span class="n">call</span><span class="p">]</span> <span class="o">=</span> <span class="n">ods</span>
        <span class="k">if</span> <span class="n">location</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="n">u2n</span><span class="p">(</span><span class="n">location</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)])),</span>
                <span class="p">{</span><span class="s1">&#39;raw_data&#39;</span><span class="p">:</span> <span class="n">ods</span><span class="p">,</span> <span class="s1">&#39;processed_data&#39;</span><span class="p">:</span> <span class="n">ods</span><span class="p">,</span> <span class="s1">&#39;cocosio&#39;</span><span class="p">:</span> <span class="n">cocosio</span><span class="p">,</span> <span class="s1">&#39;branch&#39;</span><span class="p">:</span> <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__branch__&#39;</span><span class="p">]},</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ods</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;raw_data&#39;</span><span class="p">:</span> <span class="n">ods</span><span class="p">,</span> <span class="s1">&#39;processed_data&#39;</span><span class="p">:</span> <span class="n">ods</span><span class="p">,</span> <span class="s1">&#39;cocosio&#39;</span><span class="p">:</span> <span class="n">cocosio</span><span class="p">,</span> <span class="s1">&#39;branch&#39;</span><span class="p">:</span> <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__branch__&#39;</span><span class="p">]}</span>

    <span class="c1"># MDSplus</span>
    <span class="k">elif</span> <span class="s1">&#39;TDI&#39;</span> <span class="ow">in</span> <span class="n">mapped</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;treename&#39;</span> <span class="ow">in</span>  <span class="n">mapped</span><span class="p">:</span>
                <span class="n">pulse_id</span> <span class="o">=</span> <span class="n">check_for_pulse_id</span><span class="p">(</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;treename&#39;</span><span class="p">],</span> <span class="n">options_with_defaults</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pulse_id</span> <span class="o">=</span> <span class="n">pulse</span>
            <span class="n">TDI</span> <span class="o">=</span> <span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;TDI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">options_with_defaults</span><span class="p">)</span>
            <span class="n">treename</span> <span class="o">=</span> <span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;treename&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">options_with_defaults</span><span class="p">)</span> <span class="k">if</span> <span class="s1">&#39;treename&#39;</span> <span class="ow">in</span> <span class="n">mapped</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">data0</span> <span class="o">=</span> <span class="n">data</span> <span class="o">=</span> <span class="n">mdsvalue</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">treename</span><span class="p">,</span> <span class="n">pulse_id</span><span class="p">,</span> <span class="n">TDI</span><span class="p">)</span><span class="o">.</span><span class="n">raw</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data is None&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">printe</span><span class="p">(</span><span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;TDI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">options_with_defaults</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="s2">&quot;eval2TDI&quot;</span> <span class="ow">in</span> <span class="n">mapped</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">eval2TDI</span> <span class="o">=</span> <span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;eval2TDI&#39;</span><span class="p">]</span>
            <span class="n">e</span><span class="o">.</span><span class="n">TDI</span> <span class="o">=</span> <span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;TDI&#39;</span><span class="p">]</span>
            <span class="k">raise</span> <span class="n">e</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not fetch data for </span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">. Must define one of </span><span class="si">{</span><span class="n">machine_expression_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># handle size definition for array of structures</span>
    <span class="k">if</span> <span class="n">location</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="p">{</span><span class="s1">&#39;raw_data&#39;</span><span class="p">:</span> <span class="n">data0</span><span class="p">,</span> <span class="s1">&#39;processed_data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;cocosio&#39;</span><span class="p">:</span> <span class="n">cocosio</span><span class="p">,</span> <span class="s1">&#39;branch&#39;</span><span class="p">:</span> <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__branch__&#39;</span><span class="p">]}</span>

    <span class="c1"># transpose manipulation</span>
    <span class="k">if</span> <span class="n">mapped</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TRANSPOSE&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;TRANSPOSE&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">data</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mapped</span><span class="p">[</span><span class="s1">&#39;TRANSPOSE&#39;</span><span class="p">])</span>

    <span class="c1"># transpose filter</span>
    <span class="n">nanfilter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">mapped</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;NANFILTER&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1">#lambda x: x[~numpy.isnan(x)]</span>
        <span class="n">nanfilter</span> <span class="o">=</span> <span class="n">remove_nans</span>

    <span class="c1"># assign data to ODS</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">):</span>
        <span class="n">ods</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">cocosio</span><span class="o">=</span><span class="n">cocosio</span><span class="p">):</span>
            <span class="n">dsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># size of the data fetched from MDSplus</span>
            <span class="n">csize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapped</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;COORDINATES&#39;</span><span class="p">,</span> <span class="p">[]))</span>  <span class="c1"># number of coordinates</span>
            <span class="n">osize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">mapped</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;COORDINATES&#39;</span><span class="p">,</span> <span class="p">[])</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;1...N&#39;</span><span class="p">])</span>  <span class="c1"># number of named coordinates</span>
            <span class="n">asize</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">csize</span>  <span class="c1"># data size required from MDSplus to make the assignement</span>
            <span class="k">if</span> <span class="n">asize</span> <span class="o">!=</span> <span class="n">dsize</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Experiment data </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> does not fit in `</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">` [</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;:&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">location</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">mapped</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;COORDINATES&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">[]))</span><span class="si">}</span><span class="s2">]&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">dsize</span> <span class="o">-</span> <span class="n">osize</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="s1">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">location</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">ods</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="n">nanfilter</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">range</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span> <span class="n">location</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)]))):</span>
                    <span class="n">ods</span><span class="p">[</span><span class="n">u2n</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">nanfilter</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">ods</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;raw_data&#39;</span><span class="p">:</span> <span class="n">data0</span><span class="p">,</span> <span class="s1">&#39;processed_data&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;cocosio&#39;</span><span class="p">:</span> <span class="n">cocosio</span><span class="p">,</span> <span class="s1">&#39;branch&#39;</span><span class="p">:</span> <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__branch__&#39;</span><span class="p">]}</span>


<span class="n">_machine_mappings</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_namespace_mappings</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_user_machine_mappings</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_python_tdi_namespace</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="machine_mappings">
<a class="viewcode-back" href="../../code/omas.machine_mappings.html#omas.machine_mappings">[docs]</a>
<span class="k">def</span> <span class="nf">machine_mappings</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">user_machine_mappings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_raw_mappings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">raise_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to load the json mapping files (local or remote)</span>
<span class="sd">    Allows for merging external mapping rules defined by users.</span>
<span class="sd">    This function sanity-checks and the mapping file and adds extra info required for mapping</span>

<span class="sd">    :param machine: machine for which to load the mapping files</span>

<span class="sd">    :param branch: GitHub branch from which to load the machine mapping information</span>

<span class="sd">    :param user_machine_mappings: Dictionary of mappings that users can pass to this function to temporarily use their mappings</span>
<span class="sd">                                  (useful for development and testinig purposes)</span>

<span class="sd">    :param return_raw_mappings: Return mappings without following __include__ statements nor resoliving `eval2TDI` directives</span>

<span class="sd">    :param raise_errors: raise errors or simply print warnings if something isn&#39;t right</span>

<span class="sd">    :return: dictionary with mapping transformations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">user_machine_mappings</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">user_machine_mappings</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">idm</span> <span class="o">=</span> <span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span>
        <span class="n">return_raw_mappings</span>
        <span class="ow">or</span> <span class="n">idm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_machine_mappings</span>
        <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="n">_user_machine_mappings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">user_machine_mappings</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="n">_machine_mappings</span><span class="p">[</span><span class="n">idm</span><span class="p">][</span><span class="s1">&#39;__user_machine_mappings__&#39;</span><span class="p">]</span>
    <span class="p">):</span>

        <span class="c1"># figure out mapping file</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">machines</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>

        <span class="c1"># load mappings from file following __include__ directives</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span><span class="p">:</span>
            <span class="n">top</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">top</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error reading </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">_excp</span><span class="p">))</span>
        <span class="n">go_deep</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;__cocos_rules__&#39;</span><span class="p">,</span> <span class="s1">&#39;__options__&#39;</span><span class="p">]</span>
        <span class="n">mappings</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">go_deep</span><span class="p">}</span>
        <span class="n">mappings</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;__include__&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;_common&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_raw_mappings</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">top</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__include__&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;_common&#39;</span><span class="p">]):</span>
                <span class="n">include_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s1">.json&#39;</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">include_filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sub</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error reading </span><span class="si">{</span><span class="n">include_filename</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">_excp</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">go_deep</span><span class="p">:</span>
                        <span class="n">mappings</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">{}))</span>
                        <span class="k">del</span> <span class="n">sub</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sub</span><span class="p">:</span>
                        <span class="n">sub</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;__include__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item</span>
                    <span class="n">mappings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">go_deep</span><span class="p">:</span>
                <span class="n">mappings</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="p">{}))</span>
                <span class="k">del</span> <span class="n">top</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">mappings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">top</span><span class="p">)</span>

        <span class="c1"># merge mappings and user_machine_mappings</span>
        <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__user_machine_mappings__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">umap</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_user_machine_mappings</span><span class="p">,</span> <span class="n">user_machine_mappings</span><span class="p">]:</span>
            <span class="n">umap</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">umap</span><span class="p">)</span>
            <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__user_machine_mappings__&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">umap</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;__cocos_rules__&#39;</span><span class="p">,</span> <span class="s1">&#39;__options__&#39;</span><span class="p">]:</span>
                <span class="n">mappings</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">umap</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="n">mappings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">umap</span><span class="p">)</span>

        <span class="c1"># return raw json mappings if so requested</span>
        <span class="k">if</span> <span class="n">return_raw_mappings</span><span class="p">:</span>
            <span class="n">mappings</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__user_machine_mappings__&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mappings</span>

        <span class="c1"># ============= below this line we process the raw mappings =============</span>

        <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__filename__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__branch__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">branch</span>

        <span class="c1"># read the machine specific python mapping functions</span>
        <span class="n">_namespace_mappings</span><span class="p">[</span><span class="n">idm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">exec</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">_namespace_mappings</span><span class="p">[</span><span class="n">idm</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">_excp</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;.py&#39;</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">_excp</span><span class="p">))</span>

        <span class="c1"># generate TDI for cocos_rules</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__cocos_rules__&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;eval2TDI&#39;</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__cocos_rules__&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__cocos_rules__&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s1">&#39;TDI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span>
                        <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__cocos_rules__&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s1">&#39;eval2TDI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">python_tdi_namespace</span><span class="p">(</span><span class="n">branch</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error evaluating eval2TDI in [&#39;__cocos_rules__&#39;][</span><span class="si">{</span><span class="n">item</span><span class="si">!r}</span><span class="s2">]: </span><span class="si">{</span><span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__cocos_rules__&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s1">&#39;eval2TDI&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{</span><span class="n">_excp</span><span class="si">!r}</span><span class="s2">&quot;</span>
                    <span class="k">if</span> <span class="n">raise_errors</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">_excp</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">printe</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="c1"># generate TDI and sanity check mappings</span>
        <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">:</span>
            <span class="c1"># sanity check format</span>
            <span class="k">if</span> <span class="n">l2o</span><span class="p">(</span><span class="n">p2l</span><span class="p">(</span><span class="n">location</span><span class="p">))</span> <span class="o">!=</span> <span class="n">location</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s1"> mapping should be specified as </span><span class="si">{</span><span class="n">l2o</span><span class="p">(</span><span class="n">p2l</span><span class="p">(</span><span class="n">location</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># generate DTI functions based on eval2DTI</span>
            <span class="k">if</span> <span class="s1">&#39;eval2TDI&#39;</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">[</span><span class="n">location</span><span class="p">]:</span>
                <span class="n">mappings</span><span class="p">[</span><span class="n">location</span><span class="p">][</span><span class="s1">&#39;TDI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">mappings</span><span class="p">[</span><span class="n">location</span><span class="p">][</span><span class="s1">&#39;eval2TDI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">),</span> <span class="n">python_tdi_namespace</span><span class="p">(</span><span class="n">branch</span><span class="p">))</span>

            <span class="c1"># make sure required coordinates info are present in the mapping</span>
            <span class="c1"># this COORDINATES info is also used later to assing data in the ODS</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">omas_info_node</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;coordinates&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
                <span class="n">mappings</span><span class="p">[</span><span class="n">location</span><span class="p">][</span><span class="s1">&#39;COORDINATES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">i2o</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;coordinates&#39;</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">coordinate</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">[</span><span class="n">location</span><span class="p">][</span><span class="s1">&#39;COORDINATES&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="s1">&#39;1...&#39;</span> <span class="ow">in</span> <span class="n">coordinate</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">coordinate</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">:</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Missing coordinate </span><span class="si">{</span><span class="n">coordinate</span><span class="si">}</span><span class="s1"> for </span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s1">&#39;</span>
                        <span class="k">if</span> <span class="n">raise_errors</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">printe</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

            <span class="c1"># add cocos transformation info</span>
            <span class="n">has_COCOS</span> <span class="o">=</span> <span class="n">o2u</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cocos_signals</span> <span class="ow">and</span> <span class="n">cocos_signals</span><span class="p">[</span><span class="n">o2u</span><span class="p">(</span><span class="n">location</span><span class="p">)]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;COCOSIO&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="ow">and</span> <span class="n">has_COCOS</span><span class="p">:</span>
                <span class="n">cocos_defined</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">cocos_rule</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__cocos_rules__&#39;</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">exp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;TDI&#39;</span><span class="p">,</span> <span class="s1">&#39;PYTHON&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">exp</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">cocos_rule</span><span class="p">,</span> <span class="n">mappings</span><span class="p">[</span><span class="n">location</span><span class="p">][</span><span class="n">exp</span><span class="p">]):</span>
                            <span class="k">for</span> <span class="n">cocos_exp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PYTHON&#39;</span><span class="p">,</span> <span class="s1">&#39;TDI&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">cocos_exp</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__cocos_rules__&#39;</span><span class="p">][</span><span class="n">cocos_rule</span><span class="p">]:</span>
                                    <span class="n">mappings</span><span class="p">[</span><span class="n">location</span><span class="p">][</span><span class="s1">&#39;COCOSIO_&#39;</span> <span class="o">+</span> <span class="n">cocos_exp</span><span class="p">]</span> <span class="o">=</span> <span class="n">mappings</span><span class="p">[</span><span class="s1">&#39;__cocos_rules__&#39;</span><span class="p">][</span><span class="n">cocos_rule</span><span class="p">][</span><span class="n">cocos_exp</span><span class="p">]</span>
                                    <span class="n">cocos_defined</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cocos_defined</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s1"> must have COCOSIO specified&#39;</span>
                    <span class="k">if</span> <span class="n">raise_errors</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">printe</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;COCOSIO&#39;</span> <span class="ow">in</span> <span class="n">mappings</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_COCOS</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s1"> should not have COCOS specified, or COCOS definition should be added to omas_cocos file&#39;</span>
                <span class="k">if</span> <span class="n">raise_errors</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">printe</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="c1"># cache</span>
        <span class="n">_machine_mappings</span><span class="p">[</span><span class="n">idm</span><span class="p">]</span> <span class="o">=</span> <span class="n">mappings</span>

    <span class="k">return</span> <span class="n">_machine_mappings</span><span class="p">[</span><span class="n">idm</span><span class="p">]</span></div>



<span class="k">def</span> <span class="nf">reload_machine_mappings</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flushes internal caches of machine mappings.</span>
<span class="sd">    This will force the mapping files to be re-read when they are first accessed.</span>

<span class="sd">    :param verbose: print to screen when mappings are reloaded</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># reset machine mapping caches</span>
    <span class="k">for</span> <span class="n">cache</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_machine_mappings</span><span class="p">,</span> <span class="n">_namespace_mappings</span><span class="p">,</span> <span class="n">_python_tdi_namespace</span><span class="p">,</span> <span class="n">_machines_dict</span><span class="p">,</span> <span class="n">_user_machine_mappings</span><span class="p">]:</span>
        <span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># in case users did a `from omas.machine_mappings import ...`</span>
    <span class="k">for</span> <span class="n">mod</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mod</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;omas.machine_mappings&#39;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reloaded OMAS machine mapping info&#39;</span><span class="p">)</span>


<span class="c1"># ===================</span>
<span class="c1"># list machines and update machine files</span>
<span class="c1"># ===================</span>
<span class="n">_machines_dict</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="machines">
<a class="viewcode-back" href="../../code/omas.machines.html#omas.machines">[docs]</a>
<span class="k">def</span> <span class="nf">machines</span><span class="p">(</span><span class="n">machine</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to get machines that have their mappings defined</span>
<span class="sd">    This function takes care of remote transfer the needed files (both .json and .py) if a remote branch is requested</span>

<span class="sd">    :param machine: string with machine name or None</span>

<span class="sd">    :param branch: GitHub branch from which to load the machine mapping information</span>

<span class="sd">    :return: if `machine==None` returns dictionary with list of machines and their json mapping files</span>
<span class="sd">             if `machine` is a string, then returns json mapping filename</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># return cached results</span>
    <span class="k">if</span> <span class="n">branch</span> <span class="ow">in</span> <span class="n">_machines_dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">machine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_machines_dict</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">_machines_dict</span><span class="p">[</span><span class="n">branch</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">_machines_dict</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">machine</span><span class="p">]</span>

    <span class="c1"># local mappings</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">branch</span><span class="p">:</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="n">omas_dir</span> <span class="o">+</span> <span class="s1">&#39;machine_mappings&#39;</span>

    <span class="c1"># remote mappings from GitHub</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">branch</span> <span class="o">==</span> <span class="s1">&#39;master&#39;</span><span class="p">:</span>
            <span class="n">svn_branch</span> <span class="o">=</span> <span class="s1">&#39;trunk&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">svn_branch</span> <span class="o">=</span> <span class="s1">&#39;branches/&#39;</span> <span class="o">+</span> <span class="n">branch</span>

        <span class="nb">dir</span> <span class="o">=</span> <span class="n">_url_dir</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">svn export --force https://github.com/gafusion/omas.git/</span><span class="si">{</span><span class="n">svn_branch</span><span class="si">}</span><span class="s1">/omas/machine_mappings/ </span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span>
<span class="s1">&#39;&#39;&#39;</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># go through machine files</span>
    <span class="n">_machines_dict</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s1">/*.json&#39;</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
            <span class="n">_machines_dict</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c1"># return list of supported machines</span>
    <span class="k">if</span> <span class="n">machine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_machines_dict</span><span class="p">[</span><span class="n">branch</span><span class="p">]</span>

    <span class="c1"># return filename with mappings for this machine</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">machine</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_machines_dict</span><span class="p">[</span><span class="n">branch</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Machine mapping file `</span><span class="si">{</span><span class="n">machine</span><span class="si">}</span><span class="s1">.json` does not exist&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_machines_dict</span><span class="p">[</span><span class="n">branch</span><span class="p">][</span><span class="n">machine</span><span class="p">]</span></div>



<span class="k">def</span> <span class="nf">update_mapping</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">cocosio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_path</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility function that updates the local mapping file of a given machine with the mapping info of a given location</span>

<span class="sd">    :param machine: machine name</span>

<span class="sd">    :param location: ODS location to be updated</span>

<span class="sd">    :param value: dictionary with mapping info</span>

<span class="sd">    :param cocosio: if integer and location has COCOS transform it adds it</span>

<span class="sd">    :param update_path: use the same value for the arrays of structures leading to this location</span>

<span class="sd">    :return: dictionary with updated raw mappings</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ulocation</span> <span class="o">=</span> <span class="n">l2u</span><span class="p">(</span><span class="n">p2l</span><span class="p">(</span><span class="n">location</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;COORDINATES&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;COORDINATES&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">cocosio</span> <span class="ow">and</span> <span class="n">ulocation</span> <span class="ow">in</span> <span class="n">cocos_signals</span> <span class="ow">and</span> <span class="n">cocos_signals</span><span class="p">[</span><span class="n">ulocation</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cocosio</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="n">value</span><span class="p">[</span><span class="s1">&#39;COCOSIO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cocosio</span>

    <span class="c1"># operate on the raw mappings</span>
    <span class="n">new_raw_mappings</span> <span class="o">=</span> <span class="n">machine_mappings</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">return_raw_mappings</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># assign default options</span>
    <span class="n">updated_defaults</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">default_options</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">default_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_raw_mappings</span><span class="p">[</span><span class="s1">&#39;__options__&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">,</span> <span class="s1">&#39;pulse&#39;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">]:</span>
                <span class="n">new_raw_mappings</span><span class="p">[</span><span class="s1">&#39;__options__&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_options</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                <span class="n">updated_defaults</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># if the definition is the same do not do anythinig</span>
    <span class="c1"># use `sorted(repr(dict))` as a cheap recursive dictionary diff</span>
    <span class="c1"># sorted is needed because starting with Python3.7 dictionaries are sorted and we cannot guarantee that value and mappings have same sorting</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">updated_defaults</span> <span class="ow">and</span> <span class="n">ulocation</span> <span class="ow">in</span> <span class="n">new_raw_mappings</span> <span class="ow">and</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">==</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">new_raw_mappings</span><span class="p">[</span><span class="n">ulocation</span><span class="p">])):</span>
        <span class="k">return</span> <span class="n">new_raw_mappings</span>

    <span class="c1"># add definition for new/updated location and update the .json file</span>
    <span class="n">new_raw_mappings</span><span class="p">[</span><span class="n">ulocation</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">machines</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">new_raw_mappings</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">),</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Updated </span><span class="si">{</span><span class="n">machine</span><span class="si">}</span><span class="s1"> mapping for </span><span class="si">{</span><span class="n">ulocation</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># add the same call for arrays of structures going upstream</span>
    <span class="k">if</span> <span class="n">update_path</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">uloc</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ulocation</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[:</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ulocation</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]:</span>
            <span class="k">if</span> <span class="n">uloc</span> <span class="ow">in</span> <span class="n">new_raw_mappings</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;COCOSIO&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">del</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;COCOSIO&#39;</span><span class="p">]</span>
            <span class="n">update_mapping</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">uloc</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">update_path</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_raw_mappings</span>



<div class="viewcode-block" id="test_machine_mapping_functions">
<a class="viewcode-back" href="../../code/omas.test_machine_mapping_functions.html#omas.test_machine_mapping_functions">[docs]</a>
<span class="k">def</span> <span class="nf">test_machine_mapping_functions</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">__all__</span><span class="p">,</span> <span class="n">global_namespace</span><span class="p">,</span> <span class="n">local_namespace</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function used to test python mapping functions</span>

<span class="sd">    :param __all__: list of functionss to test</span>

<span class="sd">    :param namespace: testing namespace</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

    <span class="n">old_OMAS_DEBUG_TOPIC</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;OMAS_DEBUG_TOPIC&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMAS_DEBUG_TOPIC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;machine&#39;</span>

    <span class="c1"># call machine mapping to make sure the json file is properly formatted</span>
    <span class="c1"># machine = os.path.splitext(os.path.split(local_namespace[&#39;__file__&#39;])[1])[0]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sanity check of `</span><span class="si">{</span><span class="n">machine</span><span class="si">}</span><span class="s1">` mapping files: ... &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">machine_mappings</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">raise_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;OK&#39;</span><span class="p">)</span>

    <span class="n">__regression_arguments__</span> <span class="o">=</span> <span class="n">global_namespace</span><span class="p">[</span><span class="s1">&#39;__regression_arguments__&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="n">__all__</span><span class="p">:</span>
            <span class="n">regression_kw</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">__regression_arguments__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span> <span class="o">!=</span> <span class="s1">&#39;__all__&#39;</span><span class="p">}</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">func_name</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">func_name</span><span class="p">)</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">regression_kw</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;=&#39;</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">func_name</span><span class="p">))</span>
            <span class="n">ods</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span> <span class="c1">#consistency_check= not break_schema</span>
            <span class="n">func</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="n">global_namespace</span><span class="p">,</span> <span class="n">local_namespace</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">regression_kw</span><span class="p">[</span><span class="s2">&quot;update_callback&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">update_mapping</span>
                    <span class="n">func</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="o">**</span><span class="n">regression_kw</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;.*missing [0-9]+ required positional argument.*&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">_excp</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="n">_excp</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">_excp</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="o">+</span> <span class="s1">&#39;For testing purposes, make sure to provide default arguments for your mapping functions via the decorator @machine_mapping_function(__regression_arguments__, ...)&#39;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">o2u</span><span class="p">,</span> <span class="n">ods</span><span class="o">.</span><span class="n">flat</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No data assigned to ODS&#39;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">tmp</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="si">}</span><span class="s1">   </span><span class="si">{</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="n">item</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">item</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="si">}</span><span class="s1">   mixed&#39;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">old_OMAS_DEBUG_TOPIC</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMAS_DEBUG_TOPIC&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMAS_DEBUG_TOPIC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_OMAS_DEBUG_TOPIC</span></div>



<span class="c1"># ===================</span>
<span class="c1"># Loading machine data in ODSs</span>
<span class="c1"># ===================</span>
<span class="k">class</span> <span class="nc">dynamic_omas_machine</span><span class="p">(</span><span class="n">dynamic_ODS</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that provides dynamic data loading from machine mappings</span>
<span class="sd">    This class is not to be used by itself, but via the ODS.open() method.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">pulse</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{},</span> <span class="n">branch</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">user_machine_mappings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kw</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;machine&#39;</span><span class="p">:</span> <span class="n">machine</span><span class="p">,</span> <span class="s1">&#39;pulse&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">pulse</span><span class="p">),</span> <span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="n">options</span><span class="p">,</span> <span class="s1">&#39;branch&#39;</span><span class="p">:</span> <span class="n">branch</span><span class="p">,</span> <span class="s1">&#39;user_machine_mappings&#39;</span><span class="p">:</span> <span class="n">user_machine_mappings</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">printd</span><span class="p">(</span><span class="s1">&#39;Dynamic open  </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;dynamic&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">printd</span><span class="p">(</span><span class="s1">&#39;Dynamic close </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;dynamic&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Dynamic link broken: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">o2u</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="n">printd</span><span class="p">(</span><span class="s1">&#39;Dynamic read  </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;dynamic&#39;</span><span class="p">)</span>
            <span class="n">ods</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">machine_to_omas</span><span class="p">(</span>
                <span class="n">ODS</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;pulse&#39;</span><span class="p">],</span>
                <span class="n">o2u</span><span class="p">(</span><span class="n">key</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;options&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;branch&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;user_machine_mappings&#39;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">o2u</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ods</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">o2u</span><span class="p">(</span><span class="n">key</span><span class="p">)],</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">o2u</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">o2u</span><span class="p">(</span><span class="n">key</span><span class="p">)][</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Dynamic link broken: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">ulocation</span> <span class="o">=</span> <span class="n">o2u</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ulocation</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">ulocation</span> <span class="ow">in</span> <span class="n">machine_mappings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;branch&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;user_machine_mappings&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        <span class="n">ulocation</span> <span class="o">=</span> <span class="p">(</span><span class="n">o2u</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ulocation</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">machine_mappings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;branch&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;user_machine_mappings&#39;</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">ulocation</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
                <span class="n">printe</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ulocation</span><span class="si">}</span><span class="s1">: issue:&#39;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">_excp</span><span class="p">))</span>
                <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">convert_int</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ulocation</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">machine_mappings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;branch&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;user_machine_mappings&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ulocation</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ulocation</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please specify number of structures for `</span><span class="si">{</span><span class="n">o2u</span><span class="p">(</span><span class="n">location</span><span class="p">)</span><span class="si">}</span><span class="s2">.:` in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">[</span><span class="s1">&#39;machine&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tmp</span>


<div class="viewcode-block" id="load_omas_machine">
<a class="viewcode-back" href="../../code/omas.load_omas_machine.html#omas.load_omas_machine">[docs]</a>
<span class="k">def</span> <span class="nf">load_omas_machine</span><span class="p">(</span>
    <span class="n">machine</span><span class="p">,</span>
    <span class="n">pulse</span><span class="p">,</span>
    <span class="n">options</span><span class="o">=</span><span class="p">{},</span>
    <span class="n">consistency_check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">imas_version</span><span class="o">=</span><span class="n">omas_rcparams</span><span class="p">[</span><span class="s1">&#39;default_imas_version&#39;</span><span class="p">],</span>
    <span class="bp">cls</span><span class="o">=</span><span class="n">ODS</span><span class="p">,</span>
    <span class="n">branch</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">user_machine_mappings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">printd</span><span class="p">(</span><span class="s1">&#39;Loading from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">machine</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;machine&#39;</span><span class="p">)</span>
    <span class="n">ods</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">imas_version</span><span class="o">=</span><span class="n">imas_version</span><span class="p">,</span> <span class="n">consistency_check</span><span class="o">=</span><span class="n">consistency_check</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="p">[</span><span class="n">location</span> <span class="k">for</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">machine_mappings</span><span class="p">(</span><span class="n">machine</span><span class="p">,</span> <span class="n">branch</span><span class="p">,</span> <span class="n">user_machine_mappings</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">location</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)]:</span>
        <span class="k">if</span> <span class="n">location</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
        <span class="n">machine_to_omas</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">pulse</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">branch</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ods</span></div>

</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2017-2025 O. Meneghini and collaborators.<br/>
      Last updated on Feb 27, 2025.<br/>
    </p>
  </div>
</footer>
  </body>
</html>