
<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>omas.omas_physics &#8212; OMAS</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/bootstrap-sphinx.css?v=49fa7461" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=61a4c737" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-3.4.1/js/bootstrap.min.js"></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          <!-- OMAS-->
        </a>
        <!-- <span class="navbar-text navbar-version pull-left"><b></b></span> -->
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="../../how.html">Concept</a></li>
                <li><a href="../../auto_examples/index.html">Examples</a></li>
                <li><a href="../../install.html">Installation</a></li>
                <li><a href="../../iter.html">ITER</a></li>
                <li><a href="../../omfit.html">OMFIT</a></li>
                <li><a href="../../schema.html">Data schema</a></li>
                <li><a href="../../code.html">API</a></li>
            
            
              
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">In this page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
            
            
            
          </ul>
           <!-- 
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
           -->
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for omas.omas_physics</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;physics-based ODS methods and utilities</span>

<span class="sd">-------</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">RectBivariateSpline</span>
<span class="kn">from</span> <span class="nn">.omas_utils</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.omas_core</span> <span class="kn">import</span> <span class="n">ODS</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">__ods__</span> <span class="o">=</span> <span class="p">[]</span>


<span class="k">def</span> <span class="nf">add_to__ODS__</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    anything wrapped here will be available as a ODS method with name &#39;physics_&#39;+f.__name__</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__ods__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="k">def</span> <span class="nf">add_to__ALL__</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="n">__all__</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="k">def</span> <span class="nf">preprocess_ods</span><span class="p">(</span><span class="o">*</span><span class="n">require</span><span class="p">,</span> <span class="n">require_mode</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;warn_through&#39;</span><span class="p">,</span> <span class="s1">&#39;warn_skip&#39;</span><span class="p">,</span> <span class="s1">&#39;raise&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator function that:</span>
<span class="sd">     * checks that required quantities are there</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_req</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args1</span><span class="p">,</span> <span class="o">**</span><span class="n">kw1</span><span class="p">):</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kw</span> <span class="o">=</span> <span class="n">args_as_kw</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">args1</span><span class="p">,</span> <span class="n">kw1</span><span class="p">)</span>

            <span class="c1"># handle missing required quantities</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">require</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;ods&#39;</span><span class="p">]:</span>
                    <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">):</span>
                <span class="n">txt</span> <span class="o">=</span> <span class="s1">&#39;could not evaluate </span><span class="si">%s</span><span class="s1"> because of missing </span><span class="si">%s</span><span class="s1"> ODS&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">missing</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">require_mode</span> <span class="o">==</span> <span class="s1">&#39;warn_through&#39;</span><span class="p">:</span>
                    <span class="n">printe</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">require_mode</span> <span class="o">==</span> <span class="s1">&#39;warn_skip&#39;</span><span class="p">:</span>
                    <span class="n">printe</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">kw</span><span class="p">[</span><span class="s1">&#39;ods&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">require_mode</span> <span class="o">==</span> <span class="s1">&#39;raise&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

            <span class="c1"># run function</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="k">return</span> <span class="n">_req</span>


<span class="c1"># constants class that mimics scipy.constants</span>
<span class="k">class</span> <span class="nc">constants</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">e</span> <span class="o">=</span> <span class="mf">1.6021766208e-19</span>


<span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">consistent_times</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">attempt_fix</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">raise_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assign .time and .ids_properties.homogeneous_time info for top-level structures since these are required for writing an IDS to IMAS</span>

<span class="sd">    :param attempt_fix: fix dataset_description and wall IDS to have 0 times if none is set</span>

<span class="sd">    :param raise_errors: raise errors if could not satisfy IMAS requirements</span>

<span class="sd">    :return: `True` if all is good, `False` if requirements are not satisfied, `None` if fixes were applied</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># if called at top level, loop over all data structures</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">location</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">ds</span><span class="p">]</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">getraw</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span><span class="o">.</span><span class="n">physics_consistent_times</span><span class="p">(</span><span class="n">attempt_fix</span><span class="o">=</span><span class="n">attempt_fix</span><span class="p">,</span> <span class="n">raise_errors</span><span class="o">=</span><span class="n">raise_errors</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">is</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">out</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">p2l</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">location</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">extra_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">extra_info</span><span class="o">=</span><span class="n">extra_info</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extra_info</span><span class="p">[</span><span class="s1">&#39;homogeneous_time&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;ids_properties&#39;</span><span class="p">][</span><span class="s1">&#39;homogeneous_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_info</span><span class="p">[</span><span class="s1">&#39;homogeneous_time&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
        <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span>
        <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;ids_properties&#39;</span><span class="p">][</span><span class="s1">&#39;homogeneous_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_info</span><span class="p">[</span><span class="s1">&#39;homogeneous_time&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">attempt_fix</span><span class="p">:</span>
        <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span>
        <span class="n">extra_info</span><span class="p">[</span><span class="s1">&#39;homogeneous_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;ids_properties&#39;</span><span class="p">][</span><span class="s1">&#39;homogeneous_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_info</span><span class="p">[</span><span class="s1">&#39;homogeneous_time&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">raise_errors</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">location</span> <span class="o">+</span> <span class="s1">&#39;.time cannot be automatically filled! Missing time information in the data structure.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">imas_info</span><span class="p">(</span><span class="n">ods</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    add ids_properties.version_put... information</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># if called at top level, loop over all data structures</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">location</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
            <span class="n">ods</span><span class="o">.</span><span class="n">getraw</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span><span class="o">.</span><span class="n">physics_imas_info</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;ids_properties.version_put.access_layer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
        <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;ids_properties.version_put.access_layer_language&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;OMAS&#39;</span>
        <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;ids_properties.version_put.data_dictionary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">imas_version</span>

    <span class="k">return</span> <span class="n">ods</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">equilibrium_stored_energy</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate MHD stored energy from equilibrium pressure and volume</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="kn">import</span> <span class="n">ODS</span>

        <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">]:</span>
        <span class="n">pressure_equil</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span>
        <span class="n">volume_equil</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span>

        <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;.global_quantities.energy_mhd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">3.0</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">pressure_equil</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">volume_equil</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># [J]</span>

    <span class="k">return</span> <span class="n">ods_n</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">equilibrium_ggd_to_rectangular</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert GGD data to profiles 2D</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param time_index: time slices to process</span>

<span class="sd">    :param resolution: integer or tuple for rectangular grid resolution</span>

<span class="sd">    :param method: one of &#39;nearest&#39;, &#39;linear&#39;, &#39;cubic&#39;, &#39;extrapolate&#39;</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="kn">import</span> <span class="n">ODS</span>

        <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="n">points</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.grids_ggd[0].grid[0].space[0].objects_per_dimension[0].object[:].geometry&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">resolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resolution</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="p">[</span><span class="n">resolution</span><span class="p">,</span> <span class="n">resolution</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">time_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">time_index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time_index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">time_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">time_index</span><span class="p">]</span>

    <span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">itime</span> <span class="ow">in</span> <span class="n">time_index</span><span class="p">:</span>
        <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">itime</span><span class="si">}</span><span class="s1">.profiles_2d.0.grid_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">itime</span><span class="si">}</span><span class="s1">.profiles_2d&#39;</span><span class="p">]:</span>
            <span class="n">profiles_2d</span> <span class="o">=</span> <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">itime</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;grid_type.index&#39;</span> <span class="ow">in</span> <span class="n">profiles_2d</span> <span class="ow">and</span> <span class="n">profiles_2d</span><span class="p">[</span><span class="s1">&#39;grid_type.index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">ggd</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">itime</span><span class="si">}</span><span class="s1">.ggd.0&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">what</span> <span class="ow">in</span> <span class="n">ggd</span><span class="p">:</span>
            <span class="n">quantity</span> <span class="o">=</span> <span class="n">ggd</span><span class="p">[</span><span class="n">what</span> <span class="o">+</span> <span class="s1">&#39;.0.values&#39;</span><span class="p">]</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">interpolated</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">scatter_to_rectangular</span><span class="p">(</span>
                <span class="n">points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">resolution</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">return_cache</span><span class="o">=</span><span class="n">cache</span>
            <span class="p">)</span>
            <span class="n">profiles_2d</span><span class="p">[</span><span class="n">what</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolated</span><span class="o">.</span><span class="n">T</span>
        <span class="n">profiles_2d</span><span class="p">[</span><span class="s1">&#39;grid.dim1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">profiles_2d</span><span class="p">[</span><span class="s1">&#39;grid.dim2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span>
    <span class="k">return</span> <span class="n">ods_n</span>

<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_rho_pol_norm_to_equilbrium_profiles_1d_ods</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;rho_pol-norm&quot;</span><span class="p">])</span> <span class="o">==</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;psi&quot;</span><span class="p">])):</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">LookupError</span>
    <span class="k">except</span> <span class="ne">LookupError</span><span class="p">:</span>
        <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;rho_pol_norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ods</span><span class="o">.</span><span class="n">map_pol_flux_to_flux_coordinate</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="s2">&quot;rho_pol_norm&quot;</span><span class="p">,</span> 
            <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;psi&quot;</span><span class="p">])</span>
        <span class="p">)</span>

<span class="k">def</span> <span class="nf">mask_SOL</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">psi_values</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a numpy array of `dtype=bool`/</span>
<span class="sd">        The array is true for all values inside and on the LCFS</span>
<span class="sd">        :param ods: input ods</span>

<span class="sd">        :param time_index: time slices to process</span>

<span class="sd">        :param values: Psi values that need to masked</span>

<span class="sd">        :return: mask that is True for values inside and on the LCFS</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_axis&quot;</span><span class="p">]</span> <span class="o">&lt;</span>
        <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_boundary&quot;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="n">psi_values</span> <span class="o">&lt;=</span> <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_boundary&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">psi_values</span> <span class="o">&gt;=</span> <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_boundary&quot;</span><span class="p">]</span>

<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">add_phi_to_equilbrium_profiles_1d_ods</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds `profiles_1d.phi` to an ODS using q</span>
<span class="sd">        :param ods: input ods</span>

<span class="sd">        :param time_index: time slices to process</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;phi&quot;</span><span class="p">])</span> <span class="o">==</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;psi&quot;</span><span class="p">])):</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">LookupError</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">LookupError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">InterpolatedUnivariateSpline</span>
        <span class="c1">#TODO: </span>
        <span class="c1"># - Any cocos needed here?</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;psi&quot;</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_SOL</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">psi</span><span class="p">)</span>
        <span class="n">q_spline</span> <span class="o">=</span> <span class="n">InterpolatedUnivariateSpline</span><span class="p">(</span>
                <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;psi&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">],</span>
                <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;q&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">phi_spline</span> <span class="o">=</span> <span class="n">q_spline</span><span class="o">.</span><span class="n">antiderivative</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">psi</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;phi&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">phi_spline</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;psi&quot;</span><span class="p">][</span><span class="n">mask</span><span class="p">]))</span>
        <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;phi&quot;</span><span class="p">][</span><span class="n">mask</span><span class="o">==</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span>


<span class="k">def</span> <span class="nf">map_flux_coordinate_to_pol_flux</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maps from one magnetic coordinate system to psi</span>
<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param time_index: time slices to process</span>

<span class="sd">    :param origin: Specifier for original coordinate system</span>

<span class="sd">    :param values: Values to transform to poloidal flux</span>

<span class="sd">    :return: Transformed values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">origin</span> <span class="o">==</span> <span class="s2">&quot;psi_norm&quot;</span> <span class="ow">or</span> <span class="n">origin</span> <span class="o">==</span> <span class="s2">&quot;rho_pol_norm&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">origin</span> <span class="o">==</span> <span class="s2">&quot;rho_pol_norm&quot;</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">values</span> <span class="o">*</span> <span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_boundary&quot;</span><span class="p">]</span>
               <span class="o">-</span> <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_axis&quot;</span><span class="p">])</span>
               <span class="o">+</span> <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_axis&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">origin</span> <span class="o">==</span> <span class="s2">&quot;rho_pol_norm&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">values</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_boundary&quot;</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_axis&quot;</span><span class="p">])</span>
                <span class="o">+</span> <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_axis&quot;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">origin</span> <span class="o">==</span> <span class="s2">&quot;rho_tor_norm&quot;</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">values</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">phi</span> <span class="o">*=</span> <span class="n">map_pol_flux_to_flux_coordinate</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">,</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_boundary&quot;</span><span class="p">]]))</span>
        <span class="k">return</span> <span class="n">map_flux_coordinate_to_pol_flux</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="n">phi</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">origin</span> <span class="o">==</span> <span class="s2">&quot;phi&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">InterpolatedUnivariateSpline</span>
        <span class="n">psi_grid</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;psi&quot;</span><span class="p">]</span>
        <span class="n">psi_mask</span> <span class="o">=</span> <span class="n">mask_SOL</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">psi_grid</span><span class="p">)</span>
        <span class="n">phi_grid</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;phi&quot;</span><span class="p">][</span><span class="n">psi_mask</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">phi_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">phi_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">psi_spl</span> <span class="o">=</span> <span class="n">InterpolatedUnivariateSpline</span><span class="p">(</span><span class="n">phi_grid</span><span class="p">[</span><span class="n">psi_mask</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">psi_grid</span><span class="p">[</span><span class="n">psi_mask</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psi_spl</span> <span class="o">=</span> <span class="n">InterpolatedUnivariateSpline</span><span class="p">(</span><span class="n">phi_grid</span><span class="p">[</span><span class="n">psi_mask</span><span class="p">],</span> <span class="n">psi_grid</span><span class="p">[</span><span class="n">psi_mask</span><span class="p">])</span>
        <span class="n">phi_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">phi_grid</span><span class="p">)</span>
        <span class="n">phi_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">phi_grid</span><span class="p">)</span>
        <span class="n">values_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="n">phi_min</span><span class="p">,</span> <span class="n">values</span> <span class="o">&lt;=</span> <span class="n">phi_max</span><span class="p">)</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">psi</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">psi</span><span class="p">[</span><span class="n">values_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi_spl</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">values_mask</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">psi</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conversion from </span><span class="si">{</span><span class="n">origin</span><span class="si">}</span><span class="s2"> not yet implemented.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">map_pol_flux_to_flux_coordinate</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Maps from one magnetic coordinate system to psi</span>
<span class="sd">        :param ods: input ods</span>

<span class="sd">        :param time_index: time slices to process</span>

<span class="sd">        :param destination: Target coordinate system for output</span>

<span class="sd">        :param values: Values to transform to poloidal flux</span>

<span class="sd">        :return: Transformed values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">destination</span> <span class="o">==</span> <span class="s2">&quot;psi_norm&quot;</span> <span class="ow">or</span> <span class="n">destination</span> <span class="o">==</span> <span class="s2">&quot;rho_pol_norm&quot;</span><span class="p">:</span>
        <span class="n">psi_n</span> <span class="o">=</span> <span class="p">((</span><span class="n">values</span> <span class="o">-</span> <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_axis&quot;</span><span class="p">])</span>
                 <span class="o">/</span> <span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_boundary&quot;</span><span class="p">]</span>
                 <span class="o">-</span> <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_axis&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">destination</span> <span class="o">==</span> <span class="s2">&quot;rho_pol_norm&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">psi_n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">psi_n</span>
    <span class="k">elif</span> <span class="n">destination</span> <span class="o">==</span> <span class="s2">&quot;rho_tor_norm&quot;</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_SOL</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">map_pol_flux_to_flux_coordinate</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">rho_tor_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">phi_boundary</span> <span class="o">=</span> <span class="n">map_pol_flux_to_flux_coordinate</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="s2">&quot;phi&quot;</span><span class="p">,</span> 
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_boundary&quot;</span><span class="p">]]))</span>
        <span class="n">rho_tor_norm</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">phi</span> <span class="o">/</span> <span class="n">phi_boundary</span><span class="p">)</span>
        <span class="n">rho_tor_norm</span><span class="p">[</span><span class="n">mask</span><span class="o">==</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">return</span> <span class="n">rho_tor_norm</span>
    <span class="k">elif</span> <span class="n">destination</span> <span class="o">==</span> <span class="s2">&quot;phi&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">InterpolatedUnivariateSpline</span>
        <span class="n">psi_grid</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;psi&quot;</span><span class="p">]</span>
        <span class="n">psi_grid_mask</span> <span class="o">=</span> <span class="n">mask_SOL</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">psi_grid</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">phi_spl</span> <span class="o">=</span> <span class="n">InterpolatedUnivariateSpline</span><span class="p">(</span><span class="n">psi_grid</span><span class="p">[</span><span class="n">psi_grid_mask</span><span class="p">],</span>
                    <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;phi&quot;</span><span class="p">][</span><span class="n">psi_grid_mask</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">add_phi_to_equilbrium_profiles_1d_ods</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">)</span>
            <span class="n">phi_spl</span> <span class="o">=</span> <span class="n">InterpolatedUnivariateSpline</span><span class="p">(</span><span class="n">psi_grid</span><span class="p">[</span><span class="n">psi_grid_mask</span><span class="p">],</span>
                    <span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;profiles_1d&quot;</span><span class="p">][</span><span class="s2">&quot;phi&quot;</span><span class="p">][</span><span class="n">psi_grid_mask</span><span class="p">])</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask_SOL</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">phi</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi_spl</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
        <span class="n">phi_bound</span> <span class="o">=</span> <span class="n">phi_spl</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s2">&quot;equilibrium&quot;</span><span class="p">][</span><span class="s2">&quot;time_slice&quot;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s2">&quot;global_quantities&quot;</span><span class="p">][</span><span class="s2">&quot;psi_boundary&quot;</span><span class="p">])</span>
        <span class="n">phi</span><span class="p">[</span><span class="n">mask</span><span class="o">==</span><span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">phi_bound</span><span class="p">)</span>
        <span class="n">wrong_sign_mask</span> <span class="o">=</span> <span class="n">phi_bound</span> <span class="o">*</span> <span class="n">phi</span> <span class="o">&lt;</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">wrong_sign_mask</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">wrong_sign_mask</span><span class="p">]</span><span class="o">/</span><span class="n">phi_bound</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.e-4</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unphysical phi encountered when mapping to phi&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phi</span><span class="p">[</span><span class="n">wrong_sign_mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">return</span> <span class="n">phi</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conversion to </span><span class="si">{</span><span class="n">destination</span><span class="si">}</span><span class="s2"> not yet implemented.&quot;</span><span class="p">)</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">remap_flux_coordinates</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Maps from one magnetic coordinate system to another. At the moment only supports</span>
<span class="sd">    psi &lt;-&gt; rho_pol</span>
<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param time_index: time slices to process</span>

<span class="sd">    :param origin: Specifier for original coordinate system</span>

<span class="sd">    :param destination: Target coordinate system for output</span>

<span class="sd">    :param values: Values to transform</span>

<span class="sd">    :return: Transformed values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">origin</span> <span class="o">!=</span> <span class="s2">&quot;psi&quot;</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">map_flux_coordinate_to_pol_flux</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">values</span>
    <span class="k">if</span> <span class="n">destination</span> <span class="o">!=</span> <span class="s2">&quot;psi&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">map_pol_flux_to_flux_coordinate</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">psi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">psi</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">resolve_equilibrium_profiles_2d_grid_index</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">grid_identifier</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function to identify which of profiles_2d[:].grid_type.index</span>
<span class="sd">    matches the specified grid_identifier</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param time_index: time index to search</span>

<span class="sd">    :param grid_identifier: grid type to be resolved</span>

<span class="sd">    :return: Index of grid the requested grid, not to be confused with</span>
<span class="sd">        profiles_2d[:].grid_type.index</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grid_type</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;grid_type.index&#39;</span><span class="p">:</span> <span class="n">grid_identifier</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">grid_index</span> <span class="o">=</span> <span class="n">search_in_array_structure</span><span class="p">(</span>
            <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d&#39;</span><span class="p">],</span> <span class="n">grid_type</span><span class="p">,</span> <span class="n">no_matches_raise_error</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Requested equilibrium.profiles_2d_grid_type not present&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">grid_index</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">derive_equilibrium_profiles_2d_quantity</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">grid_index</span><span class="p">,</span> <span class="n">quantity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function derives values of empty fields in prpfiles_2d from other parameters in the equilibrium ods</span>
<span class="sd">    Currently only the magnetic field components are supported</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param time_index: time slice to process</span>

<span class="sd">    :param grid_index: Index of grid to map</span>

<span class="sd">    :param quantity: Member of profiles_2d to be derived</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">RectBivariateSpline</span><span class="p">,</span> <span class="n">InterpolatedUnivariateSpline</span>

    <span class="n">r</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span>
        <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.grid.dim1&#39;</span><span class="p">],</span>
        <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.grid.dim2&#39;</span><span class="p">],</span>
        <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">psi_spl</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span>
        <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.grid.dim1&#39;</span><span class="p">],</span>
        <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.grid.dim2&#39;</span><span class="p">],</span>
        <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.psi&#39;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">cocos</span> <span class="o">=</span> <span class="n">define_cocos</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s2">&quot;b_field_r&quot;</span><span class="p">:</span>
        <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.b_field_r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">psi_spl</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">((</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;exp_Bp&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ods</span>
    <span class="k">elif</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s2">&quot;b_field_z&quot;</span><span class="p">:</span>
        <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.b_field_z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">psi_spl</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">*</span> <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">((</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;exp_Bp&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">r</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ods</span>
    <span class="k">elif</span> <span class="n">quantity</span> <span class="o">==</span> <span class="s2">&quot;b_field_tor&quot;</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.psi&#39;</span><span class="p">]</span>
            <span class="o">&lt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_1d.psi&#39;</span><span class="p">]),</span>
            <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.psi&#39;</span><span class="p">]</span>
            <span class="o">&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_1d.psi&#39;</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="n">f_spl</span> <span class="o">=</span> <span class="n">InterpolatedUnivariateSpline</span><span class="p">(</span>
            <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_1d.psi&#39;</span><span class="p">],</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_1d.f&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.b_field_tor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.b_field_tor&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">f_spl</span><span class="p">(</span><span class="n">psi_spl</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.b_field_tor&#39;</span><span class="p">][</span><span class="n">mask</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_1d.f&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">r</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ods</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot add </span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s2">. Not yet implemented.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">cache_interpolator</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">grid_index</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">interpolator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility function for equilibrium_profiles_2d_map. Creates a tree dictionary structure to store interpolators.</span>

<span class="sd">    :param cache: cache object to add tree entry to</span>

<span class="sd">    :param time_index: time slices to process</span>

<span class="sd">    :param grid_index: Index of grid to map</span>

<span class="sd">    :param quantity: Member of profiles_2d[:]</span>

<span class="sd">    :param interpolator: Interpolator to store</span>

<span class="sd">    :return: updated cache</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">time_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">:</span>
        <span class="n">cache</span><span class="p">[</span><span class="n">time_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">grid_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cache</span><span class="p">[</span><span class="n">time_index</span><span class="p">]:</span>
        <span class="n">cache</span><span class="p">[</span><span class="n">time_index</span><span class="p">][</span><span class="n">grid_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cache</span><span class="p">[</span><span class="n">time_index</span><span class="p">][</span><span class="n">grid_index</span><span class="p">][</span><span class="n">quantity</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolator</span>
    <span class="k">return</span> <span class="n">cache</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">equilibrium_profiles_2d_map</span><span class="p">(</span>
    <span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">grid_index</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">dim1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dim2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_of_bounds_value</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This routines creates interpolators for quantities and stores them in the cache for future use.</span>
<span class="sd">    It can also be used to just return the current profile_2d quantity by omitting dim1 and dim2.</span>
<span class="sd">    At the moment this routine always extrapolates for data outside the defined grid range.</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param time_index: time slices to process</span>

<span class="sd">    :param grid_index: Index of grid to map</span>

<span class="sd">    :param quantity: Member of profiles_2d[:] to map</span>

<span class="sd">    :param dim1: First coordinate of the points to map to</span>

<span class="sd">    :param dim2: Second coordinate of the points to map to</span>

<span class="sd">    :param cache: Cache to store interpolants in</span>

<span class="sd">    :param return_cache: Toggles return of cache</span>

<span class="sd">    :return: mapped positions (and cahce if return_cache)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">quantity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]:</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">physics_derive_equilibrium_profiles_2d_quantity</span><span class="p">(</span><span class="n">time_index</span><span class="p">,</span> <span class="n">grid_index</span><span class="p">,</span> <span class="n">quantity</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dim1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">dim2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.0.</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
    <span class="c1"># Try to use an interpolator from the cache</span>
    <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">return_cache</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">time_index</span><span class="p">][</span><span class="n">quantity</span><span class="p">](</span><span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">cache</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">cache</span><span class="p">[</span><span class="n">time_index</span><span class="p">][</span><span class="n">quantity</span><span class="p">](</span><span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice[</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">].profiles_2d[</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">].grid_type.index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">91</span><span class="p">:</span>
        <span class="n">interpolator</span> <span class="o">=</span> <span class="n">create_scatter_interpolator</span><span class="p">(</span>
            <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.0.grid.dim1&#39;</span><span class="p">],</span>
            <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.grid.dim2&#39;</span><span class="p">],</span>
            <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span>
            <span class="n">method</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">,</span>
            <span class="n">return_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">interpolator</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span>
            <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.grid.dim1&#39;</span><span class="p">],</span>
            <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.grid.dim2&#39;</span><span class="p">],</span>
            <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">quantity</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="n">mapped_values</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dim1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">mapped_values</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">dim1</span> <span class="o">&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.grid.dim1&#39;</span><span class="p">]),</span>
            <span class="n">dim1</span> <span class="o">&lt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.grid.dim1&#39;</span><span class="p">]),</span>
        <span class="p">),</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">dim2</span> <span class="o">&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.grid.dim2&#39;</span><span class="p">]),</span>
            <span class="n">dim2</span> <span class="o">&lt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.profiles_2d.</span><span class="si">{</span><span class="n">grid_index</span><span class="si">}</span><span class="s1">.grid.dim2&#39;</span><span class="p">]),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">return_cache</span><span class="p">:</span>
        <span class="n">cache</span> <span class="o">=</span> <span class="n">cache_interpolator</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">grid_index</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">interpolator</span><span class="p">)</span>
        <span class="n">mapped_values</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">time_index</span><span class="p">][</span><span class="n">grid_index</span><span class="p">][</span><span class="n">quantity</span><span class="p">](</span><span class="n">dim1</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">dim2</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mapped_values</span><span class="p">,</span> <span class="n">cache</span>
    <span class="n">mapped_values</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolator</span><span class="p">(</span><span class="n">dim1</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">dim2</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mapped_values</span>


<span class="k">def</span> <span class="nf">remove_integrator_drift</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">time_after_shot</span><span class="p">):</span>
    <span class="c1"># assume that the drift is zero at time[0]</span>
    <span class="n">ind</span> <span class="o">=</span> <span class="n">time</span> <span class="o">&gt;</span> <span class="n">time_after_shot</span>
    <span class="k">return</span> <span class="n">data</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">time</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">data</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


<span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">equilibrium_form_constraints</span><span class="p">(</span>
    <span class="n">ods</span><span class="p">,</span>
    <span class="n">times</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">default_average</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">averages</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cutoff_hz</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rm_integr_drift_after</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    generate equilibrium constraints from experimental data in ODS</span>

<span class="sd">    :param ods: input ODS</span>

<span class="sd">    :param times: list of times at which to generate the constraints</span>

<span class="sd">    :param default_average: default averaging time</span>

<span class="sd">    :param constraints: list of constraints to be formed (if experimental data is available)</span>
<span class="sd">                        NOTE: only the constraints marked with `OK` are supported at this time::</span>

<span class="sd">                         OK b_field_tor_vacuum_r</span>
<span class="sd">                         OK bpol_probe</span>
<span class="sd">                         OK diamagnetic_flux</span>
<span class="sd">                          * faraday_angle</span>
<span class="sd">                         OK flux_loop</span>
<span class="sd">                         OK ip</span>
<span class="sd">                          * iron_core_segment</span>
<span class="sd">                          * mse_polarisation_angle</span>
<span class="sd">                          * n_e</span>
<span class="sd">                          * n_e_line</span>
<span class="sd">                         OK pf_current</span>
<span class="sd">                          * pf_passive_current</span>
<span class="sd">                          * pressure</span>
<span class="sd">                          * q</span>
<span class="sd">                          * strike_point</span>
<span class="sd">                          * x_point</span>

<span class="sd">    :param averages: dictionary with average times for individual constraints</span>
<span class="sd">               Smoothed using Gaussian, sigma=averages/4. and the convolution is integrated across +/-4.*sigma.</span>

<span class="sd">    :param cutoff_hz: a list of two elements with low and high cutoff frequencies [lowFreq, highFreq]</span>

<span class="sd">    :param rm_integr_drift_after: time in ms after which is assumed thet all currents are zero and signal should be equal to zero. Used for removing of the integrators drift</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">omfit_classes.utils_math</span> <span class="kn">import</span> <span class="n">smooth_by_convolution</span><span class="p">,</span> <span class="n">firFilter</span>

    <span class="k">if</span> <span class="n">averages</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">averages</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># identify possible constraints</span>
    <span class="n">possible_constraints</span> <span class="o">=</span> <span class="n">omas_info</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)[</span><span class="s1">&#39;equilibrium.time_slice.0.constraints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="n">possible_constraints</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">constraint</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">possible_constraints</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Constraint `</span><span class="si">{</span><span class="n">constraint</span><span class="si">}</span><span class="s1">` not recognized: possible options are </span><span class="si">{</span><span class="n">possible_constraints</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># instantiate new ODS if not operating in place</span>
    <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="kn">import</span> <span class="n">ODS</span>

        <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">times</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;equilibrium.time&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must specify times at which to apply equilibrium constraint&#39;</span><span class="p">)</span>

    <span class="n">times</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;equilibrium.time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">times</span>

    <span class="n">nuconv_kw</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;window_function&#39;</span><span class="p">,</span> <span class="s1">&#39;boxcar&#39;</span><span class="p">)</span>
    <span class="c1"># pf_current</span>
    <span class="k">if</span> <span class="s1">&#39;pressure&#39;</span> <span class="ow">in</span> <span class="n">constraints</span> <span class="ow">and</span> <span class="s1">&#39;thompson&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Not implemented yet!!&#39;</span><span class="p">)</span>

    <span class="c1"># pf_current</span>
    <span class="k">if</span> <span class="s1">&#39;pf_current&#39;</span> <span class="ow">in</span> <span class="n">constraints</span> <span class="ow">and</span> <span class="s1">&#39;pf_active.coil&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="n">average</span> <span class="o">=</span> <span class="n">averages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pf_active&#39;</span><span class="p">,</span> <span class="n">default_average</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;pf_active.coil&#39;</span><span class="p">]:</span>
            <span class="n">printd</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing pf_active.coil.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;machine&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># get</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;pf_active.coil.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.name&#39;</span><span class="p">]</span>
                <span class="n">turns</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;pf_active.coil.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.element[0].turns_with_sign&#39;</span><span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;pf_active.coil.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.current.data&#39;</span><span class="p">]</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;pf_active.coil.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.current.time&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;pf_active.coil.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.current.data_error_upper&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;pf_active.coil.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.current.data_error_upper&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># process</span>
                <span class="k">if</span> <span class="n">rm_integr_drift_after</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">remove_integrator_drift</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rm_integr_drift_after</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cutoff_hz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">firFilter</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cutoff_hz</span><span class="p">)</span>
                <span class="c1"># Don&#39;t average for length=2 arrays or smaller</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">const</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">data</span> <span class="o">*</span> <span class="n">turns</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">const_error</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">error</span> <span class="o">*</span> <span class="n">turns</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">const</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">data</span> <span class="o">*</span> <span class="n">turns</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                         <span class="n">const_error</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">error</span> <span class="o">*</span> <span class="n">turns</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>

                <span class="c1"># assign</span>
                <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
                    <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.pf_current.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.measured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="p">[</span><span class="n">time_index</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.pf_current.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.measured_error_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">const_error</span><span class="p">[</span>
                            <span class="n">time_index</span>
                        <span class="p">]</span>
                    <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.pf_current.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_excp</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Problem with pf_current channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1"> :&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">_excp</span><span class="p">))</span>

    <span class="c1"># bpol_probe</span>
    <span class="k">if</span> <span class="s1">&#39;bpol_probe&#39;</span> <span class="ow">in</span> <span class="n">constraints</span> <span class="ow">and</span> <span class="s1">&#39;magnetics.b_field_pol_probe&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="n">average</span> <span class="o">=</span> <span class="n">averages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bpol_probe&#39;</span><span class="p">,</span> <span class="n">default_average</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;magnetics.b_field_pol_probe&#39;</span><span class="p">]:</span>
            <span class="n">printd</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing magnetics.b_field_pol_probe.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;machine&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># get</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;magnetics.b_field_pol_probe.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.identifier&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
                    <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.bpol_probe.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;magnetics.b_field_pol_probe.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.field.validity&#39;</span><span class="p">,</span>
                    <span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;magnetics.b_field_pol_probe.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.field.data&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">valid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 0 means that the data is good</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;magnetics.b_field_pol_probe.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.field.data&#39;</span><span class="p">]</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;magnetics.b_field_pol_probe.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.field.time&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;magnetics.b_field_pol_probe.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.field.data_error_upper&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;magnetics.b_field_pol_probe.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.field.data_error_upper&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># process</span>
                    <span class="k">if</span> <span class="n">rm_integr_drift_after</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">remove_integrator_drift</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rm_integr_drift_after</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cutoff_hz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">firFilter</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cutoff_hz</span><span class="p">)</span>
                    <span class="n">const</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">const_error</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">)</span>
                    <span class="c1"># assign</span>
                    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
                        <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.bpol_probe.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.measured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="p">[</span><span class="n">time_index</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ods_n</span><span class="p">[</span>
                                <span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.bpol_probe.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.measured_error_upper&#39;</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="n">const_error</span><span class="p">[</span><span class="n">time_index</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
                        <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.bpol_probe.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.measured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
                        <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.bpol_probe.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.measured_error_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_excp</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Problem with bpol_probe channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">_excp</span><span class="p">))</span>

    <span class="c1"># flux_loop</span>
    <span class="k">if</span> <span class="s1">&#39;flux_loop&#39;</span> <span class="ow">in</span> <span class="n">constraints</span> <span class="ow">and</span> <span class="s1">&#39;magnetics.flux_loop&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="n">average</span> <span class="o">=</span> <span class="n">averages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flux_loop&#39;</span><span class="p">,</span> <span class="n">default_average</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;magnetics.flux_loop&#39;</span><span class="p">]:</span>
            <span class="n">printd</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing magnetics.flux_loop.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;machine&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># get</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;magnetics.flux_loop.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.identifier&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
                    <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.flux_loop.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;magnetics.flux_loop.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.flux.validity&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;magnetics.flux_loop.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.flux.data&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">valid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 0 means that the data is good</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;magnetics.flux_loop.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.flux.data&#39;</span><span class="p">]</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;magnetics.flux_loop.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.flux.time&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;magnetics.flux_loop.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.flux.data_error_upper&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;magnetics.flux_loop.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.flux.data_error_upper&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># process</span>
                    <span class="k">if</span> <span class="n">rm_integr_drift_after</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">remove_integrator_drift</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rm_integr_drift_after</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cutoff_hz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">firFilter</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cutoff_hz</span><span class="p">)</span>
                    <span class="n">const</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">const_error</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">)</span>
                    <span class="c1"># assign</span>
                    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
                        <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.flux_loop.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.measured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="p">[</span><span class="n">time_index</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ods_n</span><span class="p">[</span>
                                <span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.flux_loop.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.measured_error_upper&#39;</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="n">const_error</span><span class="p">[</span><span class="n">time_index</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
                        <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.flux_loop.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.measured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
                        <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.flux_loop.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.measured_error_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_excp</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Problem with flux_loop channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">_excp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># ip</span>
    <span class="k">if</span> <span class="s1">&#39;ip&#39;</span> <span class="ow">in</span> <span class="n">constraints</span> <span class="ow">and</span> <span class="s1">&#39;magnetics.ip.0.data&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="n">average</span> <span class="o">=</span> <span class="n">averages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ip&#39;</span><span class="p">,</span> <span class="n">default_average</span><span class="p">)</span>
        <span class="n">printd</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing magnetics.ip&#39;</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;machine&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># get</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;magnetics.ip.0.data&#39;</span><span class="p">]</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;magnetics.ip.0.time&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;magnetics.ip.0.data_error_upper&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;magnetics.ip.0.data_error_upper&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># process</span>
            <span class="k">if</span> <span class="n">rm_integr_drift_after</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">remove_integrator_drift</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rm_integr_drift_after</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cutoff_hz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">firFilter</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cutoff_hz</span><span class="p">)</span>
            <span class="n">const</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">const_error</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">)</span>
            <span class="c1"># assign</span>
            <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
                <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.ip.measured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="p">[</span><span class="n">time_index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.ip.measured_error_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">const_error</span><span class="p">[</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_excp</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Problem with ip: </span><span class="si">{</span><span class="n">_excp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># diamagnetic_flux</span>
    <span class="k">if</span> <span class="s1">&#39;diamagnetic_flux&#39;</span> <span class="ow">in</span> <span class="n">constraints</span> <span class="ow">and</span> <span class="s1">&#39;magnetics.diamagnetic_flux.0.data&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="n">average</span> <span class="o">=</span> <span class="n">averages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;diamagnetic_flux&#39;</span><span class="p">,</span> <span class="n">default_average</span><span class="p">)</span>
        <span class="n">printd</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing magnetics.diamagnetic_flux&#39;</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;machine&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># get</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;magnetics.diamagnetic_flux.0.data&#39;</span><span class="p">]</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;magnetics.diamagnetic_flux.0.time&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;magnetics.diamagnetic_flux.0.data_error_upper&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;magnetics.diamagnetic_flux.0.data_error_upper&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># process</span>
            <span class="c1"># if rm_integr_drift_after is not None:</span>
            <span class="c1"># drift is already removed?</span>
            <span class="c1"># data = remove_integrator_drift(time, data, rm_integr_drift_after)</span>
            <span class="k">if</span> <span class="n">cutoff_hz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">firFilter</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cutoff_hz</span><span class="p">)</span>
            <span class="n">const</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">const_error</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">)</span>
            <span class="c1"># assign</span>
            <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
                <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.diamagnetic_flux.measured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="p">[</span><span class="n">time_index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.diamagnetic_flux.measured_error_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">const_error</span><span class="p">[</span>
                        <span class="n">time_index</span>
                    <span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_excp</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Problem with diamagnetic_flux: </span><span class="si">{</span><span class="n">_excp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># b_field_tor_vacuum_r</span>
    <span class="k">if</span> <span class="s1">&#39;b_field_tor_vacuum_r&#39;</span> <span class="ow">in</span> <span class="n">constraints</span> <span class="ow">and</span> <span class="s1">&#39;tf.b_field_tor_vacuum_r.data&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="n">printd</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing tf.b_field_tor_vacuum_r&#39;</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;machine&#39;</span><span class="p">)</span>
        <span class="n">average</span> <span class="o">=</span> <span class="n">averages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b_field_tor_vacuum_r&#39;</span><span class="p">,</span> <span class="n">default_average</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># get</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;tf.b_field_tor_vacuum_r.data&#39;</span><span class="p">]</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;tf.b_field_tor_vacuum_r.time&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;tf.b_field_tor_vacuum_r.data_error_upper&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;tf.b_field_tor_vacuum_r.data_error_upper&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># process</span>
            <span class="k">if</span> <span class="n">rm_integr_drift_after</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">remove_integrator_drift</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">rm_integr_drift_after</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cutoff_hz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">firFilter</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cutoff_hz</span><span class="p">)</span>
            <span class="n">const</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">const_error</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">)</span>
            <span class="c1"># assign</span>
            <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
                <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.b_field_tor_vacuum_r.measured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="p">[</span><span class="n">time_index</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.b_field_tor_vacuum_r.measured_error_upper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">const_error</span><span class="p">[</span>
                        <span class="n">time_index</span>
                    <span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_excp</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Problem with b_field_tor_vacuum_r: </span><span class="si">{</span><span class="n">_excp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># mse</span>
    <span class="k">if</span> <span class="s1">&#39;mse_polarisation_angle&#39;</span> <span class="ow">in</span> <span class="n">constraints</span> <span class="ow">and</span> <span class="s1">&#39;mse.channel.0.polarisation_angle.data&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="n">average</span> <span class="o">=</span> <span class="n">averages</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mse_polarisation_angle&#39;</span><span class="p">,</span> <span class="n">default_average</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mse.channel&#39;</span><span class="p">]:</span>
            <span class="n">printd</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing mse.channel.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;machine&#39;</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># get</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mse.channel.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.name&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
                    <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.mse_polarisation_angle.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;mse.channel.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.polarisation_angle.validity&#39;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mse.channel.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.polarisation_angle.data&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">valid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># 0 means that the data is good</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mse.channel.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.polarisation_angle.data&#39;</span><span class="p">])</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mse.channel.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.polarisation_angle.time&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;mse.channel.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.polarisation_angle.data_error_upper&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mse.channel.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.polarisation_angle.data_error_upper&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># process</span>
                    <span class="k">if</span> <span class="n">cutoff_hz</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">firFilter</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cutoff_hz</span><span class="p">)</span>
                    <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;mse.channel.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.polarisation_angle.validity_timed&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mse.channel.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.polarisation_angle.validity_timed&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
                        <span class="n">error</span><span class="p">[</span><span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;mse.channel.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.polarisation_angle.validity_timed&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">const</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">const_error</span> <span class="o">=</span> <span class="n">smooth_by_convolution</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">average</span><span class="p">,</span> <span class="o">**</span><span class="n">nuconv_kw</span><span class="p">)</span>
                    <span class="c1"># assign</span>
                    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
                        <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.mse_polarisation_angle.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.measured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">const</span><span class="p">[</span>
                            <span class="n">time_index</span>
                        <span class="p">]</span>
                        <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ods_n</span><span class="p">[</span>
                                <span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.mse_polarisation_angle.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.measured_error_upper&#39;</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="n">const_error</span><span class="p">[</span><span class="n">time_index</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)):</span>
                        <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.mse_polarisation_angle.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.measured&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
                        <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ods_n</span><span class="p">[</span>
                                <span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.constraints.mse_polarisation_angle.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.measured_error_upper&#39;</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
               
                <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;mse.channel.:.active_spatial_resolution[0].geometric_coefficients&#39;</span><span class="p">]</span>
                <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;mse.channel.:.active_spatial_resolution[0].centre.r&#39;</span><span class="p">]</span>
                <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;mse.channel.:.active_spatial_resolution[0].centre.z&#39;</span><span class="p">]</span>
                <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;mse.channel.:.active_spatial_resolution[0].centre.phi&#39;</span><span class="p">]</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_excp</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Problem with mse channel </span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">_excp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ods_n</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">,</span> <span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">summary_greenwald</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates Greenwald Fraction for each time slice and stores them in the summary ods.</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="kn">import</span> <span class="n">ODS</span>

        <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice.:.profiles_1d.r_outboard&#39;</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice.:.profiles_1d.r_inboard&#39;</span><span class="p">][:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice.:.global_quantities.ip&#39;</span><span class="p">]</span>
    <span class="n">nel</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">]:</span>
        <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span>
            <span class="n">ods</span><span class="p">,</span>
            <span class="n">coordsio</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;core_profiles.profiles_1d.</span><span class="si">%d</span><span class="s1">.grid.rho_tor_norm&#39;</span>
                <span class="o">%</span> <span class="n">time_index</span><span class="p">:</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">%s</span><span class="s1">.profiles_1d.rho_tor_norm&#39;</span> <span class="o">%</span> <span class="n">time_index</span><span class="p">]</span>
            <span class="p">},</span>
        <span class="p">):</span>
            <span class="n">ne</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles.profiles_1d.</span><span class="si">%d</span><span class="s1">.electrons.density_thermal&#39;</span> <span class="o">%</span> <span class="n">time_index</span><span class="p">]</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice.</span><span class="si">%d</span><span class="s1">.profiles_1d.volume&#39;</span> <span class="o">%</span> <span class="n">time_index</span><span class="p">]</span>
            <span class="n">ne_vol_avg</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">volume</span><span class="p">)</span> <span class="o">/</span> <span class="n">volume</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;interferometer&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                <span class="n">ods</span><span class="o">.</span><span class="n">physics_summary_lineaverage_density</span><span class="p">()</span>
                <span class="n">nel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;interferometer.channel.0.n_e_line_average.data&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Warning: greenwald fraction calculation used volume average density instead of line average fill in ods[&#39;interferometer&#39;] to use nel&quot;</span>
                <span class="p">)</span>
                <span class="n">nel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne_vol_avg</span><span class="p">)</span>
    <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities.greenwald_fraction.value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nel</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e20</span> <span class="o">/</span> <span class="n">ip</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ods_n</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">,</span> <span class="s1">&#39;equilibrium&#39;</span><span class="p">,</span> <span class="s1">&#39;interferometer&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">summary_lineaverage_density</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">line_grid</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">doPlot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates line-average electron density for each time slice and stores them in the summary ods</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param line_grid: number of points to calculate line average density over (includes point outside of boundary)</span>

<span class="sd">    :param time_index: time slices to process</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :param doPlot: plots the interferometer lines on top of the equilibrium boundary shape</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">scipy</span>

    <span class="k">if</span> <span class="n">doPlot</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

    <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="kn">import</span> <span class="n">ODS</span>

        <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">time_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.line_average.n_e.value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">])):</span>
            <span class="n">line_average_ne</span> <span class="o">=</span> <span class="n">summary_lineaverage_density</span><span class="p">(</span><span class="n">ods_n</span><span class="p">,</span> <span class="n">line_grid</span><span class="o">=</span><span class="n">line_grid</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="n">time_index</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">,</span> <span class="n">doPlot</span><span class="o">=</span><span class="n">doPlot</span><span class="p">)[</span>
                <span class="s1">&#39;interferometer&#39;</span>
            <span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;n_e_line_average&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
            <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.line_average.n_e.value&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">line_average_ne</span>
        <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ods_n</span>

    <span class="n">Rb</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;boundary&#39;</span><span class="p">][</span><span class="s1">&#39;outline&#39;</span><span class="p">][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
    <span class="n">Zb</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;boundary&#39;</span><span class="p">][</span><span class="s1">&#39;outline&#39;</span><span class="p">][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>

    <span class="n">Rgrid</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;dim1&#39;</span><span class="p">]</span>
    <span class="n">Zgrid</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;dim2&#39;</span><span class="p">]</span>

    <span class="n">psi2d</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;psi&#39;</span><span class="p">]</span>
    <span class="n">psi_spl</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">Rgrid</span><span class="p">,</span> <span class="n">Zgrid</span><span class="p">,</span> <span class="n">psi2d</span><span class="p">)</span>
    <span class="n">psi_eq</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;psi&#39;</span><span class="p">]</span>
    <span class="n">rhon_eq</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>
    <span class="n">rhon_cp</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>
    <span class="n">ne</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">]</span>
    <span class="n">ne</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">rhon_eq</span><span class="p">,</span> <span class="n">rhon_cp</span><span class="p">,</span> <span class="n">ne</span><span class="p">)</span>
    <span class="n">tck</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splrep</span><span class="p">(</span><span class="n">psi_eq</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;interferometer&#39;</span><span class="p">]:</span>
        <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;interferometer.ids_properties.homogeneous_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;interferometer&#39;</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>

    <span class="n">ifpaths</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;first_point&#39;</span><span class="p">,</span> <span class="s1">&#39;second_point&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;second_point&#39;</span><span class="p">,</span> <span class="s1">&#39;third_point&#39;</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">doPlot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice[0].boundary.outline.r&#39;</span><span class="p">],</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice[0].boundary.outline.z&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Boundary shape&#39;</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;r [m]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;z [m]&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;interferometer&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">]:</span>
        <span class="n">ne_line_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dist_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ifpath</span> <span class="ow">in</span> <span class="n">ifpaths</span><span class="p">:</span>
            <span class="n">R1</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;interferometer&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">channel</span><span class="p">][</span><span class="s1">&#39;line_of_sight&#39;</span><span class="p">][</span><span class="n">ifpath</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
            <span class="n">Z1</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;interferometer&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">channel</span><span class="p">][</span><span class="s1">&#39;line_of_sight&#39;</span><span class="p">][</span><span class="n">ifpath</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
            <span class="n">phi1</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;interferometer&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">channel</span><span class="p">][</span><span class="s1">&#39;line_of_sight&#39;</span><span class="p">][</span><span class="n">ifpath</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">R1</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi1</span><span class="p">)</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">R1</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi1</span><span class="p">)</span>

            <span class="n">R2</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;interferometer&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">channel</span><span class="p">][</span><span class="s1">&#39;line_of_sight&#39;</span><span class="p">][</span><span class="n">ifpath</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;r&#39;</span><span class="p">]</span>
            <span class="n">Z2</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;interferometer&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">channel</span><span class="p">][</span><span class="s1">&#39;line_of_sight&#39;</span><span class="p">][</span><span class="n">ifpath</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
            <span class="n">phi2</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;interferometer&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">channel</span><span class="p">][</span><span class="s1">&#39;line_of_sight&#39;</span><span class="p">][</span><span class="n">ifpath</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">R2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi2</span><span class="p">)</span>
            <span class="n">y2</span> <span class="o">=</span> <span class="n">R2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi2</span><span class="p">)</span>

            <span class="n">xline</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">)</span>
            <span class="n">yline</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">)</span>
            <span class="n">Rline</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">R1</span><span class="p">,</span> <span class="n">R2</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">)</span>
            <span class="n">Zline</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">Z1</span><span class="p">,</span> <span class="n">Z2</span><span class="p">,</span> <span class="n">line_grid</span><span class="p">)</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">line_grid</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">doPlot</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Rline</span><span class="p">,</span> <span class="n">Zline</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;interferometer path : </span><span class="si">{</span><span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ifpath</span><span class="p">)</span><span class="si">}</span><span class="s1"> channel:</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">Rval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Rline</span><span class="p">):</span>
                <span class="n">dist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">Rline</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Rb</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Zline</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Zb</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">zero_crossings</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">dist</span><span class="p">))))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">zero_crossings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">i2</span> <span class="o">=</span> <span class="n">zero_crossings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">psival</span> <span class="o">=</span> <span class="p">[</span><span class="n">psi_spl</span><span class="p">(</span><span class="n">Rline</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Zline</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">i2</span> <span class="o">-</span> <span class="n">i1</span><span class="p">))]</span>
            <span class="n">ne_interp</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">splev</span><span class="p">(</span><span class="n">psival</span><span class="p">,</span> <span class="n">tck</span><span class="p">)</span>
            <span class="n">ne_line</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">ne_interp</span><span class="p">)</span>
            <span class="n">ne_line</span> <span class="o">/=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i2</span> <span class="o">-</span> <span class="n">i1</span><span class="p">)</span>
            <span class="n">ne_line_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ne_line</span><span class="p">)</span>
            <span class="n">dist_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">xline</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span> <span class="o">-</span> <span class="n">xline</span><span class="p">[</span><span class="n">i1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yline</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span> <span class="o">-</span> <span class="n">yline</span><span class="p">[</span><span class="n">i1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Zline</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span> <span class="o">-</span> <span class="n">Zline</span><span class="p">[</span><span class="n">i1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">ne_line</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">ne_line_paths</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">dist_paths</span><span class="p">)</span>
        <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;interferometer.channel.</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1">.n_e_line_average.data&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ods_n</span><span class="p">:</span>
            <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;interferometer&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">channel</span><span class="p">][</span><span class="s1">&#39;n_e_line_average&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;interferometer&#39;</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">]))</span>

        <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;interferometer&#39;</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">channel</span><span class="p">][</span><span class="s1">&#39;n_e_line_average&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">ne_line</span>

    <span class="k">return</span> <span class="n">ods_n</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">,</span> <span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">summary_currents</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculatess plasma currents from core_profiles for each time slice and stores them in the summary ods</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param time_index: time slices to process</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="kn">import</span> <span class="n">ODS</span>

        <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="n">current_names</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;j_bootstrap&#39;</span><span class="p">,</span> <span class="s1">&#39;current_bootstrap.value&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;j_non_inductive&#39;</span><span class="p">,</span> <span class="s1">&#39;current_non_inductive.value&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;j_ohmic&#39;</span><span class="p">,</span> <span class="s1">&#39;current_ohm.value&#39;</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice[0].profiles_1d.rho_tor_norm&#39;</span><span class="p">]</span>
    <span class="n">time_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">coordsio</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;core_profiles.profiles_1d.</span><span class="si">%d</span><span class="s1">.grid.rho_tor_norm&#39;</span> <span class="o">%</span> <span class="n">time_index</span><span class="p">:</span> <span class="n">rho</span><span class="p">}</span>

    <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">coordsio</span><span class="o">=</span><span class="n">coordsio</span><span class="p">):</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">jname_cp</span><span class="p">,</span> <span class="n">jname_sum</span><span class="p">)</span> <span class="ow">in</span> <span class="n">current_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;core_profiles.profiles_1d.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">jname_cp</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                <span class="n">Bt</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.vacuum_toroidal_field.b0&#39;</span><span class="p">]</span>
                <span class="n">JtoR</span> <span class="o">=</span> <span class="n">transform_current</span><span class="p">(</span>
                    <span class="n">rho</span><span class="o">=</span><span class="n">rho</span><span class="p">,</span>
                    <span class="n">JparB</span><span class="o">=</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="n">jname_cp</span><span class="p">]</span> <span class="o">*</span> <span class="n">Bt</span><span class="p">,</span>
                    <span class="n">equilibrium</span><span class="o">=</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">Ip</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">JtoR</span><span class="p">,</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice[0].profiles_1d.volume&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>

                <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;summary.global_quantities.</span><span class="si">{</span><span class="n">jname_sum</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                    <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities&#39;</span><span class="p">][</span><span class="n">jname_sum</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">time_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities&#39;</span><span class="p">][</span><span class="n">jname_sum</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ip</span>

    <span class="k">return</span> <span class="n">ods_n</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">,</span> <span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">summary_thermal_stored_energy</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates the stored energy based on the contents of core_profiles for all time-slices</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="kn">import</span> <span class="n">ODS</span>

        <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="n">ods</span><span class="o">.</span><span class="n">physics_core_profiles_pressures</span><span class="p">()</span>
    <span class="n">thermal_energy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles.profiles_1d&#39;</span><span class="p">]:</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;equilibrium.time_slice[</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">].profiles_1d&#39;</span><span class="p">]</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;core_profiles.profiles_1d.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.grid.rho_tor_norm&#39;</span><span class="p">],</span> <span class="n">xp</span><span class="o">=</span><span class="n">eq</span><span class="p">[</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">],</span> <span class="n">fp</span><span class="o">=</span><span class="n">eq</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">])</span>
        <span class="n">thermal_energy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles.profiles_1d[0].pressure_thermal&#39;</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">volume</span><span class="p">))</span>

    <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities.energy_thermal.value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">thermal_energy</span><span class="p">)</span>
    <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ods_n</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">,</span> <span class="s1">&#39;core_sources&#39;</span><span class="p">,</span> <span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">summary_taue</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">thermal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates Energy confinement time estimated from the IPB98(y,2) scaling for each time slice and stores them in the summary ods</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :thermal: calculates the thermal part of the energy confinement time from core_profiles if True, otherwise use the stored energy MHD from the equilibrium ods</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="kn">import</span> <span class="n">ODS</span>

        <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="n">tau_e_scaling</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tau_e_MHD</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">]:</span>
        <span class="n">equilibrium_ods</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">equilibrium_ods</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;r_outboard&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">equilibrium_ods</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;r_inboard&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">r_major</span> <span class="o">=</span> <span class="p">(</span><span class="n">equilibrium_ods</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;r_outboard&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">equilibrium_ods</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;r_inboard&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">bt</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;b0&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span> <span class="o">*</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;r0&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">r_major</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">equilibrium_ods</span><span class="p">[</span><span class="s1">&#39;global_quantities&#39;</span><span class="p">][</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span>
        <span class="n">aspect</span> <span class="o">=</span> <span class="n">r_major</span> <span class="o">/</span> <span class="n">a</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;psi&#39;</span><span class="p">]</span>
        <span class="n">rho_tor_norm_equi</span> <span class="o">=</span> <span class="n">equilibrium_ods</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>
        <span class="n">rho_tor_norm_core</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>
        <span class="n">psi</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">rho_tor_norm_core</span><span class="p">,</span> <span class="n">rho_tor_norm_equi</span><span class="p">,</span> <span class="n">psi</span><span class="p">)</span>
        <span class="c1"># Making Equilibrium grid same grid as core_sources and core_profiles</span>
        <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">coordsio</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;equilibrium.time_slice.0.profiles_1d.psi&#39;</span><span class="p">:</span> <span class="n">psi</span><span class="p">}):</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">equilibrium_ods</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span>
            <span class="n">kappa</span> <span class="o">=</span> <span class="n">volume</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">a</span> <span class="o">/</span> <span class="n">a</span> <span class="o">/</span> <span class="n">r_major</span>
            <span class="n">ne</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">]</span>
            <span class="n">ne_vol_avg</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">ne</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">volume</span><span class="p">)</span> <span class="o">/</span> <span class="n">volume</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="s1">&#39;interferometer&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                <span class="n">ods</span><span class="o">.</span><span class="n">physics_summary_lineaverage_density</span><span class="p">()</span>
                <span class="n">nel</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;interferometer.channel.0.n_e_line_average.data&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Warning: taue calculation used volume average density instead of line average fill in ods[&#39;interferometer&#39;] to use nel&quot;</span>
                <span class="p">)</span>
                <span class="n">nel</span> <span class="o">=</span> <span class="n">ne_vol_avg</span>
            <span class="c1"># Naive weighted isotope average:</span>
            <span class="n">n_deuterium_avg</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">n_tritium_avg</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">ions</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;ion&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ion</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;ion&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">ions</span><span class="p">[</span><span class="n">ion</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span> <span class="ow">or</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span>
                    <span class="n">n_deuterium_avg</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">ions</span><span class="p">[</span><span class="n">ion</span><span class="p">][</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">volume</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">ions</span><span class="p">[</span><span class="n">ion</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span> <span class="ow">or</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
                    <span class="n">n_tritium_avg</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">ions</span><span class="p">[</span><span class="n">ion</span><span class="p">][</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">volume</span><span class="p">)</span>
            <span class="n">isotope_factor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.014102</span> <span class="o">*</span> <span class="n">n_deuterium_avg</span> <span class="o">+</span> <span class="mf">3.016049</span> <span class="o">*</span> <span class="n">n_tritium_avg</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_deuterium_avg</span> <span class="o">+</span> <span class="n">n_tritium_avg</span><span class="p">)</span>

            <span class="n">info_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="c1"># Get total power from ods function:</span>
            <span class="k">if</span> <span class="s1">&#39;power_loss&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities&#39;</span><span class="p">]:</span>
                <span class="n">power_loss</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities.power_loss.value&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
                <span class="n">info_string</span> <span class="o">+=</span> <span class="s2">&quot;Power from: summary.global_quantities.power_loss.value,  &quot;</span>
            <span class="k">elif</span> <span class="s1">&#39;power_steady&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities&#39;</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: taue calculation used power steady instead of power_loss&quot;</span><span class="p">)</span>
                <span class="n">ods</span><span class="o">.</span><span class="n">physics_summary_heating_power</span><span class="p">()</span>
                <span class="n">power_loss</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities.power_steady.value&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
                <span class="n">info_string</span> <span class="o">+=</span> <span class="s2">&quot;INACCURATE Power from: summary.global_quantities.power_steady.value,  &quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ods_n</span>
            <span class="c1"># Stored energy from profiles or equilibrium</span>
            <span class="k">if</span> <span class="s1">&#39;summary.global_quantities.energy_thermal&#39;</span> <span class="ow">in</span> <span class="n">ods</span> <span class="ow">and</span> <span class="n">thermal</span><span class="p">:</span>
                <span class="n">stored_energy</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities.energy_thermal.value&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
                <span class="n">info_string</span> <span class="o">+=</span> <span class="s2">&quot;Stored energy from: summary.global_quantities.energy_thermal.value&quot;</span>
            <span class="k">elif</span> <span class="s1">&#39;global_quantities.energy_mhd&#39;</span> <span class="ow">in</span> <span class="n">equilibrium_ods</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">thermal</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning, tau_e calculated with stored energy MHD&quot;</span><span class="p">)</span>
                <span class="n">stored_energy</span> <span class="o">=</span> <span class="n">equilibrium_ods</span><span class="p">[</span><span class="s1">&#39;global_quantities&#39;</span><span class="p">][</span><span class="s1">&#39;energy_mhd&#39;</span><span class="p">]</span>
                <span class="n">info_string</span> <span class="o">+=</span> <span class="s2">&quot;Stored energy from: &#39;global_quantities&#39;][&#39;energy_mhd&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ods_n</span>
            <span class="c1"># Calculate tau_e</span>
            <span class="n">tau_e</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span>
                <span class="mf">56.2e-3</span>
                <span class="o">*</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.93</span>
                <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bt</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.15</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">nel</span> <span class="o">/</span> <span class="mf">1e19</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.41</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">power_loss</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.69</span>
                <span class="o">*</span> <span class="n">r_major</span><span class="o">**</span><span class="mf">1.97</span>
                <span class="o">*</span> <span class="n">kappa</span><span class="o">**</span><span class="mf">0.78</span>
                <span class="o">*</span> <span class="n">aspect</span><span class="o">**-</span><span class="mf">0.58</span>
                <span class="o">*</span> <span class="n">isotope_factor</span><span class="o">**</span><span class="mf">0.19</span>
            <span class="p">)</span>  <span class="c1"># [s]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;kappa&#39;</span><span class="p">,</span> <span class="s1">&#39;bt&#39;</span><span class="p">,</span> <span class="s1">&#39;ip&#39;</span><span class="p">,</span> <span class="s1">&#39;nel&#39;</span><span class="p">,</span> <span class="s1">&#39;power_loss&#39;</span><span class="p">,</span> <span class="s1">&#39;aspect&#39;</span><span class="p">,</span> <span class="s1">&#39;isotope_factor&#39;</span><span class="p">,</span> <span class="s1">&#39;tau_e&#39;</span><span class="p">]:</span>
                <span class="n">printd</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="nb">eval</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;summary_taue&#39;</span><span class="p">)</span>
            <span class="n">tau_e_scaling</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tau_e</span><span class="p">)</span>
            <span class="n">tau_e_MHD</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stored_energy</span> <span class="o">/</span> <span class="n">power_loss</span><span class="p">)</span>

    <span class="c1"># assign quantities in the ODS</span>
    <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;global_quantities&#39;</span><span class="p">][</span><span class="s1">&#39;tau_energy_98&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tau_e_scaling</span><span class="p">)</span>
    <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;global_quantities&#39;</span><span class="p">][</span><span class="s1">&#39;tau_energy&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tau_e_MHD</span><span class="p">)</span>

    <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities.tau_energy.source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info_string</span>
    <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities.tau_energy_98.source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;h98y2 scaling law&quot;</span>

    <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ods_n</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;core_sources&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">summary_heating_power</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Integrate power densities to the total and heating and current drive systems and fills summary.global_quantities</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="kn">import</span> <span class="n">ODS</span>

        <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;core_sources&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ods_n</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;core_sources&#39;</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
    <span class="n">index_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;nbi&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;ec&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;lh&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;ic&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;fusion&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;ohmic&#39;</span><span class="p">}</span>
    <span class="n">power_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;total_heating&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;nbi&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;ec&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;lh&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;ic&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;fusion&#39;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">if</span> <span class="s1">&#39;core_sources.source.0&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ods_n</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ods_n</span>
    <span class="n">q_init</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_sources&#39;</span><span class="p">][</span><span class="s1">&#39;time&#39;</span><span class="p">]),</span>
                         <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">])])</span>

    <span class="n">q_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;total_heating&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">q_init</span><span class="p">),</span>
        <span class="s1">&#39;nbi&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">q_init</span><span class="p">),</span>
        <span class="s1">&#39;ec&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">q_init</span><span class="p">),</span>
        <span class="s1">&#39;lh&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">q_init</span><span class="p">),</span>
        <span class="s1">&#39;ic&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">q_init</span><span class="p">),</span>
        <span class="s1">&#39;fusion&#39;</span><span class="p">:</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">q_init</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">]:</span>
        <span class="n">vol</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
            <span class="n">source_1d</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;identifier.index&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">index_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;electrons&#39;</span> <span class="ow">in</span> <span class="n">source_1d</span> <span class="ow">and</span> <span class="s1">&#39;energy&#39;</span> <span class="ow">in</span> <span class="n">source_1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">]:</span>
                    <span class="n">q_dict</span><span class="p">[</span><span class="s1">&#39;total_heating&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">source_1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;identifier.index&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">index_dict</span> <span class="ow">and</span> <span class="n">index_dict</span><span class="p">[</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;identifier.index&#39;</span><span class="p">]]</span> <span class="ow">in</span> <span class="n">q_dict</span><span class="p">:</span>
                        <span class="n">q_dict</span><span class="p">[</span><span class="n">index_dict</span><span class="p">[</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;identifier.index&#39;</span><span class="p">]]][</span><span class="n">time_index</span><span class="p">,:]</span>  <span class="o">+=</span> <span class="n">source_1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s1">&#39;total_ion_energy&#39;</span> <span class="ow">in</span> <span class="n">source_1d</span><span class="p">:</span>
                    <span class="n">q_dict</span><span class="p">[</span><span class="s1">&#39;total_heating&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">source_1d</span><span class="p">[</span><span class="s1">&#39;total_ion_energy&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;identifier.index&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">index_dict</span> <span class="ow">and</span> <span class="n">index_dict</span><span class="p">[</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;identifier.index&#39;</span><span class="p">]]</span> <span class="ow">in</span> <span class="n">q_dict</span><span class="p">:</span>
                        <span class="n">q_dict</span><span class="p">[</span><span class="n">index_dict</span><span class="p">[</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s1">&#39;identifier.index&#39;</span><span class="p">]]][</span><span class="n">time_index</span><span class="p">,:]</span> <span class="o">+=</span> <span class="n">source_1d</span><span class="p">[</span><span class="s1">&#39;total_ion_energy&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">power_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">power_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">q_dict</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">x</span><span class="o">=</span><span class="n">vol</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">power_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;total_heating&#39;</span><span class="p">:</span>
                <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.global_quantities.power_steady.value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">power_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;fusion&#39;</span><span class="p">:</span>
                <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.fusion.power.value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">power_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.fusion.neutron_power_total.value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">14.1</span> <span class="o">/</span> <span class="mf">3.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">power_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">continue</span>
            <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;summary.heating_current_drive.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">[0].power.value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">power_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

    <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;summary.time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">ods_n</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">summary_global_quantities</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates global quantities for each time slice and stores them in the summary ods:</span>
<span class="sd">     - Greenwald Fraction</span>
<span class="sd">     - Energy confinement time estimated from the IPB98(y,2) scaling</span>
<span class="sd">     - Integrate power densities to the totals</span>
<span class="sd">     - Generate summary.global_quantities from global_quantities of other IDSs</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="kn">import</span> <span class="n">ODS</span>

        <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="n">ods_n</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">physics_summary_greenwald</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">))</span>
    <span class="n">ods_n</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">physics_summary_currents</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">))</span>
    <span class="n">ods_n</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">physics_summary_thermal_stored_energy</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">))</span>
    <span class="n">ods_n</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">physics_summary_heating_power</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">))</span>
    <span class="n">ods_n</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">physics_summary_taue</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">))</span>
    <span class="n">ods_n</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">physics_summary_consistent_global_quantities</span><span class="p">(</span><span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ods_n</span>


<span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">summary_consistent_global_quantities</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate summary.global_quantities from global_quantities of other IDSs</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param ds: IDS from which to update summary.global_quantities. All IDSs if `None`.</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="kn">import</span> <span class="n">ODS</span>

        <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="n">global_quantities</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">omas_global_quantities</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">imas_version</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">global_quantities</span><span class="p">))</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;summary&#39;</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">)</span>

    <span class="c1"># global_quantities destinations</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">global_quantities</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;summary&#39;</span><span class="p">:</span>
            <span class="n">dst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># global_quantities sources</span>
    <span class="n">src</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">global_quantities</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ds</span> <span class="ow">and</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ods</span> <span class="ow">and</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dst</span><span class="p">:</span>
            <span class="n">src</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="c1"># copy global_quantities from other IDSs to summary</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;summary.global_quantities.</span><span class="si">{</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">.value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
            <span class="n">ods_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;summary.global_quantities.</span><span class="si">{</span><span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">.source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Consistency with &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ods_n</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">core_profiles_consistent</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_electrons_density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enforce_quasineutrality</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls all core_profiles consistency functions including</span>
<span class="sd">      - core_profiles_densities</span>
<span class="sd">      - core_profiles_pressures</span>
<span class="sd">      - core_profiles_zeff</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :param use_electrons_density:</span>
<span class="sd">            denominator is core_profiles.profiles_1d.:.electrons.density</span>
<span class="sd">            instead of sum Z*n_i in Z_eff calculation</span>

<span class="sd">    :param enforce_quasineutrality: update electron density to be quasineutral with ions</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ods</span> <span class="o">=</span> <span class="n">core_profiles_densities</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">,</span> <span class="n">enforce_quasineutrality</span><span class="o">=</span><span class="n">enforce_quasineutrality</span><span class="p">)</span>
    <span class="n">core_profiles_pressures</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>
    <span class="n">core_profiles_zeff</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">use_electrons_density</span><span class="o">=</span><span class="n">use_electrons_density</span><span class="p">,</span> <span class="n">enforce_quasineutrality</span><span class="o">=</span><span class="n">enforce_quasineutrality</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ods</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">core_profiles_pressures</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates individual ions pressures</span>

<span class="sd">        `core_profiles.profiles_1d.:.ion.:.pressure_thermal` #Pressure (thermal) associated with random motion ~average((v-average(v))^2)</span>
<span class="sd">        `core_profiles.profiles_1d.:.ion.:.pressure`         #Pressure (thermal+non-thermal)</span>

<span class="sd">    as well as total pressures</span>

<span class="sd">        `core_profiles.profiles_1d.:.pressure_thermal`       #Thermal pressure (electrons+ions)</span>
<span class="sd">        `core_profiles.profiles_1d.:.pressure_ion_total`     #Total (sum over ion species) thermal ion pressure</span>
<span class="sd">        `core_profiles.profiles_1d.:.pressure_perpendicular` #Total perpendicular pressure (electrons+ions, thermal+non-thermal)</span>
<span class="sd">        `core_profiles.profiles_1d.:.pressure_parallel`      #Total parallel pressure (electrons+ions, thermal+non-thermal)</span>

<span class="sd">    NOTE: the fast particles ion pressures are read, not set by this function:</span>

<span class="sd">        `core_profiles.profiles_1d.:.ion.:.pressure_fast_parallel`      #Pressure (thermal) associated with random motion ~average((v-average(v))^2)</span>
<span class="sd">        `core_profiles.profiles_1d.:.ion.:.pressure_fast_perpendicular` #Pressure (thermal+non-thermal)</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ods_p</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="kn">import</span> <span class="n">ODS</span>

        <span class="n">ods_p</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">]:</span>
        <span class="n">prof1d</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="n">prof1d_p</span> <span class="o">=</span> <span class="n">ods_p</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>

        <span class="n">__zeros__</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>

        <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>
        <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_ion_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>
        <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_perpendicular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>
        <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_parallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>

        <span class="c1"># electrons</span>
        <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>

        <span class="n">__p__</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;density_thermal&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;temperature&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">]:</span>
            <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;pressure_thermal&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">]:</span>
            <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">__p__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__p__</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_perpendicular&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span> <span class="o">/</span> <span class="mf">3.0</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_parallel&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span> <span class="o">/</span> <span class="mf">3.0</span>

        <span class="k">if</span> <span class="s1">&#39;pressure_fast_perpendicular&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">]:</span>
            <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure_fast_perpendicular&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure_fast_perpendicular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__p__</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">__p__</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_perpendicular&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>

        <span class="k">if</span> <span class="s1">&#39;pressure_fast_parallel&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">]:</span>
            <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure_fast_parallel&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure_fast_parallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__p__</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_parallel&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>

        <span class="c1"># ions</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">])):</span>

            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>

            <span class="n">__p__</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;density_thermal&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;temperature&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">e</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;pressure_thermal&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">__p__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__p__</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_perpendicular&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span> <span class="o">/</span> <span class="mf">3.0</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_parallel&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span> <span class="o">/</span> <span class="mf">3.0</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_ion_total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>

            <span class="k">if</span> <span class="s1">&#39;pressure_fast_perpendicular&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure_fast_perpendicular&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
                    <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure_fast_perpendicular&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__p__</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">__p__</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_perpendicular&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>

            <span class="k">if</span> <span class="s1">&#39;pressure_fast_parallel&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">__p__</span> <span class="o">=</span> <span class="n">nominal_values</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure_fast_parallel&#39;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
                    <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure_fast_parallel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__p__</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>
                <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_parallel&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">__p__</span>

        <span class="c1"># extra pressure information that is not within IMAS structure is set only if consistency_check is False</span>
        <span class="k">if</span> <span class="n">ods_p</span><span class="o">.</span><span class="n">consistency_check</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_perpendicular&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_parallel&#39;</span><span class="p">]</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_electron_total&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_ion_total&#39;</span><span class="p">]</span>
            <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_fast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof1d_p</span><span class="p">[</span><span class="s1">&#39;pressure_thermal&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ods_p</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">core_profiles_densities</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enforce_quasineutrality</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Density, density_thermal, and density_fast for electrons and ions are filled and are self-consistent</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :param enforce_quasineutrality: update electron density to be quasineutral with ions</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ods</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="kn">import</span> <span class="n">ODS</span>

        <span class="n">ods_n</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span><span class="o">.</span><span class="n">copy_attrs_from</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">consistent_density</span><span class="p">(</span><span class="n">loc</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;density&#39;</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">:</span>

            <span class="c1"># if there is no thermal nor fast, assume it is thermal</span>
            <span class="k">if</span> <span class="s1">&#39;density_thermal&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loc</span> <span class="ow">and</span> <span class="s1">&#39;density_fast&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">:</span>
                <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span>

            <span class="c1"># if there is no thermal calculate it</span>
            <span class="k">elif</span> <span class="s1">&#39;density_thermal&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loc</span> <span class="ow">and</span> <span class="s1">&#39;density_fast&#39;</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">:</span>
                <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density_fast&#39;</span><span class="p">]</span>

            <span class="c1"># if there is no fast calculate it</span>
            <span class="k">elif</span> <span class="s1">&#39;density_thermal&#39;</span> <span class="ow">in</span> <span class="n">loc</span> <span class="ow">and</span> <span class="s1">&#39;density_fast&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">:</span>
                <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density_fast&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">]</span>

        <span class="c1"># enforce self-consistency</span>
        <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">density</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;density_thermal&#39;</span><span class="p">,</span> <span class="s1">&#39;density_fast&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">density</span> <span class="ow">in</span> <span class="n">loc</span><span class="p">:</span>
                <span class="n">loc</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">loc</span><span class="p">[</span><span class="n">density</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loc</span><span class="p">[</span><span class="n">density</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">]:</span>
        <span class="n">prof1d</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="n">prof1d_n</span> <span class="o">=</span> <span class="n">ods_n</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">prof1d_n</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>

        <span class="n">__zeros__</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>

        <span class="c1"># electrons</span>
        <span class="n">consistent_density</span><span class="p">(</span><span class="n">prof1d_n</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">])</span>

        <span class="c1"># ions</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">])):</span>
            <span class="n">consistent_density</span><span class="p">(</span><span class="n">prof1d_n</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">enforce_quasineutrality</span><span class="p">:</span>
            <span class="n">ne_q</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">__zeros__</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prof1d_n</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">])):</span>
                <span class="n">ne_q</span> <span class="o">+=</span> <span class="n">prof1d_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ion[</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">].element[0].z_n&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">prof1d_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;ion[</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">].density&#39;</span><span class="p">]</span>
            <span class="n">qnfac</span> <span class="o">=</span> <span class="n">ne_q</span> <span class="o">/</span> <span class="p">(</span><span class="n">prof1d_n</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;electrons.density&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">tiny</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">den</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">,</span> <span class="s1">&#39;density_fast&#39;</span><span class="p">,</span> <span class="s1">&#39;density_thermal&#39;</span><span class="p">]:</span>
                <span class="n">prof1d_n</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="n">den</span><span class="p">]</span> <span class="o">*=</span> <span class="n">qnfac</span>

    <span class="k">return</span> <span class="n">ods_n</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">core_profiles_zeff</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_electrons_density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enforce_quasineutrality</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    calculates effective charge</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param update: operate in place</span>

<span class="sd">    :param use_electrons_density:</span>
<span class="sd">            denominator core_profiles.profiles_1d.:.electrons.density</span>
<span class="sd">            instead of sum Z*n_i</span>

<span class="sd">    :param enforce_quasineutrality: update electron density to be quasineutral with ions</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ods_z</span> <span class="o">=</span> <span class="n">core_profiles_densities</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="n">update</span><span class="p">,</span> <span class="n">enforce_quasineutrality</span><span class="o">=</span><span class="n">enforce_quasineutrality</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">]:</span>
        <span class="n">prof1d</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="n">prof1d_z</span> <span class="o">=</span> <span class="n">ods_z</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>

        <span class="n">Z2n</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">prof1d_z</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>
        <span class="n">Zn</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">prof1d_z</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">])):</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;z_n&#39;</span><span class="p">]</span>  <span class="c1"># from old ODS</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">prof1d_z</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;density&#39;</span><span class="p">]</span>  <span class="c1"># from new ODS</span>
            <span class="n">Z2n</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">Z</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">Zn</span> <span class="o">+=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">Z</span>
        <span class="k">if</span> <span class="n">use_electrons_density</span><span class="p">:</span>
            <span class="n">prof1d_z</span><span class="p">[</span><span class="s1">&#39;zeff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z2n</span> <span class="o">/</span> <span class="n">prof1d_z</span><span class="p">[</span><span class="s1">&#39;electrons&#39;</span><span class="p">][</span><span class="s1">&#39;density&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prof1d_z</span><span class="p">[</span><span class="s1">&#39;zeff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z2n</span> <span class="o">/</span> <span class="n">Zn</span>
    <span class="k">return</span> <span class="n">ods_z</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">,</span> <span class="s1">&#39;core_profiles&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">current_from_eq</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function sets the currents in ods[&#39;core_profiles&#39;][&#39;profiles_1d&#39;][time_index]</span>
<span class="sd">    using ods[&#39;equilibrium&#39;][&#39;time_slice&#39;][time_index][&#39;profiles_1d&#39;][&#39;j_tor&#39;]</span>

<span class="sd">    :param ods: ODS to update in-place</span>

<span class="sd">    :param time_index: ODS time index to updated</span>
<span class="sd">    if None, all times are updated</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># run an all time slices if time_index is None</span>
    <span class="k">if</span> <span class="n">time_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">itime</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">]:</span>
            <span class="n">current_from_eq</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="n">itime</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">rho</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_1d.rho_tor_norm&#39;</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">coordsio</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;core_profiles.profiles_1d.</span><span class="si">%d</span><span class="s1">.grid.rho_tor_norm&#39;</span> <span class="o">%</span> <span class="n">time_index</span><span class="p">:</span> <span class="n">rho</span><span class="p">}):</span>
        <span class="c1"># call all current ohmic to start</span>
        <span class="n">fsa_invR</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;gm9&#39;</span><span class="p">]</span>
        <span class="n">JtoR_tot</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;j_tor&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">fsa_invR</span>
        <span class="k">if</span> <span class="s1">&#39;core_profiles.vacuum_toroidal_field.b0&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
            <span class="n">B0</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;b0&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;equilibrium.vacuum_toroidal_field.b0&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
            <span class="n">R0</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;r0&#39;</span><span class="p">]</span>
            <span class="n">B0</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;b0&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
            <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;r0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R0</span>
            <span class="n">ods</span><span class="o">.</span><span class="n">set_time_array</span><span class="p">(</span><span class="s1">&#39;core_profiles.vacuum_toroidal_field.b0&#39;</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">B0</span><span class="p">)</span>

        <span class="n">JparB_tot</span> <span class="o">=</span> <span class="n">transform_current</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">JtoR</span><span class="o">=</span><span class="n">JtoR_tot</span><span class="p">,</span> <span class="n">equilibrium</span><span class="o">=</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">],</span> <span class="n">includes_bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">core_profiles_currents</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">j_total</span><span class="o">=</span><span class="n">JparB_tot</span> <span class="o">/</span> <span class="n">B0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
        <span class="c1"># redo but wipe out old current components since we can&#39;t make it consistent</span>
        <span class="n">core_profiles_currents</span><span class="p">(</span>
            <span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">j_actuator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">j_bootstrap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">j_ohmic</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">j_non_inductive</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">j_total</span><span class="o">=</span><span class="n">JparB_tot</span> <span class="o">/</span> <span class="n">B0</span>
        <span class="p">)</span>

    <span class="k">return</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">,</span> <span class="s1">&#39;core_profiles&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">core_profiles_currents</span><span class="p">(</span>
    <span class="n">ods</span><span class="p">,</span>
    <span class="n">time_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">rho_tor_norm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">j_actuator</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
    <span class="n">j_bootstrap</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
    <span class="n">j_ohmic</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
    <span class="n">j_non_inductive</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
    <span class="n">j_total</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
    <span class="n">warn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function sets currents in ods[&#39;core_profiles&#39;][&#39;profiles_1d&#39;][time_index]</span>

<span class="sd">    If provided currents are inconsistent with each other or ods, ods is not updated and an error is thrown.</span>

<span class="sd">    Updates integrated currents in ods[&#39;core_profiles&#39;][&#39;global_quantities&#39;]</span>
<span class="sd">    (N.B.: `equilibrium` IDS is required for evaluating j_tor and integrated currents)</span>

<span class="sd">    :param ods: ODS to update in-place</span>

<span class="sd">    :param time_index: ODS time index to updated</span>
<span class="sd">    if None, all times are updated</span>

<span class="sd">    :param rho_tor_norm:  normalized rho grid upon which each j is given</span>

<span class="sd">    For each j:</span>
<span class="sd">      - ndarray: set in ods if consistent</span>
<span class="sd">      - &#39;default&#39;: use value in ods if present, else set to None</span>
<span class="sd">      - None: try to calculate from currents; delete from ods if you can&#39;t</span>

<span class="sd">    :param j_actuator: Non-inductive, non-bootstrap current &lt;J.B&gt;/B0</span>
<span class="sd">        N.B.: used for calculating other currents and consistency, but not set in ods</span>

<span class="sd">    :param j_bootstrap: Bootstrap component of &lt;J.B&gt;/B0</span>

<span class="sd">    :param j_ohmic: Ohmic component of &lt;J.B&gt;/B0</span>

<span class="sd">    :param j_non_inductive: Non-inductive component of &lt;J.B&gt;/B0</span>
<span class="sd">        Consistency requires j_non_inductive = j_actuator + j_bootstrap, either</span>
<span class="sd">        as explicitly provided or as computed from other components.</span>

<span class="sd">    :param j_total: Total &lt;J.B&gt;/B0</span>
<span class="sd">        Consistency requires j_total = j_ohmic + j_non_inductive either as</span>
<span class="sd">        explicitly provided or as computed from other components.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># run an all time slices if time_index is None</span>
    <span class="k">if</span> <span class="n">time_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">itime</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles.profiles_1d&#39;</span><span class="p">]:</span>
            <span class="n">core_profiles_currents</span><span class="p">(</span>
                <span class="n">ods</span><span class="p">,</span>
                <span class="n">time_index</span><span class="o">=</span><span class="n">itime</span><span class="p">,</span>
                <span class="n">rho_tor_norm</span><span class="o">=</span><span class="n">rho_tor_norm</span><span class="p">,</span>
                <span class="n">j_actuator</span><span class="o">=</span><span class="n">j_actuator</span><span class="p">,</span>
                <span class="n">j_bootstrap</span><span class="o">=</span><span class="n">j_bootstrap</span><span class="p">,</span>
                <span class="n">j_ohmic</span><span class="o">=</span><span class="n">j_ohmic</span><span class="p">,</span>
                <span class="n">j_non_inductive</span><span class="o">=</span><span class="n">j_non_inductive</span><span class="p">,</span>
                <span class="n">j_total</span><span class="o">=</span><span class="n">j_total</span><span class="p">,</span>
                <span class="n">warn</span><span class="o">=</span><span class="n">warn</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">cumulative_trapezoid</span> <span class="k">as</span> <span class="n">cumtrapz</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">cumtrapz</span>

    <span class="n">prof1d</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles.profiles_1d&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">rho_tor_norm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rho_tor_norm</span> <span class="o">=</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;grid.rho_tor_norm&#39;</span><span class="p">]</span>

    <span class="c1"># SETUP DEFAULTS</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">coordsio</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;core_profiles.profiles_1d.</span><span class="si">%d</span><span class="s1">.grid.rho_tor_norm&#39;</span> <span class="o">%</span> <span class="n">time_index</span><span class="p">:</span> <span class="n">rho_tor_norm</span><span class="p">}):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;j_actuator&#39;</span><span class="p">,</span> <span class="s1">&#39;j_bootstrap&#39;</span><span class="p">,</span> <span class="s1">&#39;j_non_inductive&#39;</span><span class="p">,</span> <span class="s1">&#39;j_ohmic&#39;</span><span class="p">,</span> <span class="s1">&#39;j_total&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">eval</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">prof1d</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="s1">&#39;j_actuator&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;core_sources&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">core_sources_j_parallel_sum</span><span class="p">(</span><span class="n">ods</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="s1">&#39;j_actuator&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="s1">&#39;j_bootstrap&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;j_non_inductive&#39;</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">)):</span>
                    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;j_actuator&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;j_non_inductive&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">prof1d</span><span class="p">[</span><span class="s1">&#39;j_bootstrap&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="n">j_actuator</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;j_actuator&#39;</span><span class="p">]</span>
    <span class="n">j_bootstrap</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;j_bootstrap&#39;</span><span class="p">]</span>
    <span class="n">j_ohmic</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;j_ohmic&#39;</span><span class="p">]</span>
    <span class="n">j_non_inductive</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;j_non_inductive&#39;</span><span class="p">]</span>
    <span class="n">j_total</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;j_total&#39;</span><span class="p">]</span>

    <span class="c1"># =================</span>
    <span class="c1"># UPDATE FORWARD</span>
    <span class="c1"># =================</span>

    <span class="c1"># j_non_inductive</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j_actuator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_bootstrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">j_non_inductive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">j_non_inductive</span> <span class="o">=</span> <span class="n">j_actuator</span> <span class="o">+</span> <span class="n">j_bootstrap</span>

    <span class="c1"># j_total</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j_ohmic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_non_inductive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">j_total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">j_total</span> <span class="o">=</span> <span class="n">j_ohmic</span> <span class="o">+</span> <span class="n">j_non_inductive</span>

    <span class="c1"># get some quantities we&#39;ll use below</span>
    <span class="k">if</span> <span class="s1">&#39;equilibrium.time_slice.</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;core_profiles.vacuum_toroidal_field.b0&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
            <span class="n">B0</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;b0&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;equilibrium.vacuum_toroidal_field.b0&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
            <span class="n">R0</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;r0&#39;</span><span class="p">]</span>
            <span class="n">B0</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;b0&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
            <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles&#39;</span><span class="p">][</span><span class="s1">&#39;vacuum_toroidal_field&#39;</span><span class="p">][</span><span class="s1">&#39;r0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R0</span>
            <span class="n">ods</span><span class="o">.</span><span class="n">set_time_array</span><span class="p">(</span><span class="s1">&#39;core_profiles.vacuum_toroidal_field.b0&#39;</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">B0</span><span class="p">)</span>
        <span class="n">fsa_invR</span> <span class="o">=</span> <span class="n">omas_interp1d</span><span class="p">(</span><span class="n">rho_tor_norm</span><span class="p">,</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">],</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;gm9&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># can&#39;t do any computations with the equilibrium</span>
        <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
            <span class="n">printe</span><span class="p">(</span><span class="s2">&quot;Warning: ods[&#39;equilibrium&#39;] does not exist: Can&#39;t convert between j_total and j_tor or calculate integrated currents&quot;</span><span class="p">)</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># j_tor</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">eq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">JparB_tot</span> <span class="o">=</span> <span class="n">j_total</span> <span class="o">*</span> <span class="n">B0</span>
        <span class="n">JtoR_tot</span> <span class="o">=</span> <span class="n">transform_current</span><span class="p">(</span><span class="n">rho_tor_norm</span><span class="p">,</span> <span class="n">JparB</span><span class="o">=</span><span class="n">JparB_tot</span><span class="p">,</span> <span class="n">equilibrium</span><span class="o">=</span><span class="n">eq</span><span class="p">,</span> <span class="n">includes_bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">j_tor</span> <span class="o">=</span> <span class="n">JtoR_tot</span> <span class="o">/</span> <span class="n">fsa_invR</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">j_tor</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># =================</span>
    <span class="c1"># UPDATE BACKWARD</span>
    <span class="c1"># =================</span>

    <span class="k">if</span> <span class="n">j_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># j_non_inductive</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">j_non_inductive</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_ohmic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">j_non_inductive</span> <span class="o">=</span> <span class="n">j_total</span> <span class="o">-</span> <span class="n">j_ohmic</span>

        <span class="c1"># j_ohmic</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">j_ohmic</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_non_inductive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">j_ohmic</span> <span class="o">=</span> <span class="n">j_total</span> <span class="o">-</span> <span class="n">j_non_inductive</span>

    <span class="k">if</span> <span class="n">j_non_inductive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

        <span class="c1"># j_actuator</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">j_actuator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_bootstrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">j_actuator</span> <span class="o">=</span> <span class="n">j_non_inductive</span> <span class="o">-</span> <span class="n">j_bootstrap</span>

        <span class="c1"># j_bootstrap</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">j_bootstrap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_actuator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">j_bootstrap</span> <span class="o">=</span> <span class="n">j_non_inductive</span> <span class="o">-</span> <span class="n">j_actuator</span>

    <span class="c1"># ===============</span>
    <span class="c1"># CONSISTENCY?</span>
    <span class="c1"># ===============</span>

    <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;Cannot set j_actuator without j_bootstrap provided or calculable&quot;</span>
    <span class="k">if</span> <span class="n">j_actuator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">j_bootstrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="n">err</span>

    <span class="c1"># j_non_inductive</span>
    <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;j_non_inductive inconsistent with j_actuator and j_bootstrap&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j_non_inductive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">j_actuator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">j_bootstrap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">j_non_inductive</span><span class="p">,</span> <span class="n">j_actuator</span> <span class="o">+</span> <span class="n">j_bootstrap</span><span class="p">),</span> <span class="n">err</span>

    <span class="c1"># j_total</span>
    <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;j_total inconsistent with j_ohmic and j_non_inductive&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">j_ohmic</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">j_non_inductive</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)):</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">j_total</span><span class="p">,</span> <span class="n">j_ohmic</span> <span class="o">+</span> <span class="n">j_non_inductive</span><span class="p">),</span> <span class="n">err</span>

    <span class="c1"># j_tor</span>
    <span class="n">err</span> <span class="o">=</span> <span class="s1">&#39;j_tor inconsistent with j_total&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j_total</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">j_tor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">eq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">JparB_tot</span> <span class="o">=</span> <span class="n">j_total</span> <span class="o">*</span> <span class="n">B0</span>
            <span class="n">JtoR_tot</span> <span class="o">=</span> <span class="n">transform_current</span><span class="p">(</span><span class="n">rho_tor_norm</span><span class="p">,</span> <span class="n">JparB</span><span class="o">=</span><span class="n">JparB_tot</span><span class="p">,</span> <span class="n">equilibrium</span><span class="o">=</span><span class="n">eq</span><span class="p">,</span> <span class="n">includes_bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">j_tor</span><span class="p">,</span> <span class="n">JtoR_tot</span> <span class="o">/</span> <span class="n">fsa_invR</span><span class="p">),</span> <span class="n">err</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warn</span><span class="p">:</span>
                <span class="n">printe</span><span class="p">(</span><span class="s2">&quot;Warning: ods[&#39;equilibrium&#39;] does not exist&quot;</span><span class="p">)</span>
                <span class="n">printe</span><span class="p">(</span><span class="s2">&quot;         can&#39;t determine if &quot;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>

    <span class="c1"># =============</span>
    <span class="c1"># UPDATE ODS</span>
    <span class="c1"># =============</span>
    <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">coordsio</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;core_profiles.profiles_1d.</span><span class="si">%d</span><span class="s1">.grid.rho_tor_norm&#39;</span> <span class="o">%</span> <span class="n">time_index</span><span class="p">:</span> <span class="n">rho_tor_norm</span><span class="p">}):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;j_bootstrap&#39;</span><span class="p">,</span> <span class="s1">&#39;j_non_inductive&#39;</span><span class="p">,</span> <span class="s1">&#39;j_ohmic&#39;</span><span class="p">,</span> <span class="s1">&#39;j_total&#39;</span><span class="p">,</span> <span class="s1">&#39;j_tor&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prof1d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">prof1d</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

    <span class="c1"># ======================</span>
    <span class="c1"># INTEGRATED CURRENTS</span>
    <span class="c1"># ======================</span>
    <span class="k">if</span> <span class="n">eq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># can&#39;t integrate currents without the equilibrium</span>
        <span class="k">return</span>

    <span class="c1"># Calculate integrated currents</span>
    <span class="n">rho_eq</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">]</span>
    <span class="n">vp</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;dvolume_dpsi&#39;</span><span class="p">]</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;psi&#39;</span><span class="p">]</span>
    <span class="n">fsa_invR</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">][</span><span class="s1">&#39;gm9&#39;</span><span class="p">]</span>
    <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">coordsio</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;core_profiles.profiles_1d.</span><span class="si">%d</span><span class="s1">.grid.rho_tor_norm&#39;</span> <span class="o">%</span> <span class="n">time_index</span><span class="p">:</span> <span class="n">rho_eq</span><span class="p">}):</span>

        <span class="n">currents</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;j_bootstrap&#39;</span><span class="p">,</span> <span class="s1">&#39;current_bootstrap&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;j_non_inductive&#39;</span><span class="p">,</span> <span class="s1">&#39;current_non_inductive&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;j_tor&#39;</span><span class="p">,</span> <span class="s1">&#39;ip&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">Jname</span><span class="p">,</span> <span class="n">Iname</span><span class="p">,</span> <span class="n">transform</span> <span class="ow">in</span> <span class="n">currents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Jname</span> <span class="ow">in</span> <span class="n">prof1d</span><span class="p">:</span>
                <span class="n">J</span> <span class="o">=</span> <span class="n">prof1d</span><span class="p">[</span><span class="n">Jname</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">transform</span><span class="p">:</span>
                    <span class="c1"># transform &lt;J.B&gt;/B0 to &lt;Jt/R&gt;</span>
                    <span class="n">J</span> <span class="o">=</span> <span class="n">transform_current</span><span class="p">(</span><span class="n">rho_eq</span><span class="p">,</span> <span class="n">JparB</span><span class="o">=</span><span class="n">J</span> <span class="o">*</span> <span class="n">B0</span><span class="p">,</span> <span class="n">equilibrium</span><span class="o">=</span><span class="n">eq</span><span class="p">,</span> <span class="n">includes_bootstrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># already &lt;Jt/R&gt;/&lt;1/R&gt;</span>
                    <span class="n">J</span> <span class="o">*=</span> <span class="n">fsa_invR</span>
                <span class="n">ods</span><span class="o">.</span><span class="n">set_time_array</span><span class="p">(</span><span class="s1">&#39;core_profiles.global_quantities.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Iname</span><span class="p">,</span> <span class="n">time_index</span><span class="p">,</span> <span class="n">cumtrapz</span><span class="p">(</span><span class="n">vp</span> <span class="o">*</span> <span class="n">J</span><span class="p">,</span> <span class="n">psi</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
            <span class="k">elif</span> <span class="s1">&#39;core_profiles.global_quantities.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Iname</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                <span class="c1"># set current to zero if this time_index exists already</span>
                <span class="k">if</span> <span class="n">time_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles.global_quantities.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Iname</span><span class="p">]):</span>
                    <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_profiles.global_quantities.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Iname</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">return</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">wall_add</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">machine</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add wall information to the ODS</span>

<span class="sd">    :param ods: ODS to update in-place</span>

<span class="sd">    :param machine: machine of which to load the wall (if None it is taken from ods[&#39;dataset_description.data_entry.machine&#39;])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">machine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;machine&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;dataset_description.data_entry&#39;</span><span class="p">]:</span>
            <span class="n">machine</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;dataset_description.data_entry.machine&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s1">&#39;Could not figure out what machine wall to use: dataset_description.data_entry.machine is not set&#39;</span><span class="p">)</span>

    <span class="c1"># fmt: off</span>
    <span class="n">walls</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">walls</span><span class="p">[</span><span class="s1">&#39;iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;RLIM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">6.267</span><span class="p">,</span> <span class="mf">7.283</span><span class="p">,</span> <span class="mf">7.899</span><span class="p">,</span> <span class="mf">8.306</span><span class="p">,</span> <span class="mf">8.395</span><span class="p">,</span> <span class="mf">8.27</span><span class="p">,</span> <span class="mf">7.904</span><span class="p">,</span> <span class="mf">7.4</span><span class="p">,</span>
                              <span class="mf">6.587</span><span class="p">,</span> <span class="mf">5.753</span><span class="p">,</span> <span class="mf">4.904</span><span class="p">,</span> <span class="mf">4.311</span><span class="p">,</span> <span class="mf">4.126</span><span class="p">,</span> <span class="mf">4.076</span><span class="p">,</span> <span class="mf">4.046</span><span class="p">,</span> <span class="mf">4.046</span><span class="p">,</span>
                              <span class="mf">4.067</span><span class="p">,</span> <span class="mf">4.097</span><span class="p">,</span> <span class="mf">4.178</span><span class="p">,</span> <span class="mf">3.9579</span><span class="p">,</span> <span class="mf">4.0034</span><span class="p">,</span> <span class="mf">4.1742</span><span class="p">,</span> <span class="mf">4.3257</span><span class="p">,</span> <span class="mf">4.4408</span><span class="p">,</span>
                              <span class="mf">4.5066</span><span class="p">,</span> <span class="mf">4.5157</span><span class="p">,</span> <span class="mf">4.467</span><span class="p">,</span> <span class="mf">4.4064</span><span class="p">,</span> <span class="mf">4.4062</span><span class="p">,</span> <span class="mf">4.3773</span><span class="p">,</span> <span class="mf">4.3115</span><span class="p">,</span> <span class="mf">4.2457</span><span class="p">,</span>
                              <span class="mf">4.1799</span><span class="p">,</span> <span class="mf">4.4918</span><span class="p">,</span> <span class="mf">4.5687</span><span class="p">,</span> <span class="mf">4.6456</span><span class="p">,</span> <span class="mf">4.8215</span><span class="p">,</span> <span class="mf">4.9982</span><span class="p">,</span> <span class="mf">5.1496</span><span class="p">,</span> <span class="mf">5.2529</span><span class="p">,</span>
                              <span class="mf">5.2628</span><span class="p">,</span> <span class="mf">5.2727</span><span class="p">,</span> <span class="mf">5.565</span><span class="p">,</span> <span class="mf">5.565</span><span class="p">,</span> <span class="mf">5.565</span><span class="p">,</span> <span class="mf">5.565</span><span class="p">,</span> <span class="mf">5.572</span><span class="p">,</span> <span class="mf">5.572</span><span class="p">,</span>
                              <span class="mf">5.572</span><span class="p">,</span> <span class="mf">5.572</span><span class="p">,</span> <span class="mf">5.6008</span><span class="p">,</span> <span class="mf">5.6842</span><span class="p">,</span> <span class="mf">5.815</span><span class="p">,</span> <span class="mf">5.9821</span><span class="p">,</span> <span class="mf">6.171</span><span class="p">,</span> <span class="mf">6.3655</span><span class="p">,</span>
                              <span class="mf">6.267</span><span class="p">],</span>
                     <span class="s1">&#39;ZLIM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">3.036</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.247</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.332</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.411</span><span class="p">,</span> <span class="mf">0.643</span><span class="p">,</span> <span class="mf">1.691</span><span class="p">,</span> <span class="mf">2.474</span><span class="p">,</span>
                              <span class="mf">3.189</span><span class="p">,</span> <span class="mf">3.904</span><span class="p">,</span> <span class="mf">4.542</span><span class="p">,</span> <span class="mf">4.722</span><span class="p">,</span> <span class="mf">4.334</span><span class="p">,</span> <span class="mf">3.592</span><span class="p">,</span> <span class="mf">2.576</span><span class="p">,</span>
                              <span class="mf">1.559</span><span class="p">,</span> <span class="mf">0.543</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.474</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.49</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.496</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5284</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.5284</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">2.5574</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.6414</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.7708</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.931</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.1039</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.2701</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.3943</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">3.3948</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.4699</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.6048</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.7397</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.8747</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.8992</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.8176</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">3.736</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.699</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.7314</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.8282</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.9752</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.1144</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.2536</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">4.5459</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.3926</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.2394</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0862</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.9861</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.9856</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.886</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">3.885</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.6924</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.5165</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.3723</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.2722</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.225</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.2346</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">3.036</span><span class="p">]}</span>
    <span class="n">walls</span><span class="p">[</span><span class="s1">&#39;west&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;RLIM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">2.86135614</span><span class="p">,</span> <span class="mf">2.87861924</span><span class="p">,</span> <span class="mf">2.90016384</span><span class="p">,</span> <span class="mf">2.91997554</span><span class="p">,</span> <span class="mf">2.93800414</span><span class="p">,</span>
                              <span class="mf">2.95420434</span><span class="p">,</span> <span class="mf">2.96853494</span><span class="p">,</span> <span class="mf">2.98095994</span><span class="p">,</span> <span class="mf">2.99144794</span><span class="p">,</span> <span class="mf">2.99997234</span><span class="p">,</span>
                              <span class="mf">3.00651164</span><span class="p">,</span> <span class="mf">3.01104944</span><span class="p">,</span> <span class="mf">3.01357414</span><span class="p">,</span> <span class="mf">3.01407934</span><span class="p">,</span> <span class="mf">3.01256394</span><span class="p">,</span>
                              <span class="mf">3.00903154</span><span class="p">,</span> <span class="mf">3.00349134</span><span class="p">,</span> <span class="mf">2.99595704</span><span class="p">,</span> <span class="mf">2.98644784</span><span class="p">,</span> <span class="mf">2.97498774</span><span class="p">,</span>
                              <span class="mf">2.96160574</span><span class="p">,</span> <span class="mf">2.94633544</span><span class="p">,</span> <span class="mf">2.92921564</span><span class="p">,</span> <span class="mf">2.91028954</span><span class="p">,</span> <span class="mf">2.88960484</span><span class="p">,</span>
                              <span class="mf">2.86721394</span><span class="p">,</span> <span class="mf">3.1298712</span><span class="p">,</span> <span class="mf">3.1117572</span><span class="p">,</span> <span class="mf">3.0928301</span><span class="p">,</span> <span class="mf">3.0731123</span><span class="p">,</span>
                              <span class="mf">3.0526269</span><span class="p">,</span> <span class="mf">3.031398</span><span class="p">,</span> <span class="mf">3.0094508</span><span class="p">,</span> <span class="mf">2.9868111</span><span class="p">,</span> <span class="mf">2.9635054</span><span class="p">,</span>
                              <span class="mf">2.9395614</span><span class="p">,</span> <span class="mf">2.9150072</span><span class="p">,</span> <span class="mf">2.8898718</span><span class="p">,</span> <span class="mf">2.8641847</span><span class="p">,</span> <span class="mf">2.8379762</span><span class="p">,</span>
                              <span class="mf">2.8112773</span><span class="p">,</span> <span class="mf">2.766</span><span class="p">,</span> <span class="mf">2.735</span><span class="p">,</span> <span class="mf">2.704</span><span class="p">,</span> <span class="mf">2.673</span><span class="p">,</span>
                              <span class="mf">2.642</span><span class="p">,</span> <span class="mf">2.611</span><span class="p">,</span> <span class="mf">2.58</span><span class="p">,</span> <span class="mf">2.549</span><span class="p">,</span> <span class="mf">2.518</span><span class="p">,</span>
                              <span class="mf">2.487</span><span class="p">,</span> <span class="mf">2.456</span><span class="p">,</span> <span class="mf">2.4446</span><span class="p">,</span> <span class="mf">2.4199</span><span class="p">,</span> <span class="mf">2.3952</span><span class="p">,</span>
                              <span class="mf">2.3705</span><span class="p">,</span> <span class="mf">2.3458</span><span class="p">,</span> <span class="mf">2.3211</span><span class="p">,</span> <span class="mf">2.2965</span><span class="p">,</span> <span class="mf">2.2718</span><span class="p">,</span>
                              <span class="mf">2.2471</span><span class="p">,</span> <span class="mf">2.2224</span><span class="p">,</span> <span class="mf">2.1977</span><span class="p">,</span> <span class="mf">2.173</span><span class="p">,</span> <span class="mf">2.1483</span><span class="p">,</span>
                              <span class="mf">2.1236</span><span class="p">,</span> <span class="mf">2.0989</span><span class="p">,</span> <span class="mf">2.0742</span><span class="p">,</span> <span class="mf">2.0495</span><span class="p">,</span> <span class="mf">2.0249</span><span class="p">,</span>
                              <span class="mf">2.0002</span><span class="p">,</span> <span class="mf">1.9755</span><span class="p">,</span> <span class="mf">1.9508</span><span class="p">,</span> <span class="mf">1.9261</span><span class="p">,</span> <span class="mf">1.9014</span><span class="p">,</span>
                              <span class="mf">1.8966603</span><span class="p">,</span> <span class="mf">1.8901254</span><span class="p">,</span> <span class="mf">1.8839482</span><span class="p">,</span> <span class="mf">1.8781297</span><span class="p">,</span> <span class="mf">1.8726708</span><span class="p">,</span>
                              <span class="mf">1.8675721</span><span class="p">,</span> <span class="mf">1.8628345</span><span class="p">,</span> <span class="mf">1.8584587</span><span class="p">,</span> <span class="mf">1.8544453</span><span class="p">,</span> <span class="mf">1.8507948</span><span class="p">,</span>
                              <span class="mf">1.8475079</span><span class="p">,</span> <span class="mf">1.844585</span><span class="p">,</span> <span class="mf">1.8420265</span><span class="p">,</span> <span class="mf">1.8398328</span><span class="p">,</span> <span class="mf">1.8380042</span><span class="p">,</span>
                              <span class="mf">1.836541</span><span class="p">,</span> <span class="mf">1.8354435</span><span class="p">,</span> <span class="mf">1.8347117</span><span class="p">,</span> <span class="mf">1.8343457</span><span class="p">,</span> <span class="mf">1.8343457</span><span class="p">,</span>
                              <span class="mf">1.8347117</span><span class="p">,</span> <span class="mf">1.8354435</span><span class="p">,</span> <span class="mf">1.836541</span><span class="p">,</span> <span class="mf">1.8380042</span><span class="p">,</span> <span class="mf">1.8398328</span><span class="p">,</span>
                              <span class="mf">1.8420265</span><span class="p">,</span> <span class="mf">1.844585</span><span class="p">,</span> <span class="mf">1.8475079</span><span class="p">,</span> <span class="mf">1.8507948</span><span class="p">,</span> <span class="mf">1.8544453</span><span class="p">,</span>
                              <span class="mf">1.8584587</span><span class="p">,</span> <span class="mf">1.8628345</span><span class="p">,</span> <span class="mf">1.8675721</span><span class="p">,</span> <span class="mf">1.8726708</span><span class="p">,</span> <span class="mf">1.8781297</span><span class="p">,</span>
                              <span class="mf">1.8839482</span><span class="p">,</span> <span class="mf">1.8901254</span><span class="p">,</span> <span class="mf">1.8966603</span><span class="p">,</span> <span class="mf">1.9091</span><span class="p">,</span> <span class="mf">1.928</span><span class="p">,</span>
                              <span class="mf">1.9468</span><span class="p">,</span> <span class="mf">1.9657</span><span class="p">,</span> <span class="mf">1.9845</span><span class="p">,</span> <span class="mf">2.0034</span><span class="p">,</span> <span class="mf">2.0222</span><span class="p">,</span>
                              <span class="mf">2.0411</span><span class="p">,</span> <span class="mf">2.0599</span><span class="p">,</span> <span class="mf">2.0788</span><span class="p">,</span> <span class="mf">2.0977</span><span class="p">,</span> <span class="mf">2.1165</span><span class="p">,</span>
                              <span class="mf">2.1354</span><span class="p">,</span> <span class="mf">2.1542</span><span class="p">,</span> <span class="mf">2.1731</span><span class="p">,</span> <span class="mf">2.1919</span><span class="p">,</span> <span class="mf">2.2108</span><span class="p">,</span>
                              <span class="mf">2.2297</span><span class="p">,</span> <span class="mf">2.2485</span><span class="p">,</span> <span class="mf">2.2674</span><span class="p">,</span> <span class="mf">2.2862</span><span class="p">,</span> <span class="mf">2.3051</span><span class="p">,</span>
                              <span class="mf">2.3239</span><span class="p">,</span> <span class="mf">2.3428</span><span class="p">,</span> <span class="mf">2.3616</span><span class="p">,</span> <span class="mf">2.3805</span><span class="p">,</span> <span class="mf">2.3895</span><span class="p">,</span>
                              <span class="mf">2.43351111</span><span class="p">,</span> <span class="mf">2.47752222</span><span class="p">,</span> <span class="mf">2.52153333</span><span class="p">,</span> <span class="mf">2.56554444</span><span class="p">,</span> <span class="mf">2.60955556</span><span class="p">,</span>
                              <span class="mf">2.65356667</span><span class="p">,</span> <span class="mf">2.69757778</span><span class="p">,</span> <span class="mf">2.74158889</span><span class="p">,</span> <span class="mf">2.7856</span><span class="p">,</span> <span class="mf">2.802274</span><span class="p">,</span>
                              <span class="mf">2.8291295</span><span class="p">,</span> <span class="mf">2.855505</span><span class="p">,</span> <span class="mf">2.8813692</span><span class="p">,</span> <span class="mf">2.9066919</span><span class="p">,</span> <span class="mf">2.9314431</span><span class="p">,</span>
                              <span class="mf">2.9555937</span><span class="p">,</span> <span class="mf">2.9791152</span><span class="p">,</span> <span class="mf">3.0019799</span><span class="p">,</span> <span class="mf">3.0241609</span><span class="p">,</span> <span class="mf">3.045632</span><span class="p">,</span>
                              <span class="mf">3.0663679</span><span class="p">,</span> <span class="mf">3.0863443</span><span class="p">,</span> <span class="mf">3.1055375</span><span class="p">,</span> <span class="mf">3.1239249</span><span class="p">,</span> <span class="mf">2.86135614</span><span class="p">],</span>
                     <span class="s1">&#39;ZLIM&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.4702282</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.44550049</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.41155163</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.37656315</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.34062343</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.30382328</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.26625564</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.22801541</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1891992</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.14990505</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.11023223</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.07028096</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.03015215</span><span class="p">,</span> <span class="mf">0.01005283</span><span class="p">,</span> <span class="mf">0.05023242</span><span class="p">,</span>
                              <span class="mf">0.09028511</span><span class="p">,</span> <span class="mf">0.13010973</span><span class="p">,</span> <span class="mf">0.16960569</span><span class="p">,</span> <span class="mf">0.20867321</span><span class="p">,</span> <span class="mf">0.2472136</span><span class="p">,</span>
                              <span class="mf">0.2851295</span><span class="p">,</span> <span class="mf">0.32232515</span><span class="p">,</span> <span class="mf">0.35870657</span><span class="p">,</span> <span class="mf">0.39418187</span><span class="p">,</span> <span class="mf">0.42866144</span><span class="p">,</span>
                              <span class="mf">0.46205816</span><span class="p">,</span> <span class="mf">0.51562535</span><span class="p">,</span> <span class="mf">0.53962674</span><span class="p">,</span> <span class="mf">0.56299231</span><span class="p">,</span> <span class="mf">0.58569451</span><span class="p">,</span>
                              <span class="mf">0.60770659</span><span class="p">,</span> <span class="mf">0.62900263</span><span class="p">,</span> <span class="mf">0.64955753</span><span class="p">,</span> <span class="mf">0.66934707</span><span class="p">,</span> <span class="mf">0.68834792</span><span class="p">,</span>
                              <span class="mf">0.70653771</span><span class="p">,</span> <span class="mf">0.723895</span><span class="p">,</span> <span class="mf">0.74039934</span><span class="p">,</span> <span class="mf">0.75603128</span><span class="p">,</span> <span class="mf">0.77077241</span><span class="p">,</span>
                              <span class="mf">0.78460535</span><span class="p">,</span> <span class="mf">0.7492</span><span class="p">,</span> <span class="mf">0.7492</span><span class="p">,</span> <span class="mf">0.7492</span><span class="p">,</span> <span class="mf">0.7492</span><span class="p">,</span>
                              <span class="mf">0.7492</span><span class="p">,</span> <span class="mf">0.7492</span><span class="p">,</span> <span class="mf">0.7492</span><span class="p">,</span> <span class="mf">0.7492</span><span class="p">,</span> <span class="mf">0.7492</span><span class="p">,</span>
                              <span class="mf">0.7492</span><span class="p">,</span> <span class="mf">0.7492</span><span class="p">,</span> <span class="mf">0.7986</span><span class="p">,</span> <span class="mf">0.7886</span><span class="p">,</span> <span class="mf">0.7787</span><span class="p">,</span>
                              <span class="mf">0.7687</span><span class="p">,</span> <span class="mf">0.7587</span><span class="p">,</span> <span class="mf">0.7487</span><span class="p">,</span> <span class="mf">0.7388</span><span class="p">,</span> <span class="mf">0.7288</span><span class="p">,</span>
                              <span class="mf">0.7188</span><span class="p">,</span> <span class="mf">0.7088</span><span class="p">,</span> <span class="mf">0.6989</span><span class="p">,</span> <span class="mf">0.6889</span><span class="p">,</span> <span class="mf">0.6789</span><span class="p">,</span>
                              <span class="mf">0.6689</span><span class="p">,</span> <span class="mf">0.659</span><span class="p">,</span> <span class="mf">0.649</span><span class="p">,</span> <span class="mf">0.639</span><span class="p">,</span> <span class="mf">0.6291</span><span class="p">,</span>
                              <span class="mf">0.6191</span><span class="p">,</span> <span class="mf">0.6091</span><span class="p">,</span> <span class="mf">0.5991</span><span class="p">,</span> <span class="mf">0.5892</span><span class="p">,</span> <span class="mf">0.5792</span><span class="p">,</span>
                              <span class="mf">0.555</span><span class="p">,</span> <span class="mf">0.52546258</span><span class="p">,</span> <span class="mf">0.49584828</span><span class="p">,</span> <span class="mf">0.46616143</span><span class="p">,</span> <span class="mf">0.43640637</span><span class="p">,</span>
                              <span class="mf">0.40658745</span><span class="p">,</span> <span class="mf">0.37670903</span><span class="p">,</span> <span class="mf">0.3467755</span><span class="p">,</span> <span class="mf">0.31679123</span><span class="p">,</span> <span class="mf">0.28676061</span><span class="p">,</span>
                              <span class="mf">0.25668802</span><span class="p">,</span> <span class="mf">0.22657788</span><span class="p">,</span> <span class="mf">0.19643458</span><span class="p">,</span> <span class="mf">0.16626254</span><span class="p">,</span> <span class="mf">0.13606618</span><span class="p">,</span>
                              <span class="mf">0.1058499</span><span class="p">,</span> <span class="mf">0.07561814</span><span class="p">,</span> <span class="mf">0.04537531</span><span class="p">,</span> <span class="mf">0.01512584</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01512584</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.04537531</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.07561814</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1058499</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.13606618</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.16626254</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.19643458</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.22657788</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25668802</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.28676061</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.31679123</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.3467755</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.37670903</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.40658745</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.43640637</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.46616143</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.49584828</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.52546258</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.555</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5798</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5874</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.595</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6026</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6102</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6178</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6254</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.633</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6406</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6482</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6558</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6634</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.671</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6786</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6862</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6938</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7014</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.709</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7166</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7242</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7318</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7394</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.747</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7546</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7622</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7698</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6754</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.6754</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6754</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6754</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6754</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6754</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.6754</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6754</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6754</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6754</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.78901166</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.77548512</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.76104485</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.74570785</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.7294922</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.71241701</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.69450238</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.67576944</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.65624025</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.63593783</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.61488609</span><span class="p">,</span>
                              <span class="o">-</span><span class="mf">0.59310985</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.57063475</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.54748729</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.52369473</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4702282</span><span class="p">]}</span>
    <span class="c1"># fmt: on</span>

    <span class="k">if</span> <span class="n">machine</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">walls</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s1">&#39;OMAS wall information only available for: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">walls</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;wall.description_2d.+.limiter.type.name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;first_wall&#39;</span>
    <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;wall.description_2d.-1.limiter.type.index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;wall.description_2d.-1.limiter.type.description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;first wall&#39;</span>
    <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;wall.description_2d.-1.limiter.unit.0.outline.r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">walls</span><span class="p">[</span><span class="n">machine</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s1">&#39;RLIM&#39;</span><span class="p">]</span>
    <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;wall.description_2d.-1.limiter.unit.0.outline.z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">walls</span><span class="p">[</span><span class="n">machine</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s1">&#39;ZLIM&#39;</span><span class="p">]</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">equilibrium_consistent</span><span class="p">(</span><span class="n">ods</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate missing derived quantities for equilibrium IDS</span>

<span class="sd">    :param ods: ODS to update in-place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">]:</span>
        <span class="n">eq</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">]</span>
        <span class="n">eq1d</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_1d&#39;</span><span class="p">]</span>

        <span class="n">psi</span> <span class="o">=</span> <span class="n">eq1d</span><span class="p">[</span><span class="s1">&#39;psi&#39;</span><span class="p">]</span>
        <span class="n">psi_norm</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">psi</span> <span class="o">-</span> <span class="n">psi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">psi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">psi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">psirz</span> <span class="o">=</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d.0.psi&#39;</span><span class="p">]</span>
        <span class="n">psirz_norm</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">psirz</span> <span class="o">-</span> <span class="n">psi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">psi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">psi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fpol</span> <span class="o">=</span> <span class="n">eq1d</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span>

        <span class="c1"># extend functions in PSI to be clamped at edge value when outside of PSI range (i.e. outside of LCFS)</span>
        <span class="n">ext_psi_norm_mesh</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">psi_norm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">psi_norm</span><span class="p">,</span> <span class="n">psi_norm</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e6</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">ext_arr</span><span class="p">(</span><span class="n">inv</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">inv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inv</span><span class="p">,</span> <span class="n">inv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">fpol</span> <span class="o">=</span> <span class="n">omas_interp1d</span><span class="p">(</span><span class="n">psirz_norm</span><span class="p">,</span> <span class="n">ext_psi_norm_mesh</span><span class="p">,</span> <span class="n">ext_arr</span><span class="p">(</span><span class="n">fpol</span><span class="p">))</span>
        <span class="n">Z</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d.0.grid.dim2&#39;</span><span class="p">],</span> <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d.0.grid.dim1&#39;</span><span class="p">])</span>
        <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d.0.r&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">R</span>
        <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d.0.z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Z</span>
        <span class="n">eq</span><span class="p">[</span><span class="s1">&#39;profiles_2d.0.b_field_tor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fpol</span> <span class="o">/</span> <span class="n">R</span>

    <span class="n">equilibrium_stored_energy</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ods</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;equilibrium&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">equilibrium_transpose_RZ</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">flip_dims</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transpose 2D grid values for RZ grids under equilibrium.time_slice.:.profiles_2d.:.</span>

<span class="sd">    :param ods: ODS to update in-place</span>

<span class="sd">    :param flip_dims: whether to switch the equilibrium.time_slice.:.profiles_2d.:.grid.dim1 and dim1</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">time_index</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">grid</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="n">grid</span><span class="p">][</span><span class="s1">&#39;grid_type.index&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">eq2D</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;equilibrium.time_slice&#39;</span><span class="p">][</span><span class="n">time_index</span><span class="p">][</span><span class="s1">&#39;profiles_2d&#39;</span><span class="p">][</span><span class="n">grid</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">eq2D</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eq2D</span><span class="p">[</span><span class="n">item</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">eq2D</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">eq2D</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">eq2D</span><span class="p">[</span><span class="n">item</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

                <span class="k">if</span> <span class="n">flip_dims</span><span class="p">:</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">eq2D</span><span class="p">[</span><span class="s1">&#39;grid.dim1&#39;</span><span class="p">]</span>
                    <span class="n">eq2D</span><span class="p">[</span><span class="s1">&#39;grid.dim1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ed2D</span><span class="p">[</span><span class="s1">&#39;grid.dim2&#39;</span><span class="p">]</span>
                    <span class="n">eq2D</span><span class="p">[</span><span class="s1">&#39;grid.dim1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>
    <span class="k">return</span> <span class="n">ods</span>


<span class="nd">@add_to__ODS__</span>
<span class="nd">@preprocess_ods</span><span class="p">(</span><span class="s1">&#39;magnetics&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">magnetics_sanitize</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">remove_bpol_probe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take data in legacy magnetics.bpol_probe and store it in current magnetics.b_field_pol_probe and magnetics.b_field_tor_probe</span>

<span class="sd">    :param ods: ODS to update in-place</span>

<span class="sd">    :return: updated ods</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;magnetics.bpol_probe&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ods</span>

    <span class="k">if</span> <span class="s1">&#39;magnetics.b_field_pol_probe&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;magnetics.b_field_pol_probe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;magnetics.b_field_tor_probe&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;magnetics.b_field_tor_probe&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="n">tor_angle</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;magnetics.bpol_probe[:].toroidal_angle&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;magnetics.bpol_probe&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;magnetics.bpol_probe.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">.toroidal_angle&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;magnetics.b_field_pol_probe.+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;magnetics.bpol_probe&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;magnetics.b_field_tor_probe.+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;magnetics.bpol_probe&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">remove_bpol_probe</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;magnetics.bpol_probe&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ods</span>


<span class="k">def</span> <span class="nf">delete_ggd</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    delete all .ggd and .grids_ggd entries</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param ds: string or list of strings where to limit the deletion process</span>

<span class="sd">    :return: list of strings with deleted entries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="p">[</span><span class="n">ds</span><span class="p">]</span>

    <span class="kn">from</span> <span class="nn">.omas_structure</span> <span class="kn">import</span> <span class="n">extract_ggd</span>

    <span class="n">ggds</span> <span class="o">=</span> <span class="n">extract_ggd</span><span class="p">()</span>

    <span class="n">deleted</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ggd</span> <span class="ow">in</span> <span class="n">ggds</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">ggd</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">structure</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ggd</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ggd</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">ods</span><span class="p">[</span><span class="n">ggd</span><span class="p">]</span>
                <span class="n">deleted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ggd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">dir</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="n">ggd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[:]&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="nb">dir</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="s1">&#39;ggd&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="nb">dir</span> <span class="o">+</span> <span class="s1">&#39;[</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">k</span><span class="p">]:</span>
                        <span class="k">del</span> <span class="n">ods</span><span class="p">[</span><span class="nb">dir</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">base</span><span class="p">]</span>
                        <span class="n">deleted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ggd</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">deleted</span>


<span class="k">def</span> <span class="nf">grids_ggd_points_triangles</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return points and triangles in grids_ggd structure</span>

<span class="sd">    :param grid: a ggd grid such as &#39;equilibrium.grids_ggd[0].grid[0]&#39;</span>

<span class="sd">    :return: tuple with points and triangles</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># objects_per_dimension: 0 = nodes, 1 = edges, 2 = faces, 3 = cells / volumes</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="s1">&#39;space[0].objects_per_dimension[0].object[:].geometry&#39;</span><span class="p">]</span>
    <span class="n">triangles</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="s1">&#39;space[0].objects_per_dimension[2].object[:].nodes&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">triangles</span>


<span class="k">class</span> <span class="nc">ScatterInterpolator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interface class for a unified call function for the scipy interpolators:</span>
<span class="sd">        - NearestNDInterpolator</span>
<span class="sd">        - LinearNDInterpolator</span>
<span class="sd">        - CloughTocher2DInterpolator</span>
<span class="sd">        - Rbf</span>
<span class="sd">    Created by factory create_scatter_interpolator</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interpolant</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>

<span class="sd">        :param interpolant: Instance of the scipy interpolator</span>

<span class="sd">        :param method: Interpolation method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolant</span> <span class="o">=</span> <span class="n">interpolant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call the interpolator</span>

<span class="sd">        :param interpolant: Instance of the scipy interpolator</span>

<span class="sd">        :param method: Interpolation method</span>

<span class="sd">        :param kwargs: Catch extra arguments (needed for polymorphism in equilibrium_profiles_2d_map)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;extrapolate&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolant</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="n">Z</span><span class="o">.</span><span class="n">flat</span><span class="p">),</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolant</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">R</span><span class="o">.</span><span class="n">flat</span><span class="p">,</span> <span class="n">Z</span><span class="o">.</span><span class="n">flat</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_scatter_interpolator</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;cubic&#39;</span><span class="p">,</span> <span class="s1">&#39;extrapolate&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">return_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an interpolator for scattered data points. Utility function for scatter_to_rectangular and equilibrium_profiles_2d_map</span>

<span class="sd">    :param r: r coordinate of data points</span>

<span class="sd">    :param z: z coordinate of data points</span>

<span class="sd">    :param data: data</span>

<span class="sd">    :param method: one of &#39;nearest&#39;, &#39;linear&#39;, &#39;cubic&#39;, &#39;extrapolate&#39;</span>

<span class="sd">    :param sanitize: avoid NaNs in regions where data is missing</span>

<span class="sd">    :return: interpolator(R,Z) -&gt; interpolated data (and cache if return_cache)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">scipy</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>

    <span class="n">cache</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;nearest&#39;</span><span class="p">:</span>
        <span class="n">interpolant</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">NearestNDInterpolator</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">Delaunay</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">interpolant</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">LinearNDInterpolator</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;cubic&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">Delaunay</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">interpolant</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">CloughTocher2DInterpolator</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;extrapolate&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">interpolant</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">Rbf</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Interpolation method </span><span class="si">%s</span><span class="s1"> is not recognized&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_cache</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ScatterInterpolator</span><span class="p">(</span><span class="n">interpolant</span><span class="p">,</span> <span class="n">method</span><span class="p">),</span> <span class="n">cache</span>
    <span class="k">return</span> <span class="n">ScatterInterpolator</span><span class="p">(</span><span class="n">interpolant</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">scatter_to_rectangular</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="s1">&#39;cubic&#39;</span><span class="p">,</span> <span class="s1">&#39;extrapolate&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">sanitize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolate scattered data points to rectangular grid</span>

<span class="sd">    :param r: r coordinate of data points</span>

<span class="sd">    :param z: z coordinate of data points</span>

<span class="sd">    :param data: data</span>

<span class="sd">    :param R: scalars, 1D arrays, or 2D arrays</span>

<span class="sd">    :param Z: scalars, 1D arrays, or 2D arrays</span>

<span class="sd">    :param method: one of &#39;nearest&#39;, &#39;linear&#39;, &#39;cubic&#39;, &#39;extrapolate&#39;</span>

<span class="sd">    :param sanitize: avoid NaNs in regions where data is missing</span>

<span class="sd">    :param return_cache: cache object or boolean to return cache object for faster interpolaton</span>

<span class="sd">    :return: R, Z, interpolated_data (and cache if return_cache)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">scipy</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="n">R</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">Z</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">R</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;R and Z must both be either scalars, 1D arrays, or 2D arrays&#39;</span><span class="p">)</span>

    <span class="n">cache</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">return_cache</span><span class="p">:</span>
        <span class="n">scatter_interpolator</span><span class="p">,</span> <span class="n">cache</span> <span class="o">=</span> <span class="n">create_scatter_interpolator</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">return_cache</span><span class="o">=</span><span class="n">return_cache</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scatter_interpolator</span> <span class="o">=</span> <span class="n">create_scatter_interpolator</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">return_cache</span><span class="o">=</span><span class="n">return_cache</span><span class="p">)</span>
    <span class="n">intepolated_data</span> <span class="o">=</span> <span class="n">scatter_interpolator</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>
    <span class="c1"># remove any NaNs using a rough nearest interpolation</span>
    <span class="n">index</span> <span class="o">=</span> <span class="o">~</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">intepolated_data</span><span class="o">.</span><span class="n">flat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sanitize</span> <span class="ow">and</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">index</span><span class="p">):</span>
        <span class="n">intepolated_data</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="o">~</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">NearestNDInterpolator</span><span class="p">(</span>
            <span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">index</span><span class="p">],</span> <span class="n">Z</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">index</span><span class="p">]),</span> <span class="n">intepolated_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">index</span><span class="p">]</span>
        <span class="p">)((</span><span class="n">R</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="o">~</span><span class="n">index</span><span class="p">],</span> <span class="n">Z</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="o">~</span><span class="n">index</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">return_cache</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Z</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">intepolated_data</span><span class="p">,</span> <span class="n">cache</span>
    <span class="k">return</span> <span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">Z</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">intepolated_data</span>


<span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">check_iter_scenario_requirements</span><span class="p">(</span><span class="n">ods</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that the current ODS satisfies the ITER scenario database requirements as defined in https://confluence.iter.org/x/kQqOE</span>

<span class="sd">    :return: list of elements that are missing to satisfy the ITER scenario requirements</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.omas_imas</span> <span class="kn">import</span> <span class="n">iter_scenario_requirements</span>

    <span class="n">fail</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iter_scenario_requirements</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ods</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>  <span class="c1"># acccessing a leaf that has no data will raise an error</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">fail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fail</span>


<div class="viewcode-block" id="probe_endpoints">
<a class="viewcode-back" href="../../code/omas.probe_endpoints.html#omas.probe_endpoints">[docs]</a>
<span class="nd">@add_to__ALL__</span>
<span class="k">def</span> <span class="nf">probe_endpoints</span><span class="p">(</span><span class="n">r0</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">l0</span><span class="p">,</span> <span class="n">cocos</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transform r,z,a,l arrays commonly used to describe poloidal magnetic</span>
<span class="sd">    probes geometry to actual r,z coordinates of the end-points of the probes.</span>
<span class="sd">    This is useful for plotting purposes.</span>

<span class="sd">    :param r0: r coordinates [m]</span>

<span class="sd">    :param z0: Z coordinates [m]</span>

<span class="sd">    :param a0: poloidal angles [radiants]</span>

<span class="sd">    :param l0: lenght [m]</span>

<span class="sd">    :param cocos: cocos convention</span>

<span class="sd">    :return: list of 2-points r and z coordinates of individual probes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">theta_convention</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">cocos</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">]:</span>
        <span class="n">theta_convention</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">boo</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">l0</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">cor</span> <span class="o">=</span> <span class="n">boo</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="c1"># then, compute the two-point arrays to build the partial rogowskis</span>
    <span class="c1"># as segments rather than single points, applying the correction</span>
    <span class="n">px</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">-</span> <span class="n">l0</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_convention</span> <span class="o">*</span> <span class="p">(</span><span class="n">a0</span> <span class="o">+</span> <span class="n">cor</span><span class="p">))</span>
    <span class="n">py</span> <span class="o">=</span> <span class="n">z0</span> <span class="o">-</span> <span class="n">l0</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_convention</span> <span class="o">*</span> <span class="p">(</span><span class="n">a0</span> <span class="o">+</span> <span class="n">cor</span><span class="p">))</span>
    <span class="n">qx</span> <span class="o">=</span> <span class="n">r0</span> <span class="o">+</span> <span class="n">l0</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_convention</span> <span class="o">*</span> <span class="p">(</span><span class="n">a0</span> <span class="o">+</span> <span class="n">cor</span><span class="p">))</span>
    <span class="n">qy</span> <span class="o">=</span> <span class="n">z0</span> <span class="o">+</span> <span class="n">l0</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_convention</span> <span class="o">*</span> <span class="p">(</span><span class="n">a0</span> <span class="o">+</span> <span class="n">cor</span><span class="p">))</span>
    <span class="n">segx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">segy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r0</span><span class="p">)):</span>
        <span class="n">segx</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">px</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">qx</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
        <span class="n">segy</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">py</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">qy</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>

    <span class="k">return</span> <span class="n">segx</span><span class="p">,</span> <span class="n">segy</span></div>



<div class="viewcode-block" id="transform_current">
<a class="viewcode-back" href="../../code/omas.transform_current.html#omas.transform_current">[docs]</a>
<span class="nd">@add_to__ALL__</span>
<span class="k">def</span> <span class="nf">transform_current</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">JtoR</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">JparB</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">equilibrium</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">includes_bootstrap</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given &lt;Jt/R&gt; returns &lt;J.B&gt;, or vice versa</span>
<span class="sd">    Transformation obeys &lt;J.B&gt; = (1/f)*(&lt;B^2&gt;/&lt;1/R^2&gt;)*(&lt;Jt/R&gt; + dp/dpsi*(1 - f^2*&lt;1/R^2&gt;/&lt;B^2&gt;))</span>
<span class="sd">    N.B. input current must be in the same COCOS as equilibrium.cocosio</span>

<span class="sd">    :param rho: normalized rho grid for input JtoR or JparB</span>

<span class="sd">    :param JtoR: input &lt;Jt/R&gt; profile (cannot be set along with JparB)</span>

<span class="sd">    :param JparB: input &lt;J.B&gt; profile (cannot be set along with JtoR)</span>

<span class="sd">    :param equilibrium: equilibrium.time_slice[:] ODS containing quanities needed for transformation</span>

<span class="sd">    :param includes_bootstrap: set to True if input current includes bootstrap</span>

<span class="sd">    :return: &lt;Jt/R&gt; if JparB set or &lt;J.B&gt; if JtoR set</span>

<span class="sd">    Example: given total &lt;Jt/R&gt; on rho grid with an existing ods, return &lt;J.B&gt;</span>
<span class="sd">             JparB = transform_current(rho, JtoR=JtoR,</span>
<span class="sd">                                       equilibrium=ods[&#39;equilibrium&#39;][&#39;time_slice&#39;][0],</span>
<span class="sd">                                       includes_bootstrap=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">JtoR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">JparB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;JtoR and JparB cannot both be set&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">equilibrium</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;equilibrium ODS must be provided, specifically equilibrium.time_slice[:]&quot;</span><span class="p">)</span>

    <span class="n">cocos</span> <span class="o">=</span> <span class="n">define_cocos</span><span class="p">(</span><span class="n">equilibrium</span><span class="o">.</span><span class="n">cocosio</span><span class="p">)</span>
    <span class="n">rho_eq</span> <span class="o">=</span> <span class="n">equilibrium</span><span class="p">[</span><span class="s1">&#39;profiles_1d.rho_tor_norm&#39;</span><span class="p">]</span>
    <span class="n">fsa_B2</span> <span class="o">=</span> <span class="n">omas_interp1d</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">rho_eq</span><span class="p">,</span> <span class="n">equilibrium</span><span class="p">[</span><span class="s1">&#39;profiles_1d.gm5&#39;</span><span class="p">])</span>
    <span class="n">fsa_invR2</span> <span class="o">=</span> <span class="n">omas_interp1d</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">rho_eq</span><span class="p">,</span> <span class="n">equilibrium</span><span class="p">[</span><span class="s1">&#39;profiles_1d.gm1&#39;</span><span class="p">])</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">omas_interp1d</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">rho_eq</span><span class="p">,</span> <span class="n">equilibrium</span><span class="p">[</span><span class="s1">&#39;profiles_1d.f&#39;</span><span class="p">])</span>
    <span class="n">dpdpsi</span> <span class="o">=</span> <span class="n">omas_interp1d</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">rho_eq</span><span class="p">,</span> <span class="n">equilibrium</span><span class="p">[</span><span class="s1">&#39;profiles_1d.dpressure_dpsi&#39;</span><span class="p">])</span>

    <span class="c1"># diamagnetic term to get included with bootstrap currrent</span>
    <span class="n">JtoR_dia</span> <span class="o">=</span> <span class="n">dpdpsi</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">fsa_invR2</span> <span class="o">*</span> <span class="n">f</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">fsa_B2</span><span class="p">)</span>
    <span class="n">JtoR_dia</span> <span class="o">*=</span> <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;exp_Bp&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">JtoR</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Jout</span> <span class="o">=</span> <span class="n">fsa_B2</span> <span class="o">*</span> <span class="p">(</span><span class="n">JtoR</span> <span class="o">+</span> <span class="n">includes_bootstrap</span> <span class="o">*</span> <span class="n">JtoR_dia</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">fsa_invR2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">JparB</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Jout</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">fsa_invR2</span> <span class="o">*</span> <span class="n">JparB</span> <span class="o">/</span> <span class="n">fsa_B2</span> <span class="o">-</span> <span class="n">includes_bootstrap</span> <span class="o">*</span> <span class="n">JtoR_dia</span>

    <span class="k">return</span> <span class="n">Jout</span></div>



<span class="nd">@add_to__ODS__</span>
<span class="k">def</span> <span class="nf">core_sources_j_parallel_sum</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">time_index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ods function used to sum all j_parallel contributions from core_sources (j_actuator)</span>

<span class="sd">    :param ods: input ods</span>

<span class="sd">    :param time_index: time slice to process</span>

<span class="sd">    :return: sum of j_parallel in [A/m^2]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rho</span> <span class="o">=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;core_profiles.profiles_1d.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.grid.rho_tor_norm&#39;</span><span class="p">]</span>
    <span class="n">j_act</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rho</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="s1">&#39;core_sources.source&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="s1">&#39;j_parallel&#39;</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;core_sources.source[</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">].profiles_1d.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]:</span>
            <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">coordsio</span><span class="o">=</span><span class="p">{</span><span class="sa">f</span><span class="s1">&#39;core_sources.source.</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">.profiles_1d.</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">.grid.rho_tor_norm&#39;</span><span class="p">:</span> <span class="n">rho</span><span class="p">}):</span>
                <span class="n">j_act</span> <span class="o">+=</span> <span class="n">ods</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;core_sources.source[</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">].profiles_1d[</span><span class="si">{</span><span class="n">time_index</span><span class="si">}</span><span class="s1">].j_parallel&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">j_act</span>


<div class="viewcode-block" id="search_ion">
<a class="viewcode-back" href="../../code/omas.search_ion.html#omas.search_ion">[docs]</a>
<span class="nd">@add_to__ALL__</span>
<span class="k">def</span> <span class="nf">search_ion</span><span class="p">(</span><span class="n">ion_ods</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Z</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">no_matches_raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">multiple_matches_raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    utility function used to identify the ion number and element numbers given the ion label and or their Z and/or A</span>

<span class="sd">    :param ion_ods: ODS location that ends with .ion</span>

<span class="sd">    :param label: ion label</span>

<span class="sd">    :param Z: ion element charge</span>

<span class="sd">    :param A: ion element mass</span>

<span class="sd">    :parame no_matches_raise_error: whether to raise a IndexError when no ion matches are found</span>

<span class="sd">    :parame multiple_matches_raise_error: whether to raise a IndexError when multiple ion matches are found</span>

<span class="sd">    :return: dictionary with matching ions labels, each with list of matching ion elements</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ion_ods</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ion&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ods location must end with `.ion`&#39;</span><span class="p">)</span>
    <span class="n">match</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ki</span> <span class="ow">in</span> <span class="n">ion_ods</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span> <span class="ow">and</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">label</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">A</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;element&#39;</span> <span class="ow">in</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">ke</span> <span class="ow">in</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">A</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">A</span> <span class="o">==</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">][</span><span class="n">ke</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Z</span> <span class="o">==</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">][</span><span class="n">ke</span><span class="p">][</span><span class="s1">&#39;z_n&#39;</span><span class="p">]:</span>
                        <span class="k">match</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">A</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">A</span> <span class="o">==</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">][</span><span class="n">ke</span><span class="p">][</span><span class="s1">&#39;a&#39;</span><span class="p">]:</span>
                        <span class="k">match</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">Z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Z</span> <span class="o">==</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">][</span><span class="n">ke</span><span class="p">][</span><span class="s1">&#39;z_n&#39;</span><span class="p">]:</span>
                        <span class="k">match</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;element&#39;</span> <span class="ow">in</span> <span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">]):</span>
                <span class="k">match</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ki</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ion_ods</span><span class="p">[</span><span class="n">ki</span><span class="p">][</span><span class="s1">&#39;element&#39;</span><span class="p">])))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">match</span><span class="p">[</span><span class="n">ki</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">multiple_matches_raise_error</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Multiple ion match query: label=</span><span class="si">%s</span><span class="s1">  Z=</span><span class="si">%s</span><span class="s1">  A=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">no_matches_raise_error</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;No ion match query: label=</span><span class="si">%s</span><span class="s1">  Z=</span><span class="si">%s</span><span class="s1">  A=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">match</span></div>



<div class="viewcode-block" id="search_in_array_structure">
<a class="viewcode-back" href="../../code/omas.search_in_array_structure.html#omas.search_in_array_structure">[docs]</a>
<span class="nd">@add_to__ALL__</span>
<span class="k">def</span> <span class="nf">search_in_array_structure</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span> <span class="n">no_matches_return</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">no_matches_raise_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">multiple_matches_raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    search for the index in an array structure that matches some conditions</span>

<span class="sd">    :param ods: ODS location that is an array of structures</span>

<span class="sd">    :param conditions: dictionary (or ODS) whith entries that must match and their values</span>
<span class="sd">                       * condition[&#39;name&#39;]=value  : check value</span>
<span class="sd">                       * condition[&#39;name&#39;]=True   : check existance</span>
<span class="sd">                       * condition[&#39;name&#39;]=False  : check not existance</span>
<span class="sd">                       NOTE: True/False as flags for (not)existance is not an issue since IMAS does not support booleans</span>

<span class="sd">    :param no_matches_return: what index to return if no matches are found</span>

<span class="sd">    :param no_matches_raise_error: wheter to raise an error in no matches are found</span>

<span class="sd">    :param multiple_matches_raise_error: whater to raise an error if multiple matches are found</span>

<span class="sd">    :return: list with indeces matching conditions</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">ods</span><span class="o">.</span><span class="n">omas_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ods</span><span class="o">.</span><span class="n">omas_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;ods location must be an array of structures&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">ODS</span><span class="p">):</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="n">conditions</span><span class="o">.</span><span class="n">flat</span><span class="p">()</span>

    <span class="n">match</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">:</span>
        <span class="n">k_match</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">conditions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">k_match</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">elif</span> <span class="n">conditions</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">k_match</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">elif</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ods</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">or</span> <span class="n">ods</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">conditions</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="n">k_match</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">k_match</span><span class="p">:</span>
            <span class="k">match</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">no_matches_raise_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;no matches for conditions: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">conditions</span><span class="p">)</span>
        <span class="n">match</span> <span class="o">=</span> <span class="p">[</span><span class="n">no_matches_return</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">multiple_matches_raise_error</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">match</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;multiple matches for conditions: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">conditions</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">match</span></div>


<div class="viewcode-block" id="get_plot_scale_and_unit">
<a class="viewcode-back" href="../../code/omas.get_plot_scale_and_unit.html#omas.get_plot_scale_and_unit">[docs]</a>
<span class="nd">@add_to__ALL__</span>
<span class="k">def</span> <span class="nf">get_plot_scale_and_unit</span><span class="p">(</span><span class="n">phys_quant</span><span class="p">,</span> <span class="n">species</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns normalizing scale for a physical quantity.</span>
<span class="sd">    E.g. &quot;temprerature&quot; returns 1.e-3 and keV</span>
<span class="sd">    :param phys_qaunt: str with a physical quantity. Uses IMAS scheme names where possible</span>
<span class="sd">    :return: scale, unit</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="n">phys_quant</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.e-3</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\mathrm</span><span class="si">{keV}</span><span class="s2">&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;density&quot;</span> <span class="ow">in</span> <span class="n">phys_quant</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">species</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">species</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;He&quot;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mf">1.e-18</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\times 10^</span><span class="si">{18}</span><span class="s2">\,\mathrm</span><span class="si">{m}</span><span class="s2">^{-3}&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.e-19</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\times 10^</span><span class="si">{19}</span><span class="s2">\,\mathrm</span><span class="si">{m}</span><span class="s2">^{-3}&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;velocity&quot;</span> <span class="ow">in</span>  <span class="n">phys_quant</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.e-6</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\mathrm</span><span class="si">{Mm}</span><span class="s2">\,\mathrm</span><span class="si">{s}</span><span class="s2">^{-1}&quot;</span>
    <span class="k">elif</span> <span class="s2">&quot;e_field&quot;</span> <span class="ow">in</span> <span class="n">phys_quant</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.e-3</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\mathrm</span><span class="si">{kV}</span><span class="s2">\,\mathrm</span><span class="si">{m}</span><span class="s2">^{-1}&quot;</span></div>

    

<div class="viewcode-block" id="define_cocos">
<a class="viewcode-back" href="../../code/omas.define_cocos.html#omas.define_cocos">[docs]</a>
<span class="nd">@add_to__ALL__</span>
<span class="k">def</span> <span class="nf">define_cocos</span><span class="p">(</span><span class="n">cocos_ind</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns dictionary with COCOS coefficients given a COCOS index</span>

<span class="sd">    https://docs.google.com/document/d/1-efimTbI55SjxL_yE_GKSmV4GEvdzai7mAj5UYLLUXw/edit</span>

<span class="sd">    :param cocos_ind: COCOS index</span>

<span class="sd">    :return: dictionary with COCOS coefficients</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cocos</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">([</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">,</span> <span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">,</span> <span class="s1">&#39;sign_q_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">,</span> <span class="s1">&#39;exp_Bp&#39;</span><span class="p">])</span>

    <span class="c1"># all multipliers shouldn&#39;t change input values if cocos_ind is None</span>
    <span class="k">if</span> <span class="n">cocos_ind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;exp_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">cocos</span>

    <span class="c1"># if COCOS&gt;=10, this should be 1</span>
    <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;exp_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">cocos_ind</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;exp_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

    <span class="k">if</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="c1"># (1)  psitbx(various options), Toray-GA</span>
        <span class="c1"># (11) ITER, Boozer</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="c1"># (2)  CHEASE, ONETWO, HintonHazeltine, LION, XTOR, MEUDAS, MARS, MARS-F</span>
        <span class="c1"># (12) GENE</span>
        <span class="c1"># (-12) ASTRA</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="c1"># (3) Freidberg*, CAXE and KINX*, GRAY, CQL3D^, CarMa, EFIT* with : ORB5, GBSwith : GT5D</span>
        <span class="c1"># (13)  CLISTE, EQUAL, GEC, HELENA, EU ITM-TF up to end of 2011</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">14</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="c1"># (5) TORBEAM, GENRAY^</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">17</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="c1"># (17) LIUQE*, psitbx(TCV standard output)</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

    <span class="k">elif</span> <span class="n">cocos_ind</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">18</span><span class="p">]:</span>
        <span class="c1"># These cocos are for</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_q_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>
        <span class="n">cocos</span><span class="p">[</span><span class="s1">&#39;sign_pprime_pos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">cocos</span></div>



<div class="viewcode-block" id="cocos_transform">
<a class="viewcode-back" href="../../code/omas.cocos_transform.html#omas.cocos_transform">[docs]</a>
<span class="nd">@add_to__ALL__</span>
<span class="k">def</span> <span class="nf">cocos_transform</span><span class="p">(</span><span class="n">cocosin_index</span><span class="p">,</span> <span class="n">cocosout_index</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dictionary with coefficients for how various quantities should get multiplied in order to go from cocosin_index to cocosout_index</span>

<span class="sd">    https://docs.google.com/document/d/1-efimTbI55SjxL_yE_GKSmV4GEvdzai7mAj5UYLLUXw/edit</span>

<span class="sd">    :param cocosin_index: COCOS index in</span>

<span class="sd">    :param cocosout_index: COCOS index out</span>

<span class="sd">    :return: dictionary with transformation multipliers</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Don&#39;t transform if either cocos is undefined</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cocosin_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">cocosout_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">printd</span><span class="p">(</span><span class="s2">&quot;No COCOS tranformation for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cocosin_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cocosout_index</span><span class="p">),</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;cocos&#39;</span><span class="p">)</span>
        <span class="n">sigma_Ip_eff</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">sigma_B0_eff</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">sigma_Bp_eff</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">exp_Bp_eff</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sigma_rhotp_eff</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">printd</span><span class="p">(</span><span class="s2">&quot;COCOS tranformation from &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cocosin_index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; to &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cocosout_index</span><span class="p">),</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;cocos&#39;</span><span class="p">)</span>
        <span class="n">cocosin</span> <span class="o">=</span> <span class="n">define_cocos</span><span class="p">(</span><span class="n">cocosin_index</span><span class="p">)</span>
        <span class="n">cocosout</span> <span class="o">=</span> <span class="n">define_cocos</span><span class="p">(</span><span class="n">cocosout_index</span><span class="p">)</span>

        <span class="n">sigma_Ip_eff</span> <span class="o">=</span> <span class="n">cocosin</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cocosout</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span>
        <span class="n">sigma_B0_eff</span> <span class="o">=</span> <span class="n">cocosin</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cocosout</span><span class="p">[</span><span class="s1">&#39;sigma_RpZ&#39;</span><span class="p">]</span>
        <span class="n">sigma_Bp_eff</span> <span class="o">=</span> <span class="n">cocosin</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cocosout</span><span class="p">[</span><span class="s1">&#39;sigma_Bp&#39;</span><span class="p">]</span>
        <span class="n">exp_Bp_eff</span> <span class="o">=</span> <span class="n">cocosout</span><span class="p">[</span><span class="s1">&#39;exp_Bp&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cocosin</span><span class="p">[</span><span class="s1">&#39;exp_Bp&#39;</span><span class="p">]</span>
        <span class="n">sigma_rhotp_eff</span> <span class="o">=</span> <span class="n">cocosin</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">cocosout</span><span class="p">[</span><span class="s1">&#39;sigma_rhotp&#39;</span><span class="p">]</span>

    <span class="c1"># Transform</span>
    <span class="n">transforms</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;1/PSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_Ip_eff</span> <span class="o">*</span> <span class="n">sigma_Bp_eff</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="n">exp_Bp_eff</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;invPSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;1/PSI&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;dPSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;1/PSI&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;F_FPRIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;dPSI&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;PPRIME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;dPSI&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;PSI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_Ip_eff</span> <span class="o">*</span> <span class="n">sigma_Bp_eff</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="n">exp_Bp_eff</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_Ip_eff</span> <span class="o">*</span> <span class="n">sigma_B0_eff</span> <span class="o">*</span> <span class="n">sigma_rhotp_eff</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;TOR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_B0_eff</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;BT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;TOR&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;IP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;TOR&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;F&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;TOR&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;POL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma_B0_eff</span> <span class="o">*</span> <span class="n">sigma_rhotp_eff</span>
    <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;BP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transforms</span><span class="p">[</span><span class="s1">&#39;POL&#39;</span><span class="p">]</span>
    <span class="n">transforms</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">printd</span><span class="p">(</span><span class="n">transforms</span><span class="p">,</span> <span class="n">topic</span><span class="o">=</span><span class="s1">&#39;cocos&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">transforms</span></div>



<div class="viewcode-block" id="identify_cocos">
<a class="viewcode-back" href="../../code/omas.identify_cocos.html#omas.identify_cocos">[docs]</a>
<span class="nd">@add_to__ALL__</span>
<span class="k">def</span> <span class="nf">identify_cocos</span><span class="p">(</span><span class="n">B0</span><span class="p">,</span> <span class="n">Ip</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">clockwise_phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility function to identify COCOS coordinate system</span>
<span class="sd">    If multiple COCOS are possible, then all are returned.</span>

<span class="sd">    :param B0: toroidal magnetic field (with sign)</span>

<span class="sd">    :param Ip: plasma current (with sign)</span>

<span class="sd">    :param q: safety factor profile (with sign) as function of psi</span>

<span class="sd">    :param psi: poloidal flux as function of psi(with sign)</span>

<span class="sd">    :param clockwise_phi: (optional) [True, False] if phi angle is defined clockwise or not</span>
<span class="sd">                          This is required to identify odd Vs even COCOS</span>
<span class="sd">                          Note that this cannot be determined from the output of a code.</span>
<span class="sd">                          An easy way to determine this is to answer the question: is positive B0 clockwise?</span>

<span class="sd">    :param a: (optional) flux surfaces minor radius as function of psi</span>
<span class="sd">              This is required to identify 2*pi term in psi definition</span>

<span class="sd">    :return: list with possible COCOS</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">clockwise_phi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sigma_rpz</span> <span class="o">=</span> <span class="n">clockwise_phi</span>
    <span class="k">elif</span> <span class="n">clockwise_phi</span><span class="p">:</span>
        <span class="n">sigma_rpz</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sigma_rpz</span> <span class="o">=</span> <span class="o">+</span><span class="mi">1</span>

    <span class="c1"># return both even and odd COCOS if clockwise_phi is not provided</span>
    <span class="k">if</span> <span class="n">sigma_rpz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">identify_cocos</span><span class="p">(</span><span class="n">B0</span><span class="p">,</span> <span class="n">Ip</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">identify_cocos</span><span class="p">(</span><span class="n">B0</span><span class="p">,</span> <span class="n">Ip</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">tmp</span>

    <span class="n">sigma_Ip</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">Ip</span><span class="p">)</span>
    <span class="n">sigma_B0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">B0</span><span class="p">)</span>
    <span class="n">sign_dpsi_pos</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">psi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sign_q_pos</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">q</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">sigma_Bp</span> <span class="o">=</span> <span class="n">sign_dpsi_pos</span> <span class="o">/</span> <span class="n">sigma_Ip</span>
    <span class="n">sigma_rhotp</span> <span class="o">=</span> <span class="n">sign_q_pos</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma_Ip</span> <span class="o">*</span> <span class="n">sigma_B0</span><span class="p">)</span>

    <span class="n">sigma2cocos</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># +Bp, +rpz, +rtp</span>
        <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># +Bp, -rpz, +rtp</span>
        <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># -Bp, +rpz, -rtp</span>
        <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="mi">4</span><span class="p">,</span>  <span class="c1"># -Bp, -rpz, -rtp</span>
        <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># +Bp, +rpz, -rtp</span>
        <span class="p">(</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span> <span class="mi">6</span><span class="p">,</span>  <span class="c1"># +Bp, -rpz, -rtp</span>
        <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="mi">7</span><span class="p">,</span>  <span class="c1"># -Bp, +rpz, +rtp</span>
        <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="mi">8</span><span class="p">,</span>  <span class="c1"># -Bp, -rpz, +rtp</span>
    <span class="p">}</span>

    <span class="c1"># identify 2*pi term in psi definition based on q estimate</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">q_estimate</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">B0</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">psi</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="n">psi</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">q_actual</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">q_estimate</span> <span class="o">-</span> <span class="n">q_actual</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">q_estimate</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">-</span> <span class="n">q_actual</span><span class="p">):</span>
            <span class="n">eBp</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eBp</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">sigma2cocos</span><span class="p">[(</span><span class="n">sigma_Bp</span><span class="p">,</span> <span class="n">sigma_rpz</span><span class="p">,</span> <span class="n">sigma_rhotp</span><span class="p">)]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">eBp</span><span class="p">]</span>

    <span class="c1"># return COCOS&lt;10 as well as COCOS&gt;10 if a is not provided</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">sigma2cocos</span><span class="p">[(</span><span class="n">sigma_Bp</span><span class="p">,</span> <span class="n">sigma_rpz</span><span class="p">,</span> <span class="n">sigma_rhotp</span><span class="p">)],</span> <span class="n">sigma2cocos</span><span class="p">[(</span><span class="n">sigma_Bp</span><span class="p">,</span> <span class="n">sigma_rpz</span><span class="p">,</span> <span class="n">sigma_rhotp</span><span class="p">)]</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span></div>



<div class="viewcode-block" id="omas_environment">
<a class="viewcode-back" href="../../code/omas.omas_environment.html#omas.omas_environment">[docs]</a>
<span class="nd">@add_to__ALL__</span>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">omas_environment</span><span class="p">(</span>
    <span class="n">ods</span><span class="p">,</span>
    <span class="n">cocosio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">coordsio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">unitsio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">uncertainio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">input_data_process_functions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">xmlcodeparams</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dynamic_path_creation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kw</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides environment for data input/output to/from OMAS</span>

<span class="sd">    :param ods: ODS on which to operate</span>

<span class="sd">    :param cocosio: COCOS convention</span>

<span class="sd">    :param coordsio: dictionary/ODS with coordinates for data interpolation</span>

<span class="sd">    :param unitsio: True/False whether data read from OMAS should have units</span>

<span class="sd">    :param uncertainio: True/False whether data read from OMAS should have uncertainties</span>

<span class="sd">    :param input_data_process_functions: list of functions that are used to process data that is passed to the ODS</span>

<span class="sd">    :param xmlcodeparams: view code.parameters as an XML string while in this environment</span>

<span class="sd">    :param dynamic_path_creation: whether to dynamically create the path when setting an item</span>
<span class="sd">                                  * False: raise an error when trying to access a structure element that does not exists</span>
<span class="sd">                                  * True (default): arrays of structures can be incrementally extended by accessing at the next element in the array</span>
<span class="sd">                                  * &#39;dynamic_array_structures&#39;: arrays of structures can be dynamically extended</span>

<span class="sd">    :param kw: extra keywords set attributes of the ods (eg. &#39;consistency_check&#39;, &#39;dynamic_path_creation&#39;, &#39;imas_version&#39;)</span>

<span class="sd">    :return: ODS with environment set</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># turn simple coordsio dictionary into an ODS</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coordsio</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">omas</span> <span class="kn">import</span> <span class="n">ODS</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">(</span><span class="n">cocos</span><span class="o">=</span><span class="n">ods</span><span class="o">.</span><span class="n">cocos</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">cocosio</span><span class="o">=</span><span class="n">cocosio</span><span class="p">,</span> <span class="n">dynamic_path_creation</span><span class="o">=</span><span class="s1">&#39;dynamic_array_structures&#39;</span><span class="p">):</span>
            <span class="n">tmp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">coordsio</span><span class="p">)</span>
        <span class="n">coordsio</span> <span class="o">=</span> <span class="n">tmp</span>

    <span class="k">if</span> <span class="n">cocosio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cocosio</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cocosio can only be an integer&#39;</span><span class="p">)</span>

    <span class="c1"># backup attributes</span>
    <span class="n">bkp_dynamic_path_creation</span> <span class="o">=</span> <span class="n">omas_rcparams</span><span class="p">[</span><span class="s1">&#39;dynamic_path_creation&#39;</span><span class="p">]</span>
    <span class="n">bkp_cocosio</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">cocosio</span>
    <span class="n">bkp_coordsio</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">coordsio</span>
    <span class="n">bkp_unitsio</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">unitsio</span>
    <span class="n">bkp_uncertainio</span> <span class="o">=</span> <span class="n">ods</span><span class="o">.</span><span class="n">uncertainio</span>
    <span class="n">bkp_args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
        <span class="n">bkp_args</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>

    <span class="c1"># set attributes</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">kw</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">cocosio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">cocosio</span> <span class="o">=</span> <span class="n">cocosio</span>
    <span class="k">if</span> <span class="n">coordsio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">coordsio</span> <span class="o">=</span> <span class="n">coordsio</span>
    <span class="k">if</span> <span class="n">unitsio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">unitsio</span> <span class="o">=</span> <span class="n">unitsio</span>
    <span class="k">if</span> <span class="n">uncertainio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">uncertainio</span> <span class="o">=</span> <span class="n">uncertainio</span>
    <span class="k">if</span> <span class="n">dynamic_path_creation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">omas_rcparams</span><span class="p">[</span><span class="s1">&#39;dynamic_path_creation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dynamic_path_creation</span>

    <span class="c1"># set input_data_process_functions</span>
    <span class="k">if</span> <span class="n">input_data_process_functions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">omas_core</span>

        <span class="n">bkp_input_data_process_functions</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">omas_core</span><span class="o">.</span><span class="n">input_data_process_functions</span><span class="p">)</span>
        <span class="n">omas_core</span><span class="o">.</span><span class="n">input_data_process_functions</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">input_data_process_functions</span>

    <span class="c1"># set code.parameters as XML string</span>
    <span class="k">if</span> <span class="n">xmlcodeparams</span><span class="p">:</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">codeparams2xml</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">coordsio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">omas_environment</span><span class="p">(</span><span class="n">coordsio</span><span class="p">,</span> <span class="n">cocosio</span><span class="o">=</span><span class="n">cocosio</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">ods</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">ods</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># restore code.parameters as dictionary</span>
        <span class="k">if</span> <span class="n">xmlcodeparams</span><span class="p">:</span>
            <span class="n">ods</span><span class="o">.</span><span class="n">codeparams2dict</span><span class="p">()</span>
        <span class="c1"># restore attributes</span>
        <span class="n">omas_rcparams</span><span class="p">[</span><span class="s1">&#39;dynamic_path_creation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkp_dynamic_path_creation</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">cocosio</span> <span class="o">=</span> <span class="n">bkp_cocosio</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">coordsio</span> <span class="o">=</span> <span class="n">bkp_coordsio</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">unitsio</span> <span class="o">=</span> <span class="n">bkp_unitsio</span>
        <span class="n">ods</span><span class="o">.</span><span class="n">uncertainio</span> <span class="o">=</span> <span class="n">bkp_uncertainio</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">ods</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">bkp_args</span><span class="p">[</span><span class="n">item</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">_excp</span><span class="p">:</span>
                <span class="c1"># Add more user feedback, since use of consistency_check in an omas_environment can be confusing</span>
                <span class="k">if</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;consistency_check&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">_excp</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_excp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The IMAS consistency was violated getting out of the omas_environment&#39;</span><span class="p">)</span>
                <span class="k">raise</span>
        <span class="c1"># restore input_data_process_functions</span>
        <span class="k">if</span> <span class="n">input_data_process_functions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">omas_core</span><span class="o">.</span><span class="n">input_data_process_functions</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">bkp_input_data_process_functions</span></div>



<span class="k">def</span> <span class="nf">generate_cocos_signals</span><span class="p">(</span><span class="n">structures</span><span class="o">=</span><span class="p">[],</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a utility function for generating the omas_cocos.py Python file</span>

<span class="sd">    :param structures: list of structures for which to generate COCOS signals</span>

<span class="sd">    :param threshold: score threshold below which singals entries will not be written in omas_cocos.py</span>
<span class="sd">    * 0 is a reasonable threshold for catching signals that should have an associated COCOS transform</span>
<span class="sd">    * 10000 (or any high number) is a way to hide signals in omas_cocos.py that are unassigned</span>

<span class="sd">    :param write: update omas_cocos.py file</span>

<span class="sd">    :param verbose: print cocos signals to screen</span>

<span class="sd">    :return: dictionary structure with tally of score and reason for scoring for every entry</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># cocos_signals contains the IMAS locations and the corresponding `cocos_transform` function</span>
    <span class="kn">from</span> <span class="nn">.omas_cocos</span> <span class="kn">import</span> <span class="n">_cocos_signals</span>

    <span class="c1"># update OMAS cocos information with the one stored in IMAS</span>
    <span class="kn">from</span> <span class="nn">.omas_structure</span> <span class="kn">import</span> <span class="n">extract_cocos</span>

    <span class="n">_cocos_signals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extract_cocos</span><span class="p">())</span>

    <span class="c1"># units of entries currently in cocos_singals</span>
    <span class="n">cocos_units</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">_cocos_signals</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_cocos_signals</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">omas_info_node</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;units&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>  <span class="c1"># info may have no length if nodes are deleted between IMAS versions</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">units</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cocos_units</span><span class="p">:</span>
                <span class="n">cocos_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
    <span class="n">cocos_units</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">cocos_units</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;?&#39;</span><span class="p">]))</span>

    <span class="c1"># make sure to keep around structures that are already in omas_cocos.py</span>
    <span class="n">cocos_structures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">_cocos_signals</span><span class="p">:</span>
        <span class="n">structure_name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">structure_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cocos_structures</span><span class="p">:</span>
            <span class="n">cocos_structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">structure_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">structures</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">structures</span> <span class="o">=</span> <span class="p">[</span><span class="n">structures</span><span class="p">]</span>
    <span class="n">structures</span> <span class="o">+=</span> <span class="n">cocos_structures</span>
    <span class="n">structures</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">structures</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">.omas_utils</span> <span class="kn">import</span> <span class="n">_structures</span><span class="p">,</span> <span class="n">_extra_structures</span>
    <span class="kn">from</span> <span class="nn">.omas_utils</span> <span class="kn">import</span> <span class="n">i2o</span>
    <span class="kn">from</span> <span class="nn">.omas_core</span> <span class="kn">import</span> <span class="n">ODS</span>

    <span class="c1"># if generate_cocos_signals is run after omas has been used for something else</span>
    <span class="c1"># (eg. when running test_examples) it may be that _extra_structures is not empty</span>
    <span class="c1"># Thus, we clear _structures and _extra_structures to make sure that</span>
    <span class="c1"># structures_filenames() is not polluted by _extra_structures</span>
    <span class="n">_structures_bkp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">_structures</span><span class="p">)</span>
    <span class="n">_extra_structures_bkp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">_extra_structures</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_structures</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">_extra_structures</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="n">ods</span> <span class="o">=</span> <span class="n">ODS</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">csig</span> <span class="o">=</span> <span class="p">[</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&#39;&#39;&#39;List of automatic COCOS transformations</span>

<span class="sd">-------</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd"># COCOS signals candidates are generated by running utilities/generate_cocos_signals.py</span>
<span class="sd"># Running this script is useful to keep track of new signals that IMAS adds in new data structure releases</span>
<span class="sd">#</span>
<span class="sd"># In this file you are only allowed to edit/add entries to the `_cocos_signals` dictionary</span>
<span class="sd"># The comments indicate `#[ADD_OR_DELETE_SUGGESTION]# MATCHING_SCORE # RATIONALE_FOR_ADD_OR_DELETE`</span>
<span class="sd">#</span>
<span class="sd"># Proceed as follows:</span>
<span class="sd"># 1. Edit transformations in this file (if a signal is missing, it can be added here)</span>
<span class="sd"># 2. Run `utilities/generate_cocos_signals.py` (which will update this same file)</span>
<span class="sd"># 3. Commit changes</span>
<span class="sd">#</span>
<span class="sd"># Valid transformations are defined in the `cocos_transform()` function and they are:</span>
<span class="sd">#</span>
<span class="sd">#        transforms = {}</span>
<span class="sd">#        transforms[&#39;1/PSI&#39;] = sigma_Ip_eff * sigma_Bp_eff / (2 * numpy.pi) ** exp_Bp_eff</span>
<span class="sd">#        transforms[&#39;invPSI&#39;] = transforms[&#39;1/PSI&#39;]</span>
<span class="sd">#        transforms[&#39;dPSI&#39;] = transforms[&#39;1/PSI&#39;]</span>
<span class="sd">#        transforms[&#39;F_FPRIME&#39;] = transforms[&#39;dPSI&#39;]</span>
<span class="sd">#        transforms[&#39;PPRIME&#39;] = transforms[&#39;dPSI&#39;]</span>
<span class="sd">#        transforms[&#39;PSI&#39;] = sigma_Ip_eff * sigma_Bp_eff * (2 * numpy.pi) ** exp_Bp_eff</span>
<span class="sd">#        transforms[&#39;Q&#39;] = sigma_Ip_eff * sigma_B0_eff * sigma_rhotp_eff</span>
<span class="sd">#        transforms[&#39;TOR&#39;] = sigma_B0_eff</span>
<span class="sd">#        transforms[&#39;BT&#39;] = transforms[&#39;TOR&#39;]</span>
<span class="sd">#        transforms[&#39;IP&#39;] = transforms[&#39;TOR&#39;]</span>
<span class="sd">#        transforms[&#39;F&#39;] = transforms[&#39;TOR&#39;]</span>
<span class="sd">#        transforms[&#39;POL&#39;] = sigma_B0_eff * sigma_rhotp_eff</span>
<span class="sd">#        transforms[&#39;BP&#39;] = transforms[&#39;POL&#39;]</span>
<span class="sd">#        transforms[None] = 1</span>
<span class="sd">#</span>

<span class="sd">_cocos_signals = {}</span>
<span class="sd">&quot;&quot;&quot;</span>
        <span class="p">]</span>

        <span class="n">skip_signals</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;chi_squared&#39;</span><span class="p">,</span>
            <span class="s1">&#39;standard_deviation&#39;</span><span class="p">,</span>
            <span class="s1">&#39;weight&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coefficients&#39;</span><span class="p">,</span>
            <span class="s1">&#39;beta_tor&#39;</span><span class="p">,</span>
            <span class="s1">&#39;beta_pol&#39;</span><span class="p">,</span>
            <span class="s1">&#39;radial&#39;</span><span class="p">,</span>
            <span class="s1">&#39;rho_tor_norm&#39;</span><span class="p">,</span>
            <span class="s1">&#39;darea_drho_tor&#39;</span><span class="p">,</span>
            <span class="s1">&#39;dvolume_drho_tor&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ratio&#39;</span><span class="p">,</span>
            <span class="s1">&#39;fraction&#39;</span><span class="p">,</span>
            <span class="s1">&#39;rate&#39;</span><span class="p">,</span>
            <span class="s1">&#39;d&#39;</span><span class="p">,</span>
            <span class="s1">&#39;flux&#39;</span><span class="p">,</span>
            <span class="s1">&#39;v&#39;</span><span class="p">,</span>
            <span class="s1">&#39;b_field_max&#39;</span><span class="p">,</span>
            <span class="s1">&#39;b_field_r&#39;</span><span class="p">,</span>
            <span class="s1">&#39;b_field_z&#39;</span><span class="p">,</span>
            <span class="s1">&#39;b_r&#39;</span><span class="p">,</span>
            <span class="s1">&#39;b_z&#39;</span><span class="p">,</span>
            <span class="s1">&#39;width_tor&#39;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="c1"># loop over structures</span>
        <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">structures</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Updating COCOS info for: &#39;</span> <span class="o">+</span> <span class="n">structure</span><span class="p">)</span>
            <span class="n">text</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;# &#39;</span> <span class="o">+</span> <span class="n">structure</span><span class="o">.</span><span class="n">upper</span><span class="p">()])</span>
            <span class="n">csig</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;# &#39;</span> <span class="o">+</span> <span class="n">structure</span><span class="o">.</span><span class="n">upper</span><span class="p">()])</span>

            <span class="n">out</span><span class="p">[</span><span class="n">structure</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">ods</span><span class="p">[</span><span class="n">structure</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># generate score and add reason for scoring</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">load_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">omas_rcparams</span><span class="p">[</span><span class="s1">&#39;default_imas_version&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">i2o</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">item_</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;:.values&#39;</span><span class="p">,</span> <span class="s1">&#39;:.value&#39;</span><span class="p">,</span> <span class="s1">&#39;:.data&#39;</span><span class="p">]):</span>
                    <span class="n">item_</span> <span class="o">=</span> <span class="n">l2o</span><span class="p">(</span><span class="n">p2l</span><span class="p">(</span><span class="n">item</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.values&#39;</span><span class="p">,</span> <span class="s1">&#39;.value&#39;</span><span class="p">,</span> <span class="s1">&#39;.data&#39;</span><span class="p">]):</span>
                    <span class="n">item_</span> <span class="o">=</span> <span class="n">l2o</span><span class="p">(</span><span class="n">p2l</span><span class="p">(</span><span class="n">item</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">m</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">rationale</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;_error_&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="n">entry</span> <span class="o">=</span> <span class="s2">&quot;_cocos_signals[&#39;</span><span class="si">%s</span><span class="s2">&#39;]=&quot;</span> <span class="o">%</span> <span class="n">i2o</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="n">info</span> <span class="o">=</span> <span class="n">omas_info_node</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="n">units</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;units&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">data_type</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data_type&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">documentation</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;documentation&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;STRUCTURE&#39;</span><span class="p">,</span> <span class="s1">&#39;STR_0D&#39;</span><span class="p">,</span> <span class="s1">&#39;STRUCT_ARRAY&#39;</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">units</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]:</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">structure</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">units</span><span class="p">))</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;.*\.[rz]$&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="nb">any</span><span class="p">((</span><span class="n">item_</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="ow">or</span> <span class="n">item_</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">skip_signals</span><span class="p">):</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">structure</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">p2l</span><span class="p">(</span><span class="n">item_</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">documentation</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;always positive&#39;</span><span class="p">]):</span>
                        <span class="n">out</span><span class="p">[</span><span class="n">structure</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">documentation</span><span class="p">))</span>
                        <span class="k">continue</span>
                    <span class="n">n</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">pnt</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p2l</span><span class="p">(</span><span class="n">item</span><span class="p">)):</span>
                        <span class="n">pnt</span> <span class="o">=</span> <span class="n">pnt</span> <span class="o">/</span> <span class="n">n</span>
                        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;ip&#39;</span><span class="p">,</span> <span class="s1">&#39;b0&#39;</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="s1">&#39;psi&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;f_df&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">case</span><span class="p">:</span>
                                <span class="n">rationale</span> <span class="o">+=</span> <span class="p">[</span><span class="n">case</span><span class="p">]</span>
                                <span class="n">score</span> <span class="o">+=</span> <span class="n">pnt</span>
                                <span class="k">break</span>
                        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;j&#39;</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="s1">&#39;psi&#39;</span><span class="p">,</span> <span class="s1">&#39;ip&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;f_df&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_&#39;</span> <span class="o">%</span> <span class="n">case</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;psi_norm&#39;</span><span class="p">]):</span>
                                <span class="n">rationale</span> <span class="o">+=</span> <span class="p">[</span><span class="n">case</span><span class="p">]</span>
                                <span class="n">score</span> <span class="o">+=</span> <span class="n">pnt</span>
                                <span class="k">break</span>
                        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;current&#39;</span><span class="p">,</span> <span class="s1">&#39;b_field&#39;</span><span class="p">,</span> <span class="s1">&#39;e_field&#39;</span><span class="p">,</span> <span class="s1">&#39;torque&#39;</span><span class="p">,</span> <span class="s1">&#39;momentum&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;heating_current_drive&#39;</span><span class="p">]:</span>
                                <span class="n">rationale</span> <span class="o">+=</span> <span class="p">[</span><span class="n">case</span><span class="p">]</span>
                                <span class="n">score</span> <span class="o">+=</span> <span class="n">pnt</span>
                                <span class="k">break</span>
                        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_dpsi&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">case</span> <span class="o">+</span> <span class="s1">&#39;_norm&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                                <span class="n">rationale</span> <span class="o">+=</span> <span class="p">[</span><span class="n">case</span><span class="p">]</span>
                                <span class="n">score</span> <span class="o">+=</span> <span class="n">pnt</span>
                                <span class="k">break</span>
                        <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;poloidal&#39;</span><span class="p">,</span> <span class="s1">&#39;toroidal&#39;</span><span class="p">,</span> <span class="s1">&#39;parallel&#39;</span><span class="p">,</span> <span class="s1">&#39;_tor&#39;</span><span class="p">,</span> <span class="s1">&#39;_pol&#39;</span><span class="p">,</span> <span class="s1">&#39;_par&#39;</span><span class="p">,</span> <span class="s1">&#39;tor_&#39;</span><span class="p">,</span> <span class="s1">&#39;pol_&#39;</span><span class="p">,</span> <span class="s1">&#39;par_&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">case</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">case</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;conductivity_&#39;</span><span class="p">,</span> <span class="s1">&#39;pressure_&#39;</span><span class="p">,</span> <span class="s1">&#39;rho_&#39;</span><span class="p">,</span> <span class="s1">&#39;length_&#39;</span><span class="p">]]</span>
                            <span class="p">):</span>
                                <span class="n">rationale</span> <span class="o">+=</span> <span class="p">[</span><span class="n">case</span><span class="p">]</span>
                                <span class="n">score</span> <span class="o">+=</span> <span class="n">pnt</span>
                                <span class="k">break</span>
                    <span class="k">if</span> <span class="n">units</span> <span class="ow">in</span> <span class="n">cocos_units</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rationale</span><span class="p">):</span>
                            <span class="n">rationale</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">units</span><span class="p">]</span>
                            <span class="n">score</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">structure</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rationale</span><span class="p">)))</span>

            <span class="c1"># generate output</span>
            <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">structure</span><span class="p">])):</span>
                <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">rationale</span> <span class="ow">in</span> <span class="n">out</span><span class="p">[</span><span class="n">structure</span><span class="p">][</span><span class="n">score</span><span class="p">]:</span>

                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;       &#39;</span>
                    <span class="k">if</span> <span class="n">_cocos_signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;#[ADD?]&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;#[DEL?]&#39;</span>
                    <span class="k">elif</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;#[DEL?]&#39;</span>

                    <span class="n">transform</span> <span class="o">=</span> <span class="n">_cocos_signals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">transform</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span>
                    <span class="n">txt</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_cocos_signals[&#39;</span><span class="si">%s</span><span class="s2">&#39;]=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">transform</span><span class="p">))</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s1">&#39;# </span><span class="si">%f</span><span class="s1"> # </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">rationale</span><span class="p">)</span>
                    <span class="n">text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="ow">or</span> <span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="n">_cocos_signals</span> <span class="ow">and</span> <span class="n">_cocos_signals</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;?&#39;</span><span class="p">):</span>
                        <span class="n">csig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>

            <span class="c1"># print to screen (note that this prints ALL the entries, whereas omas_cocos.py only contains entries that score above a give threshold)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/omas_cocos.py&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
            <span class="c1"># update omas_cocos.py</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">csig</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check that omas_cocos.py file is up-to-date</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">original</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">new</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">csig</span><span class="p">))</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">unified_diff</span><span class="p">(</span><span class="n">original</span><span class="p">,</span> <span class="n">new</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">original</span> <span class="o">==</span> <span class="n">new</span><span class="p">,</span> <span class="s1">&#39;COCOS signals are not up-to-date! Run `make cocos` to update the omas_cocos.py file.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">_structures</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">_structures</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_structures_bkp</span><span class="p">)</span>
        <span class="n">_extra_structures</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">_extra_structures</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_extra_structures_bkp</span><span class="p">)</span>


<span class="c1"># The CocosSignals class is just a dictionary that raises warnings when users access</span>
<span class="c1"># entries that are likely to need a COCOS transformation, but do not have one.</span>
<span class="k">class</span> <span class="nc">CocosSignals</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">`</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">` may require defining its COCOS transform in </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="si">}</span><span class="s1">omas_cocos.py</span>
<span class="s1">Once done, you can reload the cocos definitions with:</span>
<span class="s1">&gt; from omas.omas_physics import cocos_signals; cocos_signals.reload()</span>
<span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">namespace</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">sep</span> <span class="o">+</span> <span class="s1">&#39;omas_cocos.py&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">namespace</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">namespace</span><span class="p">[</span><span class="s1">&#39;_cocos_signals&#39;</span><span class="p">])</span>


<span class="c1"># cocos_signals is the actual dictionary</span>
<span class="n">cocos_signals</span> <span class="o">=</span> <span class="n">CocosSignals</span><span class="p">()</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright 2017-2025 O. Meneghini and collaborators.<br/>
      Last updated on Feb 27, 2025.<br/>
    </p>
  </div>
</footer>
  </body>
</html>